<!DOCTYPE html>
<html>
<!-- This is an automatically generated file.  Do not edit.
   Automatically generated by Pod::Man 4.14 (Pod::Simple 3.42)
  
   Standard preamble:
   ========================================================================
   Vertical space (when we can't use .PP)
 -->
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="../style.css" type="text/css" media="all"/>
  <title>PERLGUTS(1)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">PERLGUTS(1)</td>
    <td class="head-vol">Perl Programmers Reference Guide</td>
    <td class="head-rtitle">PERLGUTS(1)</td>
  </tr>
</table>
<div class="manual-text">
<br/>
<section class="Sh">
<h1 class="Sh" id="NAME"><a class="permalink" href="#NAME">NAME</a></h1>
<p class="Pp">perlguts - Introduction to the Perl API</p>
</section>
<section class="Sh">
<h1 class="Sh" id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">DESCRIPTION</a></h1>
<p class="Pp">This document attempts to describe how to use the Perl API, as
    well as to provide some info on the basic workings of the Perl core. It is
    far from complete and probably contains many errors. Please refer any
    questions or comments to the author below.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="Variables"><a class="permalink" href="#Variables">Variables</a></h1>
<section class="Ss">
<h2 class="Ss" id="Datatypes"><a class="permalink" href="#Datatypes">Datatypes</a></h2>
<p class="Pp">Perl has three typedefs that handle Perl's three main data
  types:</p>
<p class="Pp"></p>
<pre>    SV  Scalar Value
    AV  Array Value
    HV  Hash Value
</pre>
<p class="Pp">Each typedef has specific routines that manipulate the various
    data types.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="What_is_an__"><a class="permalink" href="#What_is_an__">What
  is an &quot;IV&quot;?</a></h2>
<p class="Pp">Perl uses a special typedef IV which is a simple signed integer
    type that is guaranteed to be large enough to hold a pointer (as well as an
    integer). Additionally, there is the UV, which is simply an unsigned IV.</p>
<p class="Pp">Perl also uses several special typedefs to declare variables to
    hold integers of (at least) a given size. Use I8, I16, I32, and I64 to
    declare a signed integer variable which has at least as many bits as the
    number in its name. These all evaluate to the native C type that is closest
    to the given number of bits, but no smaller than that number. For example,
    on many platforms, a <span class="Li">&quot;short&quot;</span> is 16 bits
    long, and if so, I16 will evaluate to a
    <span class="Li">&quot;short&quot;</span>. But on platforms where a
    <span class="Li">&quot;short&quot;</span> isn't exactly 16 bits, Perl will
    use the smallest type that contains 16 bits or more.</p>
<p class="Pp">U8, U16, U32, and U64 are to declare the corresponding unsigned
    integer types.</p>
<p class="Pp">If the platform doesn't support 64-bit integers, both I64 and U64
    will be undefined. Use IV and UV to declare the largest practicable, and
    <span class="Li">&quot;&quot;WIDEST_UTYPE&quot; in perlapi&quot;</span> for
    the absolute maximum unsigned, but which may not be usable in all
    circumstances.</p>
<p class="Pp">A numeric constant can be specified with
    &quot;<span class="Li">&quot;INT16_C&quot;</span>&quot; in perlapi,
    &quot;<span class="Li">&quot;UINTMAX_C&quot;</span>&quot; in perlapi, and
    similar.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Working_with_SVs"><a class="permalink" href="#Working_with_SVs">Working
  with SVs</a></h2>
<p class="Pp">An SV can be created and loaded with one command. There are five
    types of values that can be loaded: an integer value (IV), an unsigned
    integer value (UV), a double (NV), a string (PV), and another scalar (SV).
    (&quot;PV&quot; stands for &quot;Pointer Value&quot;. You might think that
    it is misnamed because it is described as pointing only to strings. However,
    it is possible to have it point to other things. For example, it could point
    to an array of UVs. But, using it for non-strings requires care, as the
    underlying assumption of much of the internals is that PVs are just for
    strings. Often, for example, a trailing
    <span class="Li">&quot;NUL&quot;</span> is tacked on automatically. The
    non-string use is documented only in this paragraph.)</p>
<p class="Pp">The seven routines are:</p>
<p class="Pp"></p>
<pre>    SV*  newSViv(IV);
    SV*  newSVuv(UV);
    SV*  newSVnv(double);
    SV*  newSVpv(const char*, STRLEN);
    SV*  newSVpvn(const char*, STRLEN);
    SV*  newSVpvf(const char*, ...);
    SV*  newSVsv(SV*);
</pre>
<p class="Pp"><span class="Li">&quot;STRLEN&quot;</span> is an integer type
    (<span class="Li">&quot;Size_t&quot;</span>, usually defined as
    <span class="Li">&quot;size_t&quot;</span> in <i>config.h</i>) guaranteed to
    be large enough to represent the size of any string that perl can
  handle.</p>
<p class="Pp">In the unlikely case of a SV requiring more complex
    initialization, you can create an empty SV with newSV(len). If
    <span class="Li">&quot;len&quot;</span> is 0 an empty SV of type NULL is
    returned, else an SV of type PV is returned with len + 1 (for the
    <span class="Li">&quot;NUL&quot;</span>) bytes of storage allocated,
    accessible via SvPVX. In both cases the SV has the undef value.</p>
<p class="Pp"></p>
<pre>    SV *sv = newSV(0);   /* no storage allocated  */
    SV *sv = newSV(10);  /* 10 (+1) bytes of uninitialised storage
                          * allocated */
</pre>
<p class="Pp">To change the value of an <i>already-existing</i> SV, there are
    eight routines:</p>
<p class="Pp"></p>
<pre>    void  sv_setiv(SV*, IV);
    void  sv_setuv(SV*, UV);
    void  sv_setnv(SV*, double);
    void  sv_setpv(SV*, const char*);
    void  sv_setpvn(SV*, const char*, STRLEN)
    void  sv_setpvf(SV*, const char*, ...);
    void  sv_vsetpvfn(SV*, const char*, STRLEN, va_list *,
                                        SV **, Size_t, bool *);
    void  sv_setsv(SV*, SV*);
</pre>
<p class="Pp">Notice that you can choose to specify the length of the string to
    be assigned by using <span class="Li">&quot;sv_setpvn&quot;</span>,
    <span class="Li">&quot;newSVpvn&quot;</span>, or
    <span class="Li">&quot;newSVpv&quot;</span>, or you may allow Perl to
    calculate the length by using <span class="Li">&quot;sv_setpv&quot;</span>
    or by specifying 0 as the second argument to
    <span class="Li">&quot;newSVpv&quot;</span>. Be warned, though, that Perl
    will determine the string's length by using
    <span class="Li">&quot;strlen&quot;</span>, which depends on the string
    terminating with a <span class="Li">&quot;NUL&quot;</span> character, and
    not otherwise containing NULs.</p>
<p class="Pp">The arguments of <span class="Li">&quot;sv_setpvf&quot;</span> are
    processed like <span class="Li">&quot;sprintf&quot;</span>, and the
    formatted output becomes the value.</p>
<p class="Pp"><span class="Li">&quot;sv_vsetpvfn&quot;</span> is an analogue of
    <span class="Li">&quot;vsprintf&quot;</span>, but it allows you to specify
    either a pointer to a variable argument list or the address and length of an
    array of SVs. The last argument points to a boolean; on return, if that
    boolean is true, then locale-specific information has been used to format
    the string, and the string's contents are therefore untrustworthy (see
    perlsec). This pointer may be NULL if that information is not important.
    Note that this function requires you to specify the length of the
  format.</p>
<p class="Pp">The <span class="Li">&quot;sv_set*()&quot;</span> functions are
    not generic enough to operate on values that have &quot;magic&quot;. See
    &quot;Magic Virtual Tables&quot; later in this document.</p>
<p class="Pp">All SVs that contain strings should be terminated with a
    <span class="Li">&quot;NUL&quot;</span> character. If it is not
    <span class="Li">&quot;NUL&quot;</span>-terminated there is a risk of core
    dumps and corruptions from code which passes the string to C functions or
    system calls which expect a
    <span class="Li">&quot;NUL&quot;</span>-terminated string. Perl's own
    functions typically add a trailing <span class="Li">&quot;NUL&quot;</span>
    for this reason. Nevertheless, you should be very careful when you pass a
    string stored in an SV to a C function or system call.</p>
<p class="Pp">To access the actual value that an SV points to, Perl's API
    exposes several macros that coerce the actual scalar type into an IV, UV,
    double, or string:</p>
<ul class="Bl-bullet">
  <li><span class="Li">&quot;SvIV(SV*)&quot;</span>
      (<span class="Li">&quot;IV&quot;</span>) and
      <span class="Li">&quot;SvUV(SV*)&quot;</span>
      (<span class="Li">&quot;UV&quot;</span>)</li>
  <li><span class="Li">&quot;SvNV(SV*)&quot;</span>
      (<span class="Li">&quot;double&quot;</span>)</li>
  <li>Strings are a bit complicated:</li>
</ul>
<div class="Bd-indent">
<ul class="Bl-bullet">
  <li>Byte string: <span class="Li">&quot;SvPVbyte(SV*, STRLEN len)&quot;</span>
      or <span class="Li">&quot;SvPVbyte_nolen(SV*)&quot;</span>
    <p class="Pp">If the Perl string is
        <span class="Li">&quot;\xff\xff&quot;</span>, then this returns a 2-byte
        <span class="Li">&quot;char*&quot;</span>.</p>
    <p class="Pp">This is suitable for Perl strings that represent bytes.</p>
  </li>
  <li>UTF-8 string: <span class="Li">&quot;SvPVutf8(SV*, STRLEN
      len)&quot;</span> or
      <span class="Li">&quot;SvPVutf8_nolen(SV*)&quot;</span>
    <p class="Pp">If the Perl string is
        <span class="Li">&quot;\xff\xff&quot;</span>, then this returns a 4-byte
        <span class="Li">&quot;char*&quot;</span>.</p>
    <p class="Pp">This is suitable for Perl strings that represent
      characters.</p>
    <p class="Pp"><b>CAVEAT</b>: That <span class="Li">&quot;char*&quot;</span>
        will be encoded via Perl's internal UTF-8 variant, which means that if
        the SV contains non-Unicode code points (e.g., 0x110000), then the
        result may contain extensions over valid UTF-8. See
        &quot;is_strict_utf8_string&quot; in perlapi for some methods Perl gives
        you to check the UTF-8 validity of these macros' returns.</p>
  </li>
  <li>You can also use <span class="Li">&quot;SvPV(SV*, STRLEN len)&quot;</span>
      or <span class="Li">&quot;SvPV_nolen(SV*)&quot;</span> to fetch the SV's
      raw internal buffer. This is tricky, though; if your Perl string is
      <span class="Li">&quot;\xff\xff&quot;</span>, then depending on the SV's
      internal encoding you might get back a 2-byte <b>OR</b> a 4-byte
      <span class="Li">&quot;char*&quot;</span>. Moreover, if it's the 4-byte
      string, that could come from either Perl
      <span class="Li">&quot;\xff\xff&quot;</span> stored UTF-8 encoded, or Perl
      <span class="Li">&quot;\xc3\xbf\xc3\xbf&quot;</span> stored as raw octets.
      To differentiate between these you <b>MUST</b> look up the SV's UTF8 bit
      (cf. <span class="Li">&quot;SvUTF8&quot;</span>) to know whether the
      source Perl string is 2 characters
      (<span class="Li">&quot;SvUTF8&quot;</span> would be on) or 4 characters
      (<span class="Li">&quot;SvUTF8&quot;</span> would be off).
    <p class="Pp"><b>IMPORTANT:</b> Use of
        <span class="Li">&quot;SvPV&quot;</span>,
        <span class="Li">&quot;SvPV_nolen&quot;</span>, or similarly-named
        macros <i>without</i> looking up the SV's UTF8 bit is almost certainly a
        bug if non-ASCII input is allowed.</p>
    <p class="Pp">When the UTF8 bit is on, the same <b>CAVEAT</b> about UTF-8
        validity applies here as for
        <span class="Li">&quot;SvPVutf8&quot;</span>.</p>
  </li>
</ul>
</div>
<div class="Bd-indent">
<p class="Pp">(See &quot;How do I pass a Perl string to a C library?&quot; for
    more details.)</p>
<p class="Pp">In <span class="Li">&quot;SvPVbyte&quot;</span>,
    <span class="Li">&quot;SvPVutf8&quot;</span>, and
    <span class="Li">&quot;SvPV&quot;</span>, the length of the
    <span class="Li">&quot;char*&quot;</span> returned is placed into the
    variable <span class="Li">&quot;len&quot;</span> (these are macros, so you
    do <i>not</i> use <span class="Li">&amp;len</span>). If you do not care what
    the length of the data is, use
    <span class="Li">&quot;SvPVbyte_nolen&quot;</span>,
    <span class="Li">&quot;SvPVutf8_nolen&quot;</span>, or
    <span class="Li">&quot;SvPV_nolen&quot;</span> instead. The global variable
    <span class="Li">&quot;PL_na&quot;</span> can also be given to
    <span class="Li">&quot;SvPVbyte&quot;</span>/<span class="Li">&quot;SvPVutf8&quot;</span>/<span class="Li">&quot;SvPV&quot;</span>
    in this case. But that can be quite inefficient because
    <span class="Li">&quot;PL_na&quot;</span> must be accessed in thread-local
    storage in threaded Perl. In any case, remember that Perl allows arbitrary
    strings of data that may both contain NULs and might not be terminated by a
    <span class="Li">&quot;NUL&quot;</span>.</p>
<p class="Pp">Also remember that C doesn't allow you to safely say
    <span class="Li">&quot;foo(SvPVbyte(s, len),</span>
    <span class="Li">len);&quot;</span>. It might work with your compiler, but
    it won't work for everyone. Break this sort of statement up into separate
    assignments:</p>
<p class="Pp"></p>
<pre>    SV *s;
    STRLEN len;
    char *ptr;
    ptr = SvPVbyte(s, len);
    foo(ptr, len);
</pre>
</div>
<p class="Pp">If you want to know if the scalar value is TRUE, you can use:</p>
<p class="Pp"></p>
<pre>    SvTRUE(SV*)
</pre>
<p class="Pp">Although Perl will automatically grow strings for you, if you need
    to force Perl to allocate more memory for your SV, you can use the macro</p>
<p class="Pp"></p>
<pre>    SvGROW(SV*, STRLEN newlen)
</pre>
<p class="Pp">which will determine if more memory needs to be allocated. If so,
    it will call the function <span class="Li">&quot;sv_grow&quot;</span>. Note
    that <span class="Li">&quot;SvGROW&quot;</span> can only increase, not
    decrease, the allocated memory of an SV and that it does not automatically
    add space for the trailing <span class="Li">&quot;NUL&quot;</span> byte
    (perl's own string functions typically do <span class="Li">&quot;SvGROW(sv,
    len + 1)&quot;</span>).</p>
<p class="Pp">If you want to write to an existing SV's buffer and set its value
    to a string, use <b>SvPVbyte_force()</b> or one of its variants to force the
    SV to be a PV. This will remove any of various types of non-stringness from
    the SV while preserving the content of the SV in the PV. This can be used,
    for example, to append data from an API function to a buffer without extra
    copying:</p>
<p class="Pp"></p>
<pre>    (void)SvPVbyte_force(sv, len);
    s = SvGROW(sv, len + needlen + 1);
    /* something that modifies up to needlen bytes at s+len, but
       modifies newlen bytes
         eg. newlen = read(fd, s + len, needlen);
       ignoring errors for these examples
     */
    s[len + newlen] = '\0';
    SvCUR_set(sv, len + newlen);
    SvUTF8_off(sv);
    SvSETMAGIC(sv);
</pre>
<p class="Pp">If you already have the data in memory or if you want to keep your
    code simple, you can use one of the sv_cat*() variants, such as
    <b>sv_catpvn()</b>. If you want to insert anywhere in the string you can use
    <b>sv_insert()</b> or <b>sv_insert_flags()</b>.</p>
<p class="Pp">If you don't need the existing content of the SV, you can avoid
    some copying with:</p>
<p class="Pp"></p>
<pre>    SvPVCLEAR(sv);
    s = SvGROW(sv, needlen + 1);
    /* something that modifies up to needlen bytes at s, but modifies
       newlen bytes
         eg. newlen = read(fd, s, needlen);
     */
    s[newlen] = '\0';
    SvCUR_set(sv, newlen);
    SvPOK_only(sv); /* also clears SVf_UTF8 */
    SvSETMAGIC(sv);
</pre>
<p class="Pp">Again, if you already have the data in memory or want to avoid the
    complexity of the above, you can use <b>sv_setpvn()</b>.</p>
<p class="Pp">If you have a buffer allocated with <b>Newx()</b> and want to set
    that as the SV's value, you can use <b>sv_usepvn_flags()</b>. That has some
    requirements if you want to avoid perl re-allocating the buffer to fit the
    trailing NUL:</p>
<p class="Pp"></p>
<pre>   Newx(buf, somesize+1, char);
   /* ... fill in buf ... */
   buf[somesize] = '\0';
   sv_usepvn_flags(sv, buf, somesize, SV_SMAGIC | SV_HAS_TRAILING_NUL);
   /* buf now belongs to perl, don't release it */
</pre>
<p class="Pp">If you have an SV and want to know what kind of data Perl thinks
    is stored in it, you can use the following macros to check the type of SV
    you have.</p>
<p class="Pp"></p>
<pre>    SvIOK(SV*)
    SvNOK(SV*)
    SvPOK(SV*)
</pre>
<p class="Pp">You can get and set the current length of the string stored in an
    SV with the following macros:</p>
<p class="Pp"></p>
<pre>    SvCUR(SV*)
    SvCUR_set(SV*, I32 val)
</pre>
<p class="Pp">You can also get a pointer to the end of the string stored in the
    SV with the macro:</p>
<p class="Pp"></p>
<pre>    SvEND(SV*)
</pre>
<p class="Pp">But note that these last three macros are valid only if
    <span class="Li">&quot;SvPOK()&quot;</span> is true.</p>
<p class="Pp">If you want to append something to the end of string stored in an
    <span class="Li">&quot;SV*&quot;</span>, you can use the following
    functions:</p>
<p class="Pp"></p>
<pre>    void  sv_catpv(SV*, const char*);
    void  sv_catpvn(SV*, const char*, STRLEN);
    void  sv_catpvf(SV*, const char*, ...);
    void  sv_vcatpvfn(SV*, const char*, STRLEN, va_list *, SV **,
                                                             I32, bool);
    void  sv_catsv(SV*, SV*);
</pre>
<p class="Pp">The first function calculates the length of the string to be
    appended by using <span class="Li">&quot;strlen&quot;</span>. In the second,
    you specify the length of the string yourself. The third function processes
    its arguments like <span class="Li">&quot;sprintf&quot;</span> and appends
    the formatted output. The fourth function works like
    <span class="Li">&quot;vsprintf&quot;</span>. You can specify the address
    and length of an array of SVs instead of the va_list argument. The fifth
    function extends the string stored in the first SV with the string stored in
    the second SV. It also forces the second SV to be interpreted as a
  string.</p>
<p class="Pp">The <span class="Li">&quot;sv_cat*()&quot;</span> functions are
    not generic enough to operate on values that have &quot;magic&quot;. See
    &quot;Magic Virtual Tables&quot; later in this document.</p>
<p class="Pp">If you know the name of a scalar variable, you can get a pointer
    to its SV by using the following:</p>
<p class="Pp"></p>
<pre>    SV*  get_sv(&quot;package::varname&quot;, 0);
</pre>
<p class="Pp">This returns NULL if the variable does not exist.</p>
<p class="Pp">If you want to know if this variable (or any other SV) is actually
    <span class="Li">&quot;defined&quot;</span>, you can call:</p>
<p class="Pp"></p>
<pre>    SvOK(SV*)
</pre>
<p class="Pp">The scalar <span class="Li">&quot;undef&quot;</span> value is
    stored in an SV instance called
    <span class="Li">&quot;PL_sv_undef&quot;</span>.</p>
<p class="Pp">Its address can be used whenever an
    <span class="Li">&quot;SV*&quot;</span> is needed. Make sure that you don't
    try to compare a random sv with <span class="Li">&amp;PL_sv_undef</span>.
    For example when interfacing Perl code, it'll work correctly for:</p>
<p class="Pp"></p>
<pre>  foo(undef);
</pre>
<p class="Pp">But won't work when called as:</p>
<p class="Pp"></p>
<pre>  $x = undef;
  foo($x);
</pre>
<p class="Pp">So to repeat always use <b>SvOK()</b> to check whether an sv is
    defined.</p>
<p class="Pp">Also you have to be careful when using
    <span class="Li">&amp;PL_sv_undef</span> as a value in AVs or HVs (see
    &quot;AVs, HVs and undefined values&quot;).</p>
<p class="Pp">There are also the two values
    <span class="Li">&quot;PL_sv_yes&quot;</span> and
    <span class="Li">&quot;PL_sv_no&quot;</span>, which contain boolean TRUE and
    FALSE values, respectively. Like
    <span class="Li">&quot;PL_sv_undef&quot;</span>, their addresses can be used
    whenever an <span class="Li">&quot;SV*&quot;</span> is needed.</p>
<p class="Pp">Do not be fooled into thinking that <span class="Li">&quot;(SV *)
    0&quot;</span> is the same as <span class="Li">&amp;PL_sv_undef</span>. Take
    this code:</p>
<p class="Pp"></p>
<pre>    SV* sv = (SV*) 0;
    if (I-am-to-return-a-real-value) {
            sv = sv_2mortal(newSViv(42));
    }
    sv_setsv(ST(0), sv);
</pre>
<p class="Pp">This code tries to return a new SV (which contains the value 42)
    if it should return a real value, or undef otherwise. Instead it has
    returned a NULL pointer which, somewhere down the line, will cause a
    segmentation violation, bus error, or just weird results. Change the zero to
    <span class="Li">&amp;PL_sv_undef</span> in the first line and all will be
    well.</p>
<p class="Pp">To free an SV that you've created, call
    <span class="Li">&quot;SvREFCNT_dec(SV*)&quot;</span>. Normally this call is
    not necessary (see &quot;Reference Counts and Mortality&quot;).</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Offsets"><a class="permalink" href="#Offsets">Offsets</a></h2>
<p class="Pp">Perl provides the function
    <span class="Li">&quot;sv_chop&quot;</span> to efficiently remove characters
    from the beginning of a string; you give it an SV and a pointer to somewhere
    inside the PV, and it discards everything before the pointer. The efficiency
    comes by means of a little hack: instead of actually removing the
    characters, <span class="Li">&quot;sv_chop&quot;</span> sets the flag
    <span class="Li">&quot;OOK&quot;</span> (offset OK) to signal to other
    functions that the offset hack is in effect, and it moves the PV pointer
    (called <span class="Li">&quot;SvPVX&quot;</span>) forward by the number of
    bytes chopped off, and adjusts <span class="Li">&quot;SvCUR&quot;</span> and
    <span class="Li">&quot;SvLEN&quot;</span> accordingly. (A portion of the
    space between the old and new PV pointers is used to store the count of
    chopped bytes.)</p>
<p class="Pp">Hence, at this point, the start of the buffer that we allocated
    lives at <span class="Li">&quot;SvPVX(sv) - SvIV(sv)&quot;</span> in memory
    and the PV pointer is pointing into the middle of this allocated
  storage.</p>
<p class="Pp">This is best demonstrated by example. Normally copy-on-write will
    prevent the substitution from operator from using this hack, but if you can
    craft a string for which copy-on-write is not possible, you can see it in
    play. In the current implementation, the final byte of a string buffer is
    used as a copy-on-write reference count. If the buffer is not big enough,
    then copy-on-write is skipped. First have a look at an empty string:</p>
<p class="Pp"></p>
<pre>  % ./perl -Ilib -MDevel::Peek -le '$a=&quot;&quot;; $a .= &quot;&quot;; Dump $a'
  SV = PV(0x7ffb7c008a70) at 0x7ffb7c030390
    REFCNT = 1
    FLAGS = (POK,pPOK)
    PV = 0x7ffb7bc05b50 &quot;&quot;\0
    CUR = 0
    LEN = 10
</pre>
<p class="Pp">Notice here the LEN is 10. (It may differ on your platform.)
    Extend the length of the string to one less than 10, and do a
  substitution:</p>
<p class="Pp"></p>
<pre> % ./perl -Ilib -MDevel::Peek -le '$a=&quot;&quot;; $a.=&quot;123456789&quot;; $a=~s/.//; \
                                                            Dump($a)'
 SV = PV(0x7ffa04008a70) at 0x7ffa04030390
   REFCNT = 1
   FLAGS = (POK,OOK,pPOK)
   OFFSET = 1
   PV = 0x7ffa03c05b61 ( &quot;\1&quot; . ) &quot;23456789&quot;\0
   CUR = 8
   LEN = 9
</pre>
<p class="Pp">Here the number of bytes chopped off (1) is shown next as the
    OFFSET. The portion of the string between the &quot;real&quot; and the
    &quot;fake&quot; beginnings is shown in parentheses, and the values of
    <span class="Li">&quot;SvCUR&quot;</span> and
    <span class="Li">&quot;SvLEN&quot;</span> reflect the fake beginning, not
    the real one. (The first character of the string buffer happens to have
    changed to &quot;\1&quot; here, not &quot;1&quot;, because the current
    implementation stores the offset count in the string buffer. This is subject
    to change.)</p>
<p class="Pp">Something similar to the offset hack is performed on AVs to enable
    efficient shifting and splicing off the beginning of the array; while
    <span class="Li">&quot;AvARRAY&quot;</span> points to the first element in
    the array that is visible from Perl,
    <span class="Li">&quot;AvALLOC&quot;</span> points to the real start of the
    C array. These are usually the same, but a
    <span class="Li">&quot;shift&quot;</span> operation can be carried out by
    increasing <span class="Li">&quot;AvARRAY&quot;</span> by one and decreasing
    <span class="Li">&quot;AvFILL&quot;</span> and
    <span class="Li">&quot;AvMAX&quot;</span>. Again, the location of the real
    start of the C array only comes into play when freeing the array. See
    <span class="Li">&quot;av_shift&quot;</span> in <i>av.c</i>.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="What's_Really_Stored_in_an_"><a class="permalink" href="#What's_Really_Stored_in_an_">What's
  Really Stored in an SV?</a></h2>
<p class="Pp">Recall that the usual method of determining the type of scalar you
    have is to use <span class="Li">&quot;Sv*OK&quot;</span> macros. Because a
    scalar can be both a number and a string, usually these macros will always
    return TRUE and calling the <span class="Li">&quot;Sv*V&quot;</span> macros
    will do the appropriate conversion of string to integer/double or
    integer/double to string.</p>
<p class="Pp">If you <i>really</i> need to know if you have an integer, double,
    or string pointer in an SV, you can use the following three macros
  instead:</p>
<p class="Pp"></p>
<pre>    SvIOKp(SV*)
    SvNOKp(SV*)
    SvPOKp(SV*)
</pre>
<p class="Pp">These will tell you if you truly have an integer, double, or
    string pointer stored in your SV. The &quot;p&quot; stands for private.</p>
<p class="Pp">There are various ways in which the private and public flags may
    differ. For example, in perl 5.16 and earlier a tied SV may have a valid
    underlying value in the IV slot (so SvIOKp is true), but the data should be
    accessed via the FETCH routine rather than directly, so SvIOK is false. (In
    perl 5.18 onwards, tied scalars use the flags the same way as untied
    scalars.) Another is when numeric conversion has occurred and precision has
    been lost: only the private flag is set on 'lossy' values. So when an NV is
    converted to an IV with loss, SvIOKp, SvNOKp and SvNOK will be set, while
    SvIOK wont be.</p>
<p class="Pp">In general, though, it's best to use the
    <span class="Li">&quot;Sv*V&quot;</span> macros.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Working_with_AVs"><a class="permalink" href="#Working_with_AVs">Working
  with AVs</a></h2>
<p class="Pp">There are two ways to create and load an AV. The first method
    creates an empty AV:</p>
<p class="Pp"></p>
<pre>    AV*  newAV();
</pre>
<p class="Pp">The second method both creates the AV and initially populates it
    with SVs:</p>
<p class="Pp"></p>
<pre>    AV*  av_make(SSize_t num, SV **ptr);
</pre>
<p class="Pp">The second argument points to an array containing
    <span class="Li">&quot;num&quot;</span>
    <span class="Li">&quot;SV*&quot;</span>'s. Once the AV has been created, the
    SVs can be destroyed, if so desired.</p>
<p class="Pp">Once the AV has been created, the following operations are
    possible on it:</p>
<p class="Pp"></p>
<pre>    void  av_push(AV*, SV*);
    SV*   av_pop(AV*);
    SV*   av_shift(AV*);
    void  av_unshift(AV*, SSize_t num);
</pre>
<p class="Pp">These should be familiar operations, with the exception of
    <span class="Li">&quot;av_unshift&quot;</span>. This routine adds
    <span class="Li">&quot;num&quot;</span> elements at the front of the array
    with the <span class="Li">&quot;undef&quot;</span> value. You must then use
    <span class="Li">&quot;av_store&quot;</span> (described below) to assign
    values to these new elements.</p>
<p class="Pp">Here are some other functions:</p>
<p class="Pp"></p>
<pre>    SSize_t av_top_index(AV*);
    SV**    av_fetch(AV*, SSize_t key, I32 lval);
    SV**    av_store(AV*, SSize_t key, SV* val);
</pre>
<p class="Pp">The <span class="Li">&quot;av_top_index&quot;</span> function
    returns the highest index value in an array (just like $#array in Perl). If
    the array is empty, -1 is returned. The
    <span class="Li">&quot;av_fetch&quot;</span> function returns the value at
    index <span class="Li">&quot;key&quot;</span>, but if
    <span class="Li">&quot;lval&quot;</span> is non-zero, then
    <span class="Li">&quot;av_fetch&quot;</span> will store an undef value at
    that index. The <span class="Li">&quot;av_store&quot;</span> function stores
    the value <span class="Li">&quot;val&quot;</span> at index
    <span class="Li">&quot;key&quot;</span>, and does not increment the
    reference count of <span class="Li">&quot;val&quot;</span>. Thus the caller
    is responsible for taking care of that, and if
    <span class="Li">&quot;av_store&quot;</span> returns NULL, the caller will
    have to decrement the reference count to avoid a memory leak. Note that
    <span class="Li">&quot;av_fetch&quot;</span> and
    <span class="Li">&quot;av_store&quot;</span> both return
    <span class="Li">&quot;SV**&quot;</span>'s, not
    <span class="Li">&quot;SV*&quot;</span>'s as their return value.</p>
<p class="Pp">A few more:</p>
<p class="Pp"></p>
<pre>    void  av_clear(AV*);
    void  av_undef(AV*);
    void  av_extend(AV*, SSize_t key);
</pre>
<p class="Pp">The <span class="Li">&quot;av_clear&quot;</span> function deletes
    all the elements in the AV* array, but does not actually delete the array
    itself. The <span class="Li">&quot;av_undef&quot;</span> function will
    delete all the elements in the array plus the array itself. The
    <span class="Li">&quot;av_extend&quot;</span> function extends the array so
    that it contains at least <span class="Li">&quot;key+1&quot;</span>
    elements. If <span class="Li">&quot;key+1&quot;</span> is less than the
    currently allocated length of the array, then nothing is done.</p>
<p class="Pp">If you know the name of an array variable, you can get a pointer
    to its AV by using the following:</p>
<p class="Pp"></p>
<pre>    AV*  get_av(&quot;package::varname&quot;, 0);
</pre>
<p class="Pp">This returns NULL if the variable does not exist.</p>
<p class="Pp">See &quot;Understanding the Magic of Tied Hashes and Arrays&quot;
    for more information on how to use the array access functions on tied
    arrays.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Working_with_HVs"><a class="permalink" href="#Working_with_HVs">Working
  with HVs</a></h2>
<p class="Pp">To create an HV, you use the following routine:</p>
<p class="Pp"></p>
<pre>    HV*  newHV();
</pre>
<p class="Pp">Once the HV has been created, the following operations are
    possible on it:</p>
<p class="Pp"></p>
<pre>    SV**  hv_store(HV*, const char* key, U32 klen, SV* val, U32 hash);
    SV**  hv_fetch(HV*, const char* key, U32 klen, I32 lval);
</pre>
<p class="Pp">The <span class="Li">&quot;klen&quot;</span> parameter is the
    length of the key being passed in (Note that you cannot pass 0 in as a value
    of <span class="Li">&quot;klen&quot;</span> to tell Perl to measure the
    length of the key). The <span class="Li">&quot;val&quot;</span> argument
    contains the SV pointer to the scalar being stored, and
    <span class="Li">&quot;hash&quot;</span> is the precomputed hash value (zero
    if you want <span class="Li">&quot;hv_store&quot;</span> to calculate it for
    you). The <span class="Li">&quot;lval&quot;</span> parameter indicates
    whether this fetch is actually a part of a store operation, in which case a
    new undefined value will be added to the HV with the supplied key and
    <span class="Li">&quot;hv_fetch&quot;</span> will return as if the value had
    already existed.</p>
<p class="Pp">Remember that <span class="Li">&quot;hv_store&quot;</span> and
    <span class="Li">&quot;hv_fetch&quot;</span> return
    <span class="Li">&quot;SV**&quot;</span>'s and not just
    <span class="Li">&quot;SV*&quot;</span>. To access the scalar value, you
    must first dereference the return value. However, you should check to make
    sure that the return value is not NULL before dereferencing it.</p>
<p class="Pp">The first of these two functions checks if a hash table entry
    exists, and the second deletes it.</p>
<p class="Pp"></p>
<pre>    bool  hv_exists(HV*, const char* key, U32 klen);
    SV*   hv_delete(HV*, const char* key, U32 klen, I32 flags);
</pre>
<p class="Pp">If <span class="Li">&quot;flags&quot;</span> does not include the
    <span class="Li">&quot;G_DISCARD&quot;</span> flag then
    <span class="Li">&quot;hv_delete&quot;</span> will create and return a
    mortal copy of the deleted value.</p>
<p class="Pp">And more miscellaneous functions:</p>
<p class="Pp"></p>
<pre>    void   hv_clear(HV*);
    void   hv_undef(HV*);
</pre>
<p class="Pp">Like their AV counterparts,
    <span class="Li">&quot;hv_clear&quot;</span> deletes all the entries in the
    hash table but does not actually delete the hash table. The
    <span class="Li">&quot;hv_undef&quot;</span> deletes both the entries and
    the hash table itself.</p>
<p class="Pp">Perl keeps the actual data in a linked list of structures with a
    typedef of HE. These contain the actual key and value pointers (plus extra
    administrative overhead). The key is a string pointer; the value is an
    <span class="Li">&quot;SV*&quot;</span>. However, once you have an
    <span class="Li">&quot;HE*&quot;</span>, to get the actual key and value,
    use the routines specified below.</p>
<p class="Pp"></p>
<pre>    I32    hv_iterinit(HV*);
            /* Prepares starting point to traverse hash table */
    HE*    hv_iternext(HV*);
            /* Get the next entry, and return a pointer to a
               structure that has both the key and value */
    char*  hv_iterkey(HE* entry, I32* retlen);
            /* Get the key from an HE structure and also return
               the length of the key string */
    SV*    hv_iterval(HV*, HE* entry);
            /* Return an SV pointer to the value of the HE
               structure */
    SV*    hv_iternextsv(HV*, char** key, I32* retlen);
            /* This convenience routine combines hv_iternext,
               hv_iterkey, and hv_iterval.  The key and retlen
               arguments are return values for the key and its
               length.  The value is returned in the SV* argument */
</pre>
<p class="Pp">If you know the name of a hash variable, you can get a pointer to
    its HV by using the following:</p>
<p class="Pp"></p>
<pre>    HV*  get_hv(&quot;package::varname&quot;, 0);
</pre>
<p class="Pp">This returns NULL if the variable does not exist.</p>
<p class="Pp">The hash algorithm is defined in the
    <span class="Li">&quot;PERL_HASH&quot;</span> macro:</p>
<p class="Pp"></p>
<pre>    PERL_HASH(hash, key, klen)
</pre>
<p class="Pp">The exact implementation of this macro varies by architecture and
    version of perl, and the return value may change per invocation, so the
    value is only valid for the duration of a single perl process.</p>
<p class="Pp">See &quot;Understanding the Magic of Tied Hashes and Arrays&quot;
    for more information on how to use the hash access functions on tied
  hashes.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Hash_"><a class="permalink" href="#Hash_">Hash API
  Extensions</a></h2>
<p class="Pp">Beginning with version 5.004, the following functions are also
    supported:</p>
<p class="Pp"></p>
<pre>    HE*     hv_fetch_ent  (HV* tb, SV* key, I32 lval, U32 hash);
    HE*     hv_store_ent  (HV* tb, SV* key, SV* val, U32 hash);
    bool    hv_exists_ent (HV* tb, SV* key, U32 hash);
    SV*     hv_delete_ent (HV* tb, SV* key, I32 flags, U32 hash);
    SV*     hv_iterkeysv  (HE* entry);
</pre>
<p class="Pp">Note that these functions take
    <span class="Li">&quot;SV*&quot;</span> keys, which simplifies writing of
    extension code that deals with hash structures. These functions also allow
    passing of <span class="Li">&quot;SV*&quot;</span> keys to
    <span class="Li">&quot;tie&quot;</span> functions without forcing you to
    stringify the keys (unlike the previous set of functions).</p>
<p class="Pp">They also return and accept whole hash entries
    (<span class="Li">&quot;HE*&quot;</span>), making their use more efficient
    (since the hash number for a particular string doesn't have to be recomputed
    every time). See perlapi for detailed descriptions.</p>
<p class="Pp">The following macros must always be used to access the contents of
    hash entries. Note that the arguments to these macros must be simple
    variables, since they may get evaluated more than once. See perlapi for
    detailed descriptions of these macros.</p>
<p class="Pp"></p>
<pre>    HePV(HE* he, STRLEN len)
    HeVAL(HE* he)
    HeHASH(HE* he)
    HeSVKEY(HE* he)
    HeSVKEY_force(HE* he)
    HeSVKEY_set(HE* he, SV* sv)
</pre>
<p class="Pp">These two lower level macros are defined, but must only be used
    when dealing with keys that are not
    <span class="Li">&quot;SV*&quot;</span>s:</p>
<p class="Pp"></p>
<pre>    HeKEY(HE* he)
    HeKLEN(HE* he)
</pre>
<p class="Pp">Note that both <span class="Li">&quot;hv_store&quot;</span> and
    <span class="Li">&quot;hv_store_ent&quot;</span> do not increment the
    reference count of the stored <span class="Li">&quot;val&quot;</span>, which
    is the caller's responsibility. If these functions return a NULL value, the
    caller will usually have to decrement the reference count of
    <span class="Li">&quot;val&quot;</span> to avoid a memory leak.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="AVs,_HVs_and_undefined_values"><a class="permalink" href="#AVs,_HVs_and_undefined_values">AVs,
  HVs and undefined values</a></h2>
<p class="Pp">Sometimes you have to store undefined values in AVs or HVs.
    Although this may be a rare case, it can be tricky. That's because you're
    used to using <span class="Li">&amp;PL_sv_undef</span> if you need an
    undefined SV.</p>
<p class="Pp">For example, intuition tells you that this XS code:</p>
<p class="Pp"></p>
<pre>    AV *av = newAV();
    av_store( av, 0, &amp;PL_sv_undef );
</pre>
<p class="Pp">is equivalent to this Perl code:</p>
<p class="Pp"></p>
<pre>    my @av;
    $av[0] = undef;
</pre>
<p class="Pp">Unfortunately, this isn't true. In perl 5.18 and earlier, AVs use
    <span class="Li">&amp;PL_sv_undef</span> as a marker for indicating that an
    array element has not yet been initialized. Thus,
    <span class="Li">&quot;exists $av[0]&quot;</span> would be true for the
    above Perl code, but false for the array generated by the XS code. In perl
    5.20, storing &amp;PL_sv_undef will create a read-only element, because the
    scalar &amp;PL_sv_undef itself is stored, not a copy.</p>
<p class="Pp">Similar problems can occur when storing
    <span class="Li">&amp;PL_sv_undef</span> in HVs:</p>
<p class="Pp"></p>
<pre>    hv_store( hv, &quot;key&quot;, 3, &amp;PL_sv_undef, 0 );
</pre>
<p class="Pp">This will indeed make the value
    <span class="Li">&quot;undef&quot;</span>, but if you try to modify the
    value of <span class="Li">&quot;key&quot;</span>, you'll get the following
    error:</p>
<p class="Pp"></p>
<pre>    Modification of non-creatable hash value attempted
</pre>
<p class="Pp">In perl 5.8.0, <span class="Li">&amp;PL_sv_undef</span> was also
    used to mark placeholders in restricted hashes. This caused such hash
    entries not to appear when iterating over the hash or when checking for the
    keys with the <span class="Li">&quot;hv_exists&quot;</span> function.</p>
<p class="Pp">You can run into similar problems when you store
    <span class="Li">&amp;PL_sv_yes</span> or
    <span class="Li">&amp;PL_sv_no</span> into AVs or HVs. Trying to modify such
    elements will give you the following error:</p>
<p class="Pp"></p>
<pre>    Modification of a read-only value attempted
</pre>
<p class="Pp">To make a long story short, you can use the special variables
    <span class="Li">&amp;PL_sv_undef</span>,
    <span class="Li">&amp;PL_sv_yes</span> and
    <span class="Li">&amp;PL_sv_no</span> with AVs and HVs, but you have to make
    sure you know what you're doing.</p>
<p class="Pp">Generally, if you want to store an undefined value in an AV or HV,
    you should not use <span class="Li">&amp;PL_sv_undef</span>, but rather
    create a new undefined value using the
    <span class="Li">&quot;newSV&quot;</span> function, for example:</p>
<p class="Pp"></p>
<pre>    av_store( av, 42, newSV(0) );
    hv_store( hv, &quot;foo&quot;, 3, newSV(0), 0 );
</pre>
</section>
<section class="Ss">
<h2 class="Ss" id="References"><a class="permalink" href="#References">References</a></h2>
<p class="Pp">References are a special type of scalar that point to other data
    types (including other references).</p>
<p class="Pp">To create a reference, use either of the following functions:</p>
<p class="Pp"></p>
<pre>    SV* newRV_inc((SV*) thing);
    SV* newRV_noinc((SV*) thing);
</pre>
<p class="Pp">The <span class="Li">&quot;thing&quot;</span> argument can be any
    of an <span class="Li">&quot;SV*&quot;</span>,
    <span class="Li">&quot;AV*&quot;</span>, or
    <span class="Li">&quot;HV*&quot;</span>. The functions are identical except
    that <span class="Li">&quot;newRV_inc&quot;</span> increments the reference
    count of the <span class="Li">&quot;thing&quot;</span>, while
    <span class="Li">&quot;newRV_noinc&quot;</span> does not. For historical
    reasons, <span class="Li">&quot;newRV&quot;</span> is a synonym for
    <span class="Li">&quot;newRV_inc&quot;</span>.</p>
<p class="Pp">Once you have a reference, you can use the following macro to
    dereference the reference:</p>
<p class="Pp"></p>
<pre>    SvRV(SV*)
</pre>
<p class="Pp">then call the appropriate routines, casting the returned
    <span class="Li">&quot;SV*&quot;</span> to either an
    <span class="Li">&quot;AV*&quot;</span> or
    <span class="Li">&quot;HV*&quot;</span>, if required.</p>
<p class="Pp">To determine if an SV is a reference, you can use the following
    macro:</p>
<p class="Pp"></p>
<pre>    SvROK(SV*)
</pre>
<p class="Pp">To discover what type of value the reference refers to, use the
    following macro and then check the return value.</p>
<p class="Pp"></p>
<pre>    SvTYPE(SvRV(SV*))
</pre>
<p class="Pp">The most useful types that will be returned are:</p>
<p class="Pp"></p>
<pre>    SVt_PVAV    Array
    SVt_PVHV    Hash
    SVt_PVCV    Code
    SVt_PVGV    Glob (possibly a file handle)
</pre>
<p class="Pp">Any numerical value returned which is less than SVt_PVAV will be a
    scalar of some form.</p>
<p class="Pp">See &quot;svtype&quot; in perlapi for more details.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Blessed_References_and_Class_Objects"><a class="permalink" href="#Blessed_References_and_Class_Objects">Blessed
  References and Class Objects</a></h2>
<p class="Pp">References are also used to support object-oriented programming.
    In perl's OO lexicon, an object is simply a reference that has been blessed
    into a package (or class). Once blessed, the programmer may now use the
    reference to access the various methods in the class.</p>
<p class="Pp">A reference can be blessed into a package with the following
    function:</p>
<p class="Pp"></p>
<pre>    SV* sv_bless(SV* sv, HV* stash);
</pre>
<p class="Pp">The <span class="Li">&quot;sv&quot;</span> argument must be a
    reference value. The <span class="Li">&quot;stash&quot;</span> argument
    specifies which class the reference will belong to. See &quot;Stashes and
    Globs&quot; for information on converting class names into stashes.</p>
<p class="Pp">/* Still under construction */</p>
<p class="Pp">The following function upgrades rv to reference if not already
    one. Creates a new SV for rv to point to. If
    <span class="Li">&quot;classname&quot;</span> is non-null, the SV is blessed
    into the specified class. SV is returned.</p>
<p class="Pp"></p>
<pre>        SV* newSVrv(SV* rv, const char* classname);
</pre>
<p class="Pp">The following three functions copy integer, unsigned integer or
    double into an SV whose reference is <span class="Li">&quot;rv&quot;</span>.
    SV is blessed if <span class="Li">&quot;classname&quot;</span> is
  non-null.</p>
<p class="Pp"></p>
<pre>        SV* sv_setref_iv(SV* rv, const char* classname, IV iv);
        SV* sv_setref_uv(SV* rv, const char* classname, UV uv);
        SV* sv_setref_nv(SV* rv, const char* classname, NV iv);
</pre>
<p class="Pp">The following function copies the pointer value (<i>the address,
    not the</i> <i>string!</i>) into an SV whose reference is rv. SV is blessed
    if <span class="Li">&quot;classname&quot;</span> is non-null.</p>
<p class="Pp"></p>
<pre>        SV* sv_setref_pv(SV* rv, const char* classname, void* pv);
</pre>
<p class="Pp">The following function copies a string into an SV whose reference
    is <span class="Li">&quot;rv&quot;</span>. Set length to 0 to let Perl
    calculate the string length. SV is blessed if
    <span class="Li">&quot;classname&quot;</span> is non-null.</p>
<p class="Pp"></p>
<pre>    SV* sv_setref_pvn(SV* rv, const char* classname, char* pv,
                                                         STRLEN length);
</pre>
<p class="Pp">The following function tests whether the SV is blessed into the
    specified class. It does not check inheritance relationships.</p>
<p class="Pp"></p>
<pre>        int  sv_isa(SV* sv, const char* name);
</pre>
<p class="Pp">The following function tests whether the SV is a reference to a
    blessed object.</p>
<p class="Pp"></p>
<pre>        int  sv_isobject(SV* sv);
</pre>
<p class="Pp">The following function tests whether the SV is derived from the
    specified class. SV can be either a reference to a blessed object or a
    string containing a class name. This is the function implementing the
    <span class="Li">&quot;UNIVERSAL::isa&quot;</span> functionality.</p>
<p class="Pp"></p>
<pre>        bool sv_derived_from(SV* sv, const char* name);
</pre>
<p class="Pp">To check if you've got an object derived from a specific class you
    have to write:</p>
<p class="Pp"></p>
<pre>        if (sv_isobject(sv) &amp;&amp; sv_derived_from(sv, class)) { ... }
</pre>
</section>
<section class="Ss">
<h2 class="Ss" id="Creating_New_Variables"><a class="permalink" href="#Creating_New_Variables">Creating
  New Variables</a></h2>
<p class="Pp">To create a new Perl variable with an undef value which can be
    accessed from your Perl script, use the following routines, depending on the
    variable type.</p>
<p class="Pp"></p>
<pre>    SV*  get_sv(&quot;package::varname&quot;, GV_ADD);
    AV*  get_av(&quot;package::varname&quot;, GV_ADD);
    HV*  get_hv(&quot;package::varname&quot;, GV_ADD);
</pre>
<p class="Pp">Notice the use of GV_ADD as the second parameter. The new variable
    can now be set, using the routines appropriate to the data type.</p>
<p class="Pp">There are additional macros whose values may be bitwise OR'ed with
    the <span class="Li">&quot;GV_ADD&quot;</span> argument to enable certain
    extra features. Those bits are:</p>
<dl class="Bl-tag">
  <dt id="GV_ADDMULTI"><a class="permalink" href="#GV_ADDMULTI">GV_ADDMULTI</a></dt>
  <dd>Marks the variable as multiply defined, thus preventing the:
    <p class="Pp"></p>
    <pre>  Name &lt;varname&gt; used only once: possible typo
    </pre>
    <p class="Pp">warning.</p>
  </dd>
  <dt id="GV_ADDWARN"><a class="permalink" href="#GV_ADDWARN">GV_ADDWARN</a></dt>
  <dd>Issues the warning:
    <p class="Pp"></p>
    <pre>  Had to create &lt;varname&gt; unexpectedly
    </pre>
    <p class="Pp">if the variable did not exist before the function was
      called.</p>
  </dd>
</dl>
<p class="Pp">If you do not specify a package name, the variable is created in
    the current package.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Reference_Counts_and_Mortality"><a class="permalink" href="#Reference_Counts_and_Mortality">Reference
  Counts and Mortality</a></h2>
<p class="Pp">Perl uses a reference count-driven garbage collection mechanism.
    SVs, AVs, or HVs (xV for short in the following) start their life with a
    reference count of 1. If the reference count of an xV ever drops to 0, then
    it will be destroyed and its memory made available for reuse. At the most
    basic internal level, reference counts can be manipulated with the following
    macros:</p>
<p class="Pp"></p>
<pre>    int SvREFCNT(SV* sv);
    SV* SvREFCNT_inc(SV* sv);
    void SvREFCNT_dec(SV* sv);
</pre>
<p class="Pp">(There are also suffixed versions of the increment and decrement
    macros, for situations where the full generality of these basic macros can
    be exchanged for some performance.)</p>
<p class="Pp">However, the way a programmer should think about references is not
    so much in terms of the bare reference count, but in terms of
    <i>ownership</i> of references. A reference to an xV can be owned by any of
    a variety of entities: another xV, the Perl interpreter, an XS data
    structure, a piece of running code, or a dynamic scope. An xV generally does
    not know what entities own the references to it; it only knows how many
    references there are, which is the reference count.</p>
<p class="Pp">To correctly maintain reference counts, it is essential to keep
    track of what references the XS code is manipulating. The programmer should
    always know where a reference has come from and who owns it, and be aware of
    any creation or destruction of references, and any transfers of ownership.
    Because ownership isn't represented explicitly in the xV data structures,
    only the reference count need be actually maintained by the code, and that
    means that this understanding of ownership is not actually evident in the
    code. For example, transferring ownership of a reference from one owner to
    another doesn't change the reference count at all, so may be achieved with
    no actual code. (The transferring code doesn't touch the referenced object,
    but does need to ensure that the former owner knows that it no longer owns
    the reference, and that the new owner knows that it now does.)</p>
<p class="Pp">An xV that is visible at the Perl level should not become
    unreferenced and thus be destroyed. Normally, an object will only become
    unreferenced when it is no longer visible, often by the same means that
    makes it invisible. For example, a Perl reference value (RV) owns a
    reference to its referent, so if the RV is overwritten that reference gets
    destroyed, and the no-longer-reachable referent may be destroyed as a
    result.</p>
<p class="Pp">Many functions have some kind of reference manipulation as part of
    their purpose. Sometimes this is documented in terms of ownership of
    references, and sometimes it is (less helpfully) documented in terms of
    changes to reference counts. For example, the <b>newRV_inc()</b> function is
    documented to create a new RV (with reference count 1) and increment the
    reference count of the referent that was supplied by the caller. This is
    best understood as creating a new reference to the referent, which is owned
    by the created RV, and returning to the caller ownership of the sole
    reference to the RV. The <b>newRV_noinc()</b> function instead does not
    increment the reference count of the referent, but the RV nevertheless ends
    up owning a reference to the referent. It is therefore implied that the
    caller of <span class="Li">&quot;newRV_noinc()&quot;</span> is relinquishing
    a reference to the referent, making this conceptually a more complicated
    operation even though it does less to the data structures.</p>
<p class="Pp">For example, imagine you want to return a reference from an XSUB
    function. Inside the XSUB routine, you create an SV which initially has just
    a single reference, owned by the XSUB routine. This reference needs to be
    disposed of before the routine is complete, otherwise it will leak,
    preventing the SV from ever being destroyed. So to create an RV referencing
    the SV, it is most convenient to pass the SV to
    <span class="Li">&quot;newRV_noinc()&quot;</span>, which consumes that
    reference. Now the XSUB routine no longer owns a reference to the SV, but
    does own a reference to the RV, which in turn owns a reference to the SV.
    The ownership of the reference to the RV is then transferred by the process
    of returning the RV from the XSUB.</p>
<p class="Pp">There are some convenience functions available that can help with
    the destruction of xVs. These functions introduce the concept of
    &quot;mortality&quot;. Much documentation speaks of an xV itself being
    mortal, but this is misleading. It is really <i>a reference to</i> an xV
    that is mortal, and it is possible for there to be more than one mortal
    reference to a single xV. For a reference to be mortal means that it is
    owned by the temps stack, one of perl's many internal stacks, which will
    destroy that reference &quot;a short time later&quot;. Usually the
    &quot;short time later&quot; is the end of the current Perl statement.
    However, it gets more complicated around dynamic scopes: there can be
    multiple sets of mortal references hanging around at the same time, with
    different death dates. Internally, the actual determinant for when mortal xV
    references are destroyed depends on two macros, SAVETMPS and FREETMPS. See
    perlcall and perlxs and &quot;Temporaries Stack&quot; below for more details
    on these macros.</p>
<p class="Pp">Mortal references are mainly used for xVs that are placed on
    perl's main stack. The stack is problematic for reference tracking, because
    it contains a lot of xV references, but doesn't own those references: they
    are not counted. Currently, there are many bugs resulting from xVs being
    destroyed while referenced by the stack, because the stack's uncounted
    references aren't enough to keep the xVs alive. So when putting an
    (uncounted) reference on the stack, it is vitally important to ensure that
    there will be a counted reference to the same xV that will last at least as
    long as the uncounted reference. But it's also important that that counted
    reference be cleaned up at an appropriate time, and not unduly prolong the
    xV's life. For there to be a mortal reference is often the best way to
    satisfy this requirement, especially if the xV was created especially to be
    put on the stack and would otherwise be unreferenced.</p>
<p class="Pp">To create a mortal reference, use the functions:</p>
<p class="Pp"></p>
<pre>    SV*  sv_newmortal()
    SV*  sv_mortalcopy(SV*)
    SV*  sv_2mortal(SV*)
</pre>
<p class="Pp"><span class="Li">&quot;sv_newmortal()&quot;</span> creates an SV
    (with the undefined value) whose sole reference is mortal.
    <span class="Li">&quot;sv_mortalcopy()&quot;</span> creates an xV whose
    value is a copy of a supplied xV and whose sole reference is mortal.
    <span class="Li">&quot;sv_2mortal()&quot;</span> mortalises an existing xV
    reference: it transfers ownership of a reference from the caller to the
    temps stack. Because <span class="Li">&quot;sv_newmortal&quot;</span> gives
    the new SV no value, it must normally be given one via
    <span class="Li">&quot;sv_setpv&quot;</span>,
    <span class="Li">&quot;sv_setiv&quot;</span>, etc. :</p>
<p class="Pp"></p>
<pre>    SV *tmp = sv_newmortal();
    sv_setiv(tmp, an_integer);
</pre>
<p class="Pp">As that is multiple C statements it is quite common so see this
    idiom instead:</p>
<p class="Pp"></p>
<pre>    SV *tmp = sv_2mortal(newSViv(an_integer));
</pre>
<p class="Pp">The mortal routines are not just for SVs; AVs and HVs can be made
    mortal by passing their address (type-casted to
    <span class="Li">&quot;SV*&quot;</span>) to the
    <span class="Li">&quot;sv_2mortal&quot;</span> or
    <span class="Li">&quot;sv_mortalcopy&quot;</span> routines.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Stashes_and_Globs"><a class="permalink" href="#Stashes_and_Globs">Stashes
  and Globs</a></h2>
<p class="Pp">A <b>stash</b> is a hash that contains all variables that are
    defined within a package. Each key of the stash is a symbol name (shared by
    all the different types of objects that have the same name), and each value
    in the hash table is a GV (Glob Value). This GV in turn contains references
    to the various objects of that name, including (but not limited to) the
    following:</p>
<p class="Pp"></p>
<pre>    Scalar Value
    Array Value
    Hash Value
    I/O Handle
    Format
    Subroutine
</pre>
<p class="Pp">There is a single stash called
    <span class="Li">&quot;PL_defstash&quot;</span> that holds the items that
    exist in the <span class="Li">&quot;main&quot;</span> package. To get at the
    items in other packages, append the string &quot;::&quot; to the package
    name. The items in the <span class="Li">&quot;Foo&quot;</span> package are
    in the stash <span class="Li">&quot;Foo::&quot;</span> in PL_defstash. The
    items in the <span class="Li">&quot;Bar::Baz&quot;</span> package are in the
    stash <span class="Li">&quot;Baz::&quot;</span> in
    <span class="Li">&quot;Bar::&quot;</span>'s stash.</p>
<p class="Pp">To get the stash pointer for a particular package, use the
    function:</p>
<p class="Pp"></p>
<pre>    HV*  gv_stashpv(const char* name, I32 flags)
    HV*  gv_stashsv(SV*, I32 flags)
</pre>
<p class="Pp">The first function takes a literal string, the second uses the
    string stored in the SV. Remember that a stash is just a hash table, so you
    get back an <span class="Li">&quot;HV*&quot;</span>. The
    <span class="Li">&quot;flags&quot;</span> flag will create a new package if
    it is set to GV_ADD.</p>
<p class="Pp">The name that <span class="Li">&quot;gv_stash*v&quot;</span> wants
    is the name of the package whose symbol table you want. The default package
    is called <span class="Li">&quot;main&quot;</span>. If you have multiply
    nested packages, pass their names to
    <span class="Li">&quot;gv_stash*v&quot;</span>, separated by
    <span class="Li">&quot;::&quot;</span> as in the Perl language itself.</p>
<p class="Pp">Alternately, if you have an SV that is a blessed reference, you
    can find out the stash pointer by using:</p>
<p class="Pp"></p>
<pre>    HV*  SvSTASH(SvRV(SV*));
</pre>
<p class="Pp">then use the following to get the package name itself:</p>
<p class="Pp"></p>
<pre>    char*  HvNAME(HV* stash);
</pre>
<p class="Pp">If you need to bless or re-bless an object you can use the
    following function:</p>
<p class="Pp"></p>
<pre>    SV*  sv_bless(SV*, HV* stash)
</pre>
<p class="Pp">where the first argument, an
    <span class="Li">&quot;SV*&quot;</span>, must be a reference, and the second
    argument is a stash. The returned <span class="Li">&quot;SV*&quot;</span>
    can now be used in the same way as any other SV.</p>
<p class="Pp">For more information on references and blessings, consult
  perlref.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="I/O_Handles"><a class="permalink" href="#I/O_Handles">I/O
  Handles</a></h2>
<p class="Pp">Like AVs and HVs, IO objects are another type of non-scalar SV
    which may contain input and output PerlIO objects or a
    <span class="Li">&quot;DIR *&quot;</span> from <b>opendir()</b>.</p>
<p class="Pp">You can create a new IO object:</p>
<p class="Pp"></p>
<pre>    IO*  newIO();
</pre>
<p class="Pp">Unlike other SVs, a new IO object is automatically blessed into
    the IO::File class.</p>
<p class="Pp">The IO object contains an input and output PerlIO handle:</p>
<p class="Pp"></p>
<pre>  PerlIO *IoIFP(IO *io);
  PerlIO *IoOFP(IO *io);
</pre>
<p class="Pp">Typically if the IO object has been opened on a file, the input
    handle is always present, but the output handle is only present if the file
    is open for output. For a file, if both are present they will be the same
    PerlIO object.</p>
<p class="Pp">Distinct input and output PerlIO objects are created for sockets
    and character devices.</p>
<p class="Pp">The IO object also contains other data associated with Perl I/O
    handles:</p>
<p class="Pp"></p>
<pre>  IV IoLINES(io);                /* $. */
  IV IoPAGE(io);                 /* $% */
  IV IoPAGE_LEN(io);             /* $= */
  IV IoLINES_LEFT(io);           /* $- */
  char *IoTOP_NAME(io);          /* $^ */
  GV *IoTOP_GV(io);              /* $^ */
  char *IoFMT_NAME(io);          /* $~ */
  GV *IoFMT_GV(io);              /* $~ */
  char *IoBOTTOM_NAME(io);
  GV *IoBOTTOM_GV(io);
  char IoTYPE(io);
  U8 IoFLAGS(io);
</pre>
<p class="Pp">Most of these are involved with formats.</p>
<p class="Pp"><b>IoFLAGs()</b> may contain a combination of flags, the most
    interesting of which are <span class="Li">&quot;IOf_FLUSH&quot;</span>
    (<span class="Li">$|</span>) for autoflush and
    <span class="Li">&quot;IOf_UNTAINT&quot;</span>, settable with IO::Handle's
    <b>untaint()</b> method.</p>
<p class="Pp">The IO object may also contains a directory handle:</p>
<p class="Pp"></p>
<pre>  DIR *IoDIRP(io);
</pre>
<p class="Pp">suitable for use with <b>PerlDir_read()</b> etc.</p>
<p class="Pp">All of these accessors macros are lvalues, there are no distinct
    <span class="Li">&quot;_set()&quot;</span> macros to modify the members of
    the IO object.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Double-Typed_SVs"><a class="permalink" href="#Double-Typed_SVs">Double-Typed
  SVs</a></h2>
<p class="Pp">Scalar variables normally contain only one type of value, an
    integer, double, pointer, or reference. Perl will automatically convert the
    actual scalar data from the stored type into the requested type.</p>
<p class="Pp">Some scalar variables contain more than one type of scalar data.
    For example, the variable <span class="Li">$!</span> contains either the
    numeric value of <span class="Li">&quot;errno&quot;</span> or its string
    equivalent from either <span class="Li">&quot;strerror&quot;</span> or
    <span class="Li">&quot;sys_errlist[]&quot;</span>.</p>
<p class="Pp">To force multiple data values into an SV, you must do two things:
    use the <span class="Li">&quot;sv_set*v&quot;</span> routines to add the
    additional scalar type, then set a flag so that Perl will believe it
    contains more than one type of data. The four macros to set the flags
  are:</p>
<p class="Pp"></p>
<pre>        SvIOK_on
        SvNOK_on
        SvPOK_on
        SvROK_on
</pre>
<p class="Pp">The particular macro you must use depends on which
    <span class="Li">&quot;sv_set*v&quot;</span> routine you called first. This
    is because every <span class="Li">&quot;sv_set*v&quot;</span> routine turns
    on only the bit for the particular type of data being set, and turns off all
    the rest.</p>
<p class="Pp">For example, to create a new Perl variable called
    &quot;dberror&quot; that contains both the numeric and descriptive string
    error values, you could use the following code:</p>
<p class="Pp"></p>
<pre>    extern int  dberror;
    extern char *dberror_list;
    SV* sv = get_sv(&quot;dberror&quot;, GV_ADD);
    sv_setiv(sv, (IV) dberror);
    sv_setpv(sv, dberror_list[dberror]);
    SvIOK_on(sv);
</pre>
<p class="Pp">If the order of <span class="Li">&quot;sv_setiv&quot;</span> and
    <span class="Li">&quot;sv_setpv&quot;</span> had been reversed, then the
    macro <span class="Li">&quot;SvPOK_on&quot;</span> would need to be called
    instead of <span class="Li">&quot;SvIOK_on&quot;</span>.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Read-Only_Values"><a class="permalink" href="#Read-Only_Values">Read-Only
  Values</a></h2>
<p class="Pp">In Perl 5.16 and earlier, copy-on-write (see the next section)
    shared a flag bit with read-only scalars. So the only way to test whether
    <span class="Li">&quot;sv_setsv&quot;</span>, etc., will raise a
    &quot;Modification of a read-only value&quot; error in those versions
  is:</p>
<p class="Pp"></p>
<pre>    SvREADONLY(sv) &amp;&amp; !SvIsCOW(sv)
</pre>
<p class="Pp">Under Perl 5.18 and later, SvREADONLY only applies to read-only
    variables, and, under 5.20, copy-on-write scalars can also be read-only, so
    the above check is incorrect. You just want:</p>
<p class="Pp"></p>
<pre>    SvREADONLY(sv)
</pre>
<p class="Pp">If you need to do this check often, define your own macro like
    this:</p>
<p class="Pp"></p>
<pre>    #if PERL_VERSION &gt;= 18
    # define SvTRULYREADONLY(sv) SvREADONLY(sv)
    #else
    # define SvTRULYREADONLY(sv) (SvREADONLY(sv) &amp;&amp; !SvIsCOW(sv))
    #endif
</pre>
</section>
<section class="Ss">
<h2 class="Ss" id="Copy_on_Write"><a class="permalink" href="#Copy_on_Write">Copy
  on Write</a></h2>
<p class="Pp">Perl implements a copy-on-write (COW) mechanism for scalars, in
    which string copies are not immediately made when requested, but are
    deferred until made necessary by one or the other scalar changing. This is
    mostly transparent, but one must take care not to modify string buffers that
    are shared by multiple SVs.</p>
<p class="Pp">You can test whether an SV is using copy-on-write with
    <span class="Li">&quot;SvIsCOW(sv)&quot;</span>.</p>
<p class="Pp">You can force an SV to make its own copy of its string buffer by
    calling <span class="Li">&quot;sv_force_normal(sv)&quot;</span> or
    SvPV_force_nolen(sv).</p>
<p class="Pp">If you want to make the SV drop its string buffer, use
    <span class="Li">&quot;sv_force_normal_flags(sv,
    SV_COW_DROP_PV)&quot;</span> or simply <span class="Li">&quot;sv_setsv(sv,
    NULL)&quot;</span>.</p>
<p class="Pp">All of these functions will croak on read-only scalars (see the
    previous section for more on those).</p>
<p class="Pp">To test that your code is behaving correctly and not modifying COW
    buffers, on systems that support <b>mmap</b>(2) (i.e., Unix) you can
    configure perl with
    <span class="Li">&quot;-Accflags=-DPERL_DEBUG_READONLY_COW&quot;</span> and
    it will turn buffer violations into crashes. You will find it to be
    marvellously slow, so you may want to skip perl's own tests.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Magic_Variables"><a class="permalink" href="#Magic_Variables">Magic
  Variables</a></h2>
<p class="Pp">[This section still under construction. Ignore everything here.
    Post no bills. Everything not permitted is forbidden.]</p>
<p class="Pp">Any SV may be magical, that is, it has special features that a
    normal SV does not have. These features are stored in the SV structure in a
    linked list of <span class="Li">&quot;struct magic&quot;</span>'s,
    typedef'ed to <span class="Li">&quot;MAGIC&quot;</span>.</p>
<p class="Pp"></p>
<pre>    struct magic {
        MAGIC*      mg_moremagic;
        MGVTBL*     mg_virtual;
        U16         mg_private;
        char        mg_type;
        U8          mg_flags;
        I32         mg_len;
        SV*         mg_obj;
        char*       mg_ptr;
    };
</pre>
<p class="Pp">Note this is current as of patchlevel 0, and could change at any
    time.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Assigning_Magic"><a class="permalink" href="#Assigning_Magic">Assigning
  Magic</a></h2>
<p class="Pp">Perl adds magic to an SV using the sv_magic function:</p>
<p class="Pp"></p>
<pre>  void sv_magic(SV* sv, SV* obj, int how, const char* name, I32 namlen);
</pre>
<p class="Pp">The <span class="Li">&quot;sv&quot;</span> argument is a pointer
    to the SV that is to acquire a new magical feature.</p>
<p class="Pp">If <span class="Li">&quot;sv&quot;</span> is not already magical,
    Perl uses the <span class="Li">&quot;SvUPGRADE&quot;</span> macro to convert
    <span class="Li">&quot;sv&quot;</span> to type
    <span class="Li">&quot;SVt_PVMG&quot;</span>. Perl then continues by adding
    new magic to the beginning of the linked list of magical features. Any prior
    entry of the same type of magic is deleted. Note that this can be
    overridden, and multiple instances of the same type of magic can be
    associated with an SV.</p>
<p class="Pp">The <span class="Li">&quot;name&quot;</span> and
    <span class="Li">&quot;namlen&quot;</span> arguments are used to associate a
    string with the magic, typically the name of a variable.
    <span class="Li">&quot;namlen&quot;</span> is stored in the
    <span class="Li">&quot;mg_len&quot;</span> field and if
    <span class="Li">&quot;name&quot;</span> is non-null then either a
    <span class="Li">&quot;savepvn&quot;</span> copy of
    <span class="Li">&quot;name&quot;</span> or
    <span class="Li">&quot;name&quot;</span> itself is stored in the
    <span class="Li">&quot;mg_ptr&quot;</span> field, depending on whether
    <span class="Li">&quot;namlen&quot;</span> is greater than zero or equal to
    zero respectively. As a special case, if <span class="Li">&quot;(name
    &amp;&amp; namlen == HEf_SVKEY)&quot;</span> then
    <span class="Li">&quot;name&quot;</span> is assumed to contain an
    <span class="Li">&quot;SV*&quot;</span> and is stored as-is with its REFCNT
    incremented.</p>
<p class="Pp">The sv_magic function uses <span class="Li">&quot;how&quot;</span>
    to determine which, if any, predefined &quot;Magic Virtual Table&quot;
    should be assigned to the <span class="Li">&quot;mg_virtual&quot;</span>
    field. See the &quot;Magic Virtual Tables&quot; section below. The
    <span class="Li">&quot;how&quot;</span> argument is also stored in the
    <span class="Li">&quot;mg_type&quot;</span> field. The value of
    <span class="Li">&quot;how&quot;</span> should be chosen from the set of
    macros <span class="Li">&quot;PERL_MAGIC_foo&quot;</span> found in
    <i>perl.h</i>. Note that before these macros were added, Perl internals used
    to directly use character literals, so you may occasionally come across old
    code or documentation referring to 'U' magic rather than
    <span class="Li">&quot;PERL_MAGIC_uvar&quot;</span> for example.</p>
<p class="Pp">The <span class="Li">&quot;obj&quot;</span> argument is stored in
    the <span class="Li">&quot;mg_obj&quot;</span> field of the
    <span class="Li">&quot;MAGIC&quot;</span> structure. If it is not the same
    as the <span class="Li">&quot;sv&quot;</span> argument, the reference count
    of the <span class="Li">&quot;obj&quot;</span> object is incremented. If it
    is the same, or if the <span class="Li">&quot;how&quot;</span> argument is
    <span class="Li">&quot;PERL_MAGIC_arylen&quot;</span>,
    <span class="Li">&quot;PERL_MAGIC_regdatum&quot;</span>,
    <span class="Li">&quot;PERL_MAGIC_regdata&quot;</span>, or if it is a NULL
    pointer, then <span class="Li">&quot;obj&quot;</span> is merely stored,
    without the reference count being incremented.</p>
<p class="Pp">See also <span class="Li">&quot;sv_magicext&quot;</span> in
    perlapi for a more flexible way to add magic to an SV.</p>
<p class="Pp">There is also a function to add magic to an
    <span class="Li">&quot;HV&quot;</span>:</p>
<p class="Pp"></p>
<pre>    void hv_magic(HV *hv, GV *gv, int how);
</pre>
<p class="Pp">This simply calls <span class="Li">&quot;sv_magic&quot;</span> and
    coerces the <span class="Li">&quot;gv&quot;</span> argument into an
    <span class="Li">&quot;SV&quot;</span>.</p>
<p class="Pp">To remove the magic from an SV, call the function sv_unmagic:</p>
<p class="Pp"></p>
<pre>    int sv_unmagic(SV *sv, int type);
</pre>
<p class="Pp">The <span class="Li">&quot;type&quot;</span> argument should be
    equal to the <span class="Li">&quot;how&quot;</span> value when the
    <span class="Li">&quot;SV&quot;</span> was initially made magical.</p>
<p class="Pp">However, note that <span class="Li">&quot;sv_unmagic&quot;</span>
    removes all magic of a certain <span class="Li">&quot;type&quot;</span> from
    the <span class="Li">&quot;SV&quot;</span>. If you want to remove only
    certain magic of a <span class="Li">&quot;type&quot;</span> based on the
    magic virtual table, use <span class="Li">&quot;sv_unmagicext&quot;</span>
    instead:</p>
<p class="Pp"></p>
<pre>    int sv_unmagicext(SV *sv, int type, MGVTBL *vtbl);
</pre>
</section>
<section class="Ss">
<h2 class="Ss" id="Magic_Virtual_Tables"><a class="permalink" href="#Magic_Virtual_Tables">Magic
  Virtual Tables</a></h2>
<p class="Pp">The <span class="Li">&quot;mg_virtual&quot;</span> field in the
    <span class="Li">&quot;MAGIC&quot;</span> structure is a pointer to an
    <span class="Li">&quot;MGVTBL&quot;</span>, which is a structure of function
    pointers and stands for &quot;Magic Virtual Table&quot; to handle the
    various operations that might be applied to that variable.</p>
<p class="Pp">The <span class="Li">&quot;MGVTBL&quot;</span> has five (or
    sometimes eight) pointers to the following routine types:</p>
<p class="Pp"></p>
<pre>    int  (*svt_get)  (pTHX_ SV* sv, MAGIC* mg);
    int  (*svt_set)  (pTHX_ SV* sv, MAGIC* mg);
    U32  (*svt_len)  (pTHX_ SV* sv, MAGIC* mg);
    int  (*svt_clear)(pTHX_ SV* sv, MAGIC* mg);
    int  (*svt_free) (pTHX_ SV* sv, MAGIC* mg);
    int  (*svt_copy) (pTHX_ SV *sv, MAGIC* mg, SV *nsv,
                                          const char *name, I32 namlen);
    int  (*svt_dup)  (pTHX_ MAGIC *mg, CLONE_PARAMS *param);
    int  (*svt_local)(pTHX_ SV *nsv, MAGIC *mg);
</pre>
<p class="Pp">This MGVTBL structure is set at compile-time in <i>perl.h</i> and
    there are currently 32 types. These different structures contain pointers to
    various routines that perform additional actions depending on which function
    is being called.</p>
<p class="Pp"></p>
<pre>   Function pointer    Action taken
   ----------------    ------------
   svt_get             Do something before the value of the SV is
                       retrieved.
   svt_set             Do something after the SV is assigned a value.
   svt_len             Report on the SV's length.
   svt_clear           Clear something the SV represents.
   svt_free            Free any extra storage associated with the SV.
   svt_copy            copy tied variable magic to a tied element
   svt_dup             duplicate a magic structure during thread cloning
   svt_local           copy magic to local value during 'local'
</pre>
<p class="Pp">For instance, the MGVTBL structure called
    <span class="Li">&quot;vtbl_sv&quot;</span> (which corresponds to an
    <span class="Li">&quot;mg_type&quot;</span> of
    <span class="Li">&quot;PERL_MAGIC_sv&quot;</span>) contains:</p>
<p class="Pp"></p>
<pre>    { magic_get, magic_set, magic_len, 0, 0 }
</pre>
<p class="Pp">Thus, when an SV is determined to be magical and of type
    <span class="Li">&quot;PERL_MAGIC_sv&quot;</span>, if a get operation is
    being performed, the routine <span class="Li">&quot;magic_get&quot;</span>
    is called. All the various routines for the various magical types begin with
    <span class="Li">&quot;magic_&quot;</span>. NOTE: the magic routines are not
    considered part of the Perl API, and may not be exported by the Perl
    library.</p>
<p class="Pp">The last three slots are a recent addition, and for source code
    compatibility they are only checked for if one of the three flags MGf_COPY,
    MGf_DUP or MGf_LOCAL is set in mg_flags. This means that most code can
    continue declaring a vtable as a 5-element value. These three are currently
    used exclusively by the threading code, and are highly subject to
  change.</p>
<p class="Pp">The current kinds of Magic Virtual Tables are:</p>
<p class="Pp"></p>
<pre> mg_type
 (old-style char and macro)   MGVTBL         Type of magic
 --------------------------   ------         -------------
 \0 PERL_MAGIC_sv             vtbl_sv        Special scalar variable
 #  PERL_MAGIC_arylen         vtbl_arylen    Array length ($#ary)
 %  PERL_MAGIC_rhash          (none)         Extra data for restricted
                                             hashes
 *  PERL_MAGIC_debugvar       vtbl_debugvar  $DB::single, signal, trace
                                             vars
 .  PERL_MAGIC_pos            vtbl_pos       pos() lvalue
 :  PERL_MAGIC_symtab         (none)         Extra data for symbol
                                             tables
 &lt;  PERL_MAGIC_backref        vtbl_backref   For weak ref data
 @  PERL_MAGIC_arylen_p       (none)         To move arylen out of XPVAV
 B  PERL_MAGIC_bm             vtbl_regexp    Boyer-Moore 
                                             (fast string search)
 c  PERL_MAGIC_overload_table vtbl_ovrld     Holds overload table 
                                             (AMT) on stash
 D  PERL_MAGIC_regdata        vtbl_regdata   Regex match position data 
                                             (@+ and @- vars)
 d  PERL_MAGIC_regdatum       vtbl_regdatum  Regex match position data
                                             element
 E  PERL_MAGIC_env            vtbl_env       %ENV hash
 e  PERL_MAGIC_envelem        vtbl_envelem   %ENV hash element
 f  PERL_MAGIC_fm             vtbl_regexp    Formline 
                                             ('compiled' format)
 g  PERL_MAGIC_regex_global   vtbl_mglob     m//g target
 H  PERL_MAGIC_hints          vtbl_hints     %^H hash
 h  PERL_MAGIC_hintselem      vtbl_hintselem %^H hash element
 I  PERL_MAGIC_isa            vtbl_isa       @ISA array
 i  PERL_MAGIC_isaelem        vtbl_isaelem   @ISA array element
 k  PERL_MAGIC_nkeys          vtbl_nkeys     scalar(keys()) lvalue
 L  PERL_MAGIC_dbfile         (none)         Debugger %_&lt;filename
 l  PERL_MAGIC_dbline         vtbl_dbline    Debugger %_&lt;filename
                                             element
 N  PERL_MAGIC_shared         (none)         Shared between threads
 n  PERL_MAGIC_shared_scalar  (none)         Shared between threads
 o  PERL_MAGIC_collxfrm       vtbl_collxfrm  Locale transformation
 P  PERL_MAGIC_tied           vtbl_pack      Tied array or hash
 p  PERL_MAGIC_tiedelem       vtbl_packelem  Tied array or hash element
 q  PERL_MAGIC_tiedscalar     vtbl_packelem  Tied scalar or handle
 r  PERL_MAGIC_qr             vtbl_regexp    Precompiled qr// regex
 S  PERL_MAGIC_sig            (none)         %SIG hash
 s  PERL_MAGIC_sigelem        vtbl_sigelem   %SIG hash element
 t  PERL_MAGIC_taint          vtbl_taint     Taintedness
 U  PERL_MAGIC_uvar           vtbl_uvar      Available for use by
                                             extensions
 u  PERL_MAGIC_uvar_elem      (none)         Reserved for use by
                                             extensions
 V  PERL_MAGIC_vstring        (none)         SV was vstring literal
 v  PERL_MAGIC_vec            vtbl_vec       vec() lvalue
 w  PERL_MAGIC_utf8           vtbl_utf8      Cached UTF-8 information
 x  PERL_MAGIC_substr         vtbl_substr    substr() lvalue
 Y  PERL_MAGIC_nonelem        vtbl_nonelem   Array element that does not
                                             exist
 y  PERL_MAGIC_defelem        vtbl_defelem   Shadow &quot;foreach&quot; iterator
                                             variable / smart parameter
                                             vivification
 \  PERL_MAGIC_lvref          vtbl_lvref     Lvalue reference
                                             constructor
 ]  PERL_MAGIC_checkcall      vtbl_checkcall Inlining/mutation of call
                                             to this CV
 ~  PERL_MAGIC_ext            (none)         Available for use by
                                             extensions
</pre>
<p class="Pp">When an uppercase and lowercase letter both exist in the table,
    then the uppercase letter is typically used to represent some kind of
    composite type (a list or a hash), and the lowercase letter is used to
    represent an element of that composite type. Some internals code makes use
    of this case relationship. However, 'v' and 'V' (vec and v-string) are in no
    way related.</p>
<p class="Pp">The <span class="Li">&quot;PERL_MAGIC_ext&quot;</span> and
    <span class="Li">&quot;PERL_MAGIC_uvar&quot;</span> magic types are defined
    specifically for use by extensions and will not be used by perl itself.
    Extensions can use <span class="Li">&quot;PERL_MAGIC_ext&quot;</span> magic
    to 'attach' private information to variables (typically objects). This is
    especially useful because there is no way for normal perl code to corrupt
    this private information (unlike using extra elements of a hash object).</p>
<p class="Pp">Similarly, <span class="Li">&quot;PERL_MAGIC_uvar&quot;</span>
    magic can be used much like <b>tie()</b> to call a C function any time a
    scalar's value is used or changed. The
    <span class="Li">&quot;MAGIC&quot;</span>'s
    <span class="Li">&quot;mg_ptr&quot;</span> field points to a
    <span class="Li">&quot;ufuncs&quot;</span> structure:</p>
<p class="Pp"></p>
<pre>    struct ufuncs {
        I32 (*uf_val)(pTHX_ IV, SV*);
        I32 (*uf_set)(pTHX_ IV, SV*);
        IV uf_index;
    };
</pre>
<p class="Pp">When the SV is read from or written to, the
    <span class="Li">&quot;uf_val&quot;</span> or
    <span class="Li">&quot;uf_set&quot;</span> function will be called with
    <span class="Li">&quot;uf_index&quot;</span> as the first arg and a pointer
    to the SV as the second. A simple example of how to add
    <span class="Li">&quot;PERL_MAGIC_uvar&quot;</span> magic is shown below.
    Note that the ufuncs structure is copied by sv_magic, so you can safely
    allocate it on the stack.</p>
<p class="Pp"></p>
<pre>    void
    Umagic(sv)
        SV *sv;
    PREINIT:
        struct ufuncs uf;
    CODE:
        uf.uf_val   = &amp;my_get_fn;
        uf.uf_set   = &amp;my_set_fn;
        uf.uf_index = 0;
        sv_magic(sv, 0, PERL_MAGIC_uvar, (char*)&amp;uf, sizeof(uf));
</pre>
<p class="Pp">Attaching <span class="Li">&quot;PERL_MAGIC_uvar&quot;</span> to
    arrays is permissible but has no effect.</p>
<p class="Pp">For hashes there is a specialized hook that gives control over
    hash keys (but not values). This hook calls
    <span class="Li">&quot;PERL_MAGIC_uvar&quot;</span> 'get' magic if the
    &quot;set&quot; function in the <span class="Li">&quot;ufuncs&quot;</span>
    structure is NULL. The hook is activated whenever the hash is accessed with
    a key specified as an <span class="Li">&quot;SV&quot;</span> through the
    functions <span class="Li">&quot;hv_store_ent&quot;</span>,
    <span class="Li">&quot;hv_fetch_ent&quot;</span>,
    <span class="Li">&quot;hv_delete_ent&quot;</span>, and
    <span class="Li">&quot;hv_exists_ent&quot;</span>. Accessing the key as a
    string through the functions without the
    <span class="Li">&quot;..._ent&quot;</span> suffix circumvents the hook. See
    &quot;GUTS&quot; in Hash::Util::FieldHash for a detailed description.</p>
<p class="Pp">Note that because multiple extensions may be using
    <span class="Li">&quot;PERL_MAGIC_ext&quot;</span> or
    <span class="Li">&quot;PERL_MAGIC_uvar&quot;</span> magic, it is important
    for extensions to take extra care to avoid conflict. Typically only using
    the magic on objects blessed into the same class as the extension is
    sufficient. For <span class="Li">&quot;PERL_MAGIC_ext&quot;</span> magic, it
    is usually a good idea to define an
    <span class="Li">&quot;MGVTBL&quot;</span>, even if all its fields will be
    <span class="Li">0</span>, so that individual
    <span class="Li">&quot;MAGIC&quot;</span> pointers can be identified as a
    particular kind of magic using their magic virtual table.
    <span class="Li">&quot;mg_findext&quot;</span> provides an easy way to do
    that:</p>
<p class="Pp"></p>
<pre>    STATIC MGVTBL my_vtbl = { 0, 0, 0, 0, 0, 0, 0, 0 };
    MAGIC *mg;
    if ((mg = mg_findext(sv, PERL_MAGIC_ext, &amp;my_vtbl))) {
        /* this is really ours, not another module's PERL_MAGIC_ext */
        my_priv_data_t *priv = (my_priv_data_t *)mg-&gt;mg_ptr;
        ...
    }
</pre>
<p class="Pp">Also note that the <span class="Li">&quot;sv_set*()&quot;</span>
    and <span class="Li">&quot;sv_cat*()&quot;</span> functions described
    earlier do <b>not</b> invoke 'set' magic on their targets. This must be done
    by the user either by calling the
    <span class="Li">&quot;SvSETMAGIC()&quot;</span> macro after calling these
    functions, or by using one of the
    <span class="Li">&quot;sv_set*_mg()&quot;</span> or
    <span class="Li">&quot;sv_cat*_mg()&quot;</span> functions. Similarly,
    generic C code must call the
    <span class="Li">&quot;SvGETMAGIC()&quot;</span> macro to invoke any 'get'
    magic if they use an SV obtained from external sources in functions that
    don't handle magic. See perlapi for a description of these functions. For
    example, calls to the <span class="Li">&quot;sv_cat*()&quot;</span>
    functions typically need to be followed by
    <span class="Li">&quot;SvSETMAGIC()&quot;</span>, but they don't need a
    prior <span class="Li">&quot;SvGETMAGIC()&quot;</span> since their
    implementation handles 'get' magic.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Finding_Magic"><a class="permalink" href="#Finding_Magic">Finding
  Magic</a></h2>
<pre>    MAGIC *mg_find(SV *sv, int type); /* Finds the magic pointer of that
                                       * type */
</pre>
<p class="Pp">This routine returns a pointer to a
    <span class="Li">&quot;MAGIC&quot;</span> structure stored in the SV. If the
    SV does not have that magical feature,
    <span class="Li">&quot;NULL&quot;</span> is returned. If the SV has multiple
    instances of that magical feature, the first one will be returned.
    <span class="Li">&quot;mg_findext&quot;</span> can be used to find a
    <span class="Li">&quot;MAGIC&quot;</span> structure of an SV based on both
    its magic type and its magic virtual table:</p>
<p class="Pp"></p>
<pre>    MAGIC *mg_findext(SV *sv, int type, MGVTBL *vtbl);
</pre>
<p class="Pp">Also, if the SV passed to
    <span class="Li">&quot;mg_find&quot;</span> or
    <span class="Li">&quot;mg_findext&quot;</span> is not of type SVt_PVMG, Perl
    may core dump.</p>
<p class="Pp"></p>
<pre>    int mg_copy(SV* sv, SV* nsv, const char* key, STRLEN klen);
</pre>
<p class="Pp">This routine checks to see what types of magic
    <span class="Li">&quot;sv&quot;</span> has. If the mg_type field is an
    uppercase letter, then the mg_obj is copied to
    <span class="Li">&quot;nsv&quot;</span>, but the mg_type field is changed to
    be the lowercase letter.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Understanding_the_Magic_of_Tied_Hashes_and_Arrays"><a class="permalink" href="#Understanding_the_Magic_of_Tied_Hashes_and_Arrays">Understanding
  the Magic of Tied Hashes and Arrays</a></h2>
<p class="Pp">Tied hashes and arrays are magical beasts of the
    <span class="Li">&quot;PERL_MAGIC_tied&quot;</span> magic type.</p>
<p class="Pp">WARNING: As of the 5.004 release, proper usage of the array and
    hash access functions requires understanding a few caveats. Some of these
    caveats are actually considered bugs in the API, to be fixed in later
    releases, and are bracketed with [MAYCHANGE] below. If you find yourself
    actually applying such information in this section, be aware that the
    behavior may change in the future, umm, without warning.</p>
<p class="Pp">The perl tie function associates a variable with an object that
    implements the various GET, SET, etc methods. To perform the equivalent of
    the perl tie function from an XSUB, you must mimic this behaviour. The code
    below carries out the necessary steps -- firstly it creates a new hash, and
    then creates a second hash which it blesses into the class which will
    implement the tie methods. Lastly it ties the two hashes together, and
    returns a reference to the new tied hash. Note that the code below does NOT
    call the TIEHASH method in the MyTie class - see &quot;Calling Perl Routines
    from within C Programs&quot; for details on how to do this.</p>
<p class="Pp"></p>
<pre>    SV*
    mytie()
    PREINIT:
        HV *hash;
        HV *stash;
        SV *tie;
    CODE:
        hash = newHV();
        tie = newRV_noinc((SV*)newHV());
        stash = gv_stashpv(&quot;MyTie&quot;, GV_ADD);
        sv_bless(tie, stash);
        hv_magic(hash, (GV*)tie, PERL_MAGIC_tied);
        RETVAL = newRV_noinc(hash);
    OUTPUT:
        RETVAL
</pre>
<p class="Pp">The <span class="Li">&quot;av_store&quot;</span> function, when
    given a tied array argument, merely copies the magic of the array onto the
    value to be &quot;stored&quot;, using
    <span class="Li">&quot;mg_copy&quot;</span>. It may also return NULL,
    indicating that the value did not actually need to be stored in the array.
    [MAYCHANGE] After a call to <span class="Li">&quot;av_store&quot;</span> on
    a tied array, the caller will usually need to call
    <span class="Li">&quot;mg_set(val)&quot;</span> to actually invoke the perl
    level &quot;STORE&quot; method on the TIEARRAY object. If
    <span class="Li">&quot;av_store&quot;</span> did return NULL, a call to
    <span class="Li">&quot;SvREFCNT_dec(val)&quot;</span> will also be usually
    necessary to avoid a memory leak. [/MAYCHANGE]</p>
<p class="Pp">The previous paragraph is applicable verbatim to tied hash access
    using the <span class="Li">&quot;hv_store&quot;</span> and
    <span class="Li">&quot;hv_store_ent&quot;</span> functions as well.</p>
<p class="Pp"><span class="Li">&quot;av_fetch&quot;</span> and the corresponding
    hash functions <span class="Li">&quot;hv_fetch&quot;</span> and
    <span class="Li">&quot;hv_fetch_ent&quot;</span> actually return an
    undefined mortal value whose magic has been initialized using
    <span class="Li">&quot;mg_copy&quot;</span>. Note the value so returned does
    not need to be deallocated, as it is already mortal. [MAYCHANGE] But you
    will need to call <span class="Li">&quot;mg_get()&quot;</span> on the
    returned value in order to actually invoke the perl level &quot;FETCH&quot;
    method on the underlying TIE object. Similarly, you may also call
    <span class="Li">&quot;mg_set()&quot;</span> on the return value after
    possibly assigning a suitable value to it using
    <span class="Li">&quot;sv_setsv&quot;</span>, which will invoke the
    &quot;STORE&quot; method on the TIE object. [/MAYCHANGE]</p>
<p class="Pp">[MAYCHANGE] In other words, the array or hash fetch/store
    functions don't really fetch and store actual values in the case of tied
    arrays and hashes. They merely call
    <span class="Li">&quot;mg_copy&quot;</span> to attach magic to the values
    that were meant to be &quot;stored&quot; or &quot;fetched&quot;. Later calls
    to <span class="Li">&quot;mg_get&quot;</span> and
    <span class="Li">&quot;mg_set&quot;</span> actually do the job of invoking
    the TIE methods on the underlying objects. Thus the magic mechanism
    currently implements a kind of lazy access to arrays and hashes.</p>
<p class="Pp">Currently (as of perl version 5.004), use of the hash and array
    access functions requires the user to be aware of whether they are operating
    on &quot;normal&quot; hashes and arrays, or on their tied variants. The API
    may be changed to provide more transparent access to both tied and normal
    data types in future versions. [/MAYCHANGE]</p>
<p class="Pp">You would do well to understand that the TIEARRAY and TIEHASH
    interfaces are mere sugar to invoke some perl method calls while using the
    uniform hash and array syntax. The use of this sugar imposes some overhead
    (typically about two to four extra opcodes per FETCH/STORE operation, in
    addition to the creation of all the mortal variables required to invoke the
    methods). This overhead will be comparatively small if the TIE methods are
    themselves substantial, but if they are only a few statements long, the
    overhead will not be insignificant.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Localizing_changes"><a class="permalink" href="#Localizing_changes">Localizing
  changes</a></h2>
<p class="Pp">Perl has a very handy construction</p>
<p class="Pp"></p>
<pre>  {
    local $var = 2;
    ...
  }
</pre>
<p class="Pp">This construction is <i>approximately</i> equivalent to</p>
<p class="Pp"></p>
<pre>  {
    my $oldvar = $var;
    $var = 2;
    ...
    $var = $oldvar;
  }
</pre>
<p class="Pp">The biggest difference is that the first construction would
    reinstate the initial value of <span class="Li">$var</span>, irrespective of
    how control exits the block: <span class="Li">&quot;goto&quot;</span>,
    <span class="Li">&quot;return&quot;</span>,
    <span class="Li">&quot;die&quot;</span>/<span class="Li">&quot;eval&quot;</span>,
    etc. It is a little bit more efficient as well.</p>
<p class="Pp">There is a way to achieve a similar task from C via Perl API:
    create a <i>pseudo-block</i>, and arrange for some changes to be
    automatically undone at the end of it, either explicit, or via a non-local
    exit (via <b>die()</b>). A <i>block</i>-like construct is created by a pair
    of
    <span class="Li">&quot;ENTER&quot;</span>/<span class="Li">&quot;LEAVE&quot;</span>
    macros (see &quot;Returning a Scalar&quot; in perlcall). Such a construct
    may be created specially for some important localized task, or an existing
    one (like boundaries of enclosing Perl subroutine/block, or an existing pair
    for freeing TMPs) may be used. (In the second case the overhead of
    additional localization must be almost negligible.) Note that any XSUB is
    automatically enclosed in an
    <span class="Li">&quot;ENTER&quot;</span>/<span class="Li">&quot;LEAVE&quot;</span>
    pair.</p>
<p class="Pp">Inside such a <i>pseudo-block</i> the following service is
    available:</p>
<dl class="Bl-tag">
  <dt>&quot;SAVEINT(int i)&quot;</dt>
  <dd></dd>
  <dt>&quot;SAVEIV(IV i)&quot;</dt>
  <dd></dd>
  <dt>&quot;SAVEI32(I32 i)&quot;</dt>
  <dd></dd>
  <dt>&quot;SAVELONG(long i)&quot;</dt>
  <dd></dd>
  <dt>&quot;SAVEI8(I8 i)&quot;</dt>
  <dd></dd>
  <dt>&quot;SAVEI16(I16 i)&quot;</dt>
  <dd></dd>
  <dt>&quot;SAVEBOOL(int i)&quot;</dt>
  <dd>These macros arrange things to restore the value of integer variable
      <span class="Li">&quot;i&quot;</span> at the end of the enclosing
      <i>pseudo-block</i>.</dd>
  <dt id="SAVESPTR(s)"><a class="permalink" href="#SAVESPTR(s)">SAVESPTR(s)</a></dt>
  <dd></dd>
  <dt id="SAVEPPTR(p)"><a class="permalink" href="#SAVEPPTR(p)">SAVEPPTR(p)</a></dt>
  <dd>These macros arrange things to restore the value of pointers
      <span class="Li">&quot;s&quot;</span> and
      <span class="Li">&quot;p&quot;</span>.
      <span class="Li">&quot;s&quot;</span> must be a pointer of a type which
      survives conversion to <span class="Li">&quot;SV*&quot;</span> and back,
      <span class="Li">&quot;p&quot;</span> should be able to survive conversion
      to <span class="Li">&quot;char*&quot;</span> and back.</dd>
  <dt>&quot;SAVEFREESV(SV *sv)&quot;</dt>
  <dd>The refcount of <span class="Li">&quot;sv&quot;</span> will be decremented
      at the end of <i>pseudo-block</i>. This is similar to
      <span class="Li">&quot;sv_2mortal&quot;</span> in that it is also a
      mechanism for doing a delayed
      <span class="Li">&quot;SvREFCNT_dec&quot;</span>. However, while
      <span class="Li">&quot;sv_2mortal&quot;</span> extends the lifetime of
      <span class="Li">&quot;sv&quot;</span> until the beginning of the next
      statement, <span class="Li">&quot;SAVEFREESV&quot;</span> extends it until
      the end of the enclosing scope. These lifetimes can be wildly different.
    <p class="Pp">Also compare
        <span class="Li">&quot;SAVEMORTALIZESV&quot;</span>.</p>
  </dd>
  <dt>&quot;SAVEMORTALIZESV(SV *sv)&quot;</dt>
  <dd>Just like <span class="Li">&quot;SAVEFREESV&quot;</span>, but mortalizes
      <span class="Li">&quot;sv&quot;</span> at the end of the current scope
      instead of decrementing its reference count. This usually has the effect
      of keeping <span class="Li">&quot;sv&quot;</span> alive until the
      statement that called the currently live scope has finished
    executing.</dd>
  <dt>&quot;SAVEFREEOP(OP *op)&quot;</dt>
  <dd>The <span class="Li">&quot;OP *&quot;</span> is <b>op_free()</b>ed at the
      end of <i>pseudo-block</i>.</dd>
  <dt id="SAVEFREEPV(p)"><a class="permalink" href="#SAVEFREEPV(p)">SAVEFREEPV(p)</a></dt>
  <dd>The chunk of memory which is pointed to by
      <span class="Li">&quot;p&quot;</span> is <b>Safefree()</b>ed at the end of
      <i>pseudo-block</i>.</dd>
  <dt>&quot;SAVECLEARSV(SV *sv)&quot;</dt>
  <dd>Clears a slot in the current scratchpad which corresponds to
      <span class="Li">&quot;sv&quot;</span> at the end of
    <i>pseudo-block</i>.</dd>
  <dt>&quot;SAVEDELETE(HV *hv, char *key, I32 length)&quot;</dt>
  <dd>The key <span class="Li">&quot;key&quot;</span> of
      <span class="Li">&quot;hv&quot;</span> is deleted at the end of
      <i>pseudo-block</i>. The string pointed to by
      <span class="Li">&quot;key&quot;</span> is <b>Safefree()</b>ed. If one has
      a <i>key</i> in short-lived storage, the corresponding string may be
      reallocated like this:
    <p class="Pp"></p>
    <pre>  SAVEDELETE(PL_defstash, savepv(tmpbuf), strlen(tmpbuf));
    </pre>
  </dd>
  <dt>&quot;SAVEDESTRUCTOR(DESTRUCTORFUNC_NOCONTEXT_t f, void *p)&quot;</dt>
  <dd>At the end of <i>pseudo-block</i> the function
      <span class="Li">&quot;f&quot;</span> is called with the only argument
      <span class="Li">&quot;p&quot;</span>.</dd>
  <dt>&quot;SAVEDESTRUCTOR_X(DESTRUCTORFUNC_t f, void *p)&quot;</dt>
  <dd>At the end of <i>pseudo-block</i> the function
      <span class="Li">&quot;f&quot;</span> is called with the implicit context
      argument (if any), and <span class="Li">&quot;p&quot;</span>.</dd>
  <dt>&quot;SAVESTACK_POS()&quot;</dt>
  <dd>The current offset on the Perl internal stack (cf.
      <span class="Li">&quot;SP&quot;</span>) is restored at the end of
      <i>pseudo-block</i>.</dd>
</dl>
<p class="Pp">The following API list contains functions, thus one needs to
    provide pointers to the modifiable data explicitly (either C pointers, or
    Perlish <span class="Li">&quot;GV *&quot;</span>s). Where the above macros
    take <span class="Li">&quot;int&quot;</span>, a similar function takes
    <span class="Li">&quot;int *&quot;</span>.</p>
<p class="Pp">Other macros above have functions implementing them, but its
    probably best to just use the macro, and not those or the ones below.</p>
<dl class="Bl-tag">
  <dt>&quot;SV* save_scalar(GV *gv)&quot;</dt>
  <dd>Equivalent to Perl code <span class="Li">&quot;local
    $gv&quot;</span>.</dd>
  <dt>&quot;AV* save_ary(GV *gv)&quot;</dt>
  <dd></dd>
  <dt>&quot;HV* save_hash(GV *gv)&quot;</dt>
  <dd>Similar to <span class="Li">&quot;save_scalar&quot;</span>, but localize
      <span class="Li">@gv</span> and <span class="Li">%gv</span>.</dd>
  <dt>&quot;void save_item(SV *item)&quot;</dt>
  <dd>Duplicates the current value of <span class="Li">&quot;SV&quot;</span>. On
      the exit from the current
      <span class="Li">&quot;ENTER&quot;</span>/<span class="Li">&quot;LEAVE&quot;</span>
      <i>pseudo-block</i> the value of <span class="Li">&quot;SV&quot;</span>
      will be restored using the stored value. It doesn't handle magic. Use
      <span class="Li">&quot;save_scalar&quot;</span> if magic is affected.</dd>
  <dt>&quot;void save_list(SV **sarg, I32 maxsarg)&quot;</dt>
  <dd>A variant of <span class="Li">&quot;save_item&quot;</span> which takes
      multiple arguments via an array <span class="Li">&quot;sarg&quot;</span>
      of <span class="Li">&quot;SV*&quot;</span> of length
      <span class="Li">&quot;maxsarg&quot;</span>.</dd>
  <dt>&quot;SV* save_svref(SV **sptr)&quot;</dt>
  <dd>Similar to <span class="Li">&quot;save_scalar&quot;</span>, but will
      reinstate an <span class="Li">&quot;SV *&quot;</span>.</dd>
  <dt>&quot;void save_aptr(AV **aptr)&quot;</dt>
  <dd></dd>
  <dt>&quot;void save_hptr(HV **hptr)&quot;</dt>
  <dd>Similar to <span class="Li">&quot;save_svref&quot;</span>, but localize
      <span class="Li">&quot;AV *&quot;</span> and <span class="Li">&quot;HV
      *&quot;</span>.</dd>
</dl>
<p class="Pp">The <span class="Li">&quot;Alias&quot;</span> module implements
    localization of the basic types within the <i>caller's scope</i>. People who
    are interested in how to localize things in the containing scope should take
    a look there too.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="Subroutines"><a class="permalink" href="#Subroutines">Subroutines</a></h1>
<section class="Ss">
<h2 class="Ss" id="XSUBs_and_the_Argument_Stack"><a class="permalink" href="#XSUBs_and_the_Argument_Stack">XSUBs
  and the Argument Stack</a></h2>
<p class="Pp">The XSUB mechanism is a simple way for Perl programs to access C
    subroutines. An XSUB routine will have a stack that contains the arguments
    from the Perl program, and a way to map from the Perl data structures to a C
    equivalent.</p>
<p class="Pp">The stack arguments are accessible through the
    <span class="Li">ST(n)</span> macro, which returns the
    <span class="Li">&quot;n&quot;</span>'th stack argument. Argument 0 is the
    first argument passed in the Perl subroutine call. These arguments are
    <span class="Li">&quot;SV*&quot;</span>, and can be used anywhere an
    <span class="Li">&quot;SV*&quot;</span> is used.</p>
<p class="Pp">Most of the time, output from the C routine can be handled through
    use of the RETVAL and OUTPUT directives. However, there are some cases where
    the argument stack is not already long enough to handle all the return
    values. An example is the POSIX <b>tzname()</b> call, which takes no
    arguments, but returns two, the local time zone's standard and summer time
    abbreviations.</p>
<p class="Pp">To handle this situation, the PPCODE directive is used and the
    stack is extended using the macro:</p>
<p class="Pp"></p>
<pre>    EXTEND(SP, num);
</pre>
<p class="Pp">where <span class="Li">&quot;SP&quot;</span> is the macro that
    represents the local copy of the stack pointer, and
    <span class="Li">&quot;num&quot;</span> is the number of elements the stack
    should be extended by.</p>
<p class="Pp">Now that there is room on the stack, values can be pushed on it
    using <span class="Li">&quot;PUSHs&quot;</span> macro. The pushed values
    will often need to be &quot;mortal&quot; (See &quot;Reference Counts and
    Mortality&quot;):</p>
<p class="Pp"></p>
<pre>    PUSHs(sv_2mortal(newSViv(an_integer)))
    PUSHs(sv_2mortal(newSVuv(an_unsigned_integer)))
    PUSHs(sv_2mortal(newSVnv(a_double)))
    PUSHs(sv_2mortal(newSVpv(&quot;Some String&quot;,0)))
    /* Although the last example is better written as the more
     * efficient: */
    PUSHs(newSVpvs_flags(&quot;Some String&quot;, SVs_TEMP))
</pre>
<p class="Pp">And now the Perl program calling
    <span class="Li">&quot;tzname&quot;</span>, the two values will be assigned
    as in:</p>
<p class="Pp"></p>
<pre>    ($standard_abbrev, $summer_abbrev) = POSIX::tzname;
</pre>
<p class="Pp">An alternate (and possibly simpler) method to pushing values on
    the stack is to use the macro:</p>
<p class="Pp"></p>
<pre>    XPUSHs(SV*)
</pre>
<p class="Pp">This macro automatically adjusts the stack for you, if needed.
    Thus, you do not need to call <span class="Li">&quot;EXTEND&quot;</span> to
    extend the stack.</p>
<p class="Pp">Despite their suggestions in earlier versions of this document the
    macros <span class="Li">&quot;(X)PUSH[iunp]&quot;</span> are <i>not</i>
    suited to XSUBs which return multiple results. For that, either stick to the
    <span class="Li">&quot;(X)PUSHs&quot;</span> macros shown above, or use the
    new <span class="Li">&quot;m(X)PUSH[iunp]&quot;</span> macros instead; see
    &quot;Putting a C value on Perl stack&quot;.</p>
<p class="Pp">For more information, consult perlxs and perlxstut.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Autoloading_with_XSUBs"><a class="permalink" href="#Autoloading_with_XSUBs">Autoloading
  with XSUBs</a></h2>
<p class="Pp">If an AUTOLOAD routine is an XSUB, as with Perl subroutines, Perl
    puts the fully-qualified name of the autoloaded subroutine in the
    <span class="Li">$AUTOLOAD</span> variable of the XSUB's package.</p>
<p class="Pp">But it also puts the same information in certain fields of the
    XSUB itself:</p>
<p class="Pp"></p>
<pre>    HV *stash           = CvSTASH(cv);
    const char *subname = SvPVX(cv);
    STRLEN name_length  = SvCUR(cv); /* in bytes */
    U32 is_utf8         = SvUTF8(cv);
</pre>
<p class="Pp"><span class="Li">&quot;SvPVX(cv)&quot;</span> contains just the
    sub name itself, not including the package. For an AUTOLOAD routine in
    UNIVERSAL or one of its superclasses,
    <span class="Li">&quot;CvSTASH(cv)&quot;</span> returns NULL during a method
    call on a nonexistent package.</p>
<p class="Pp"><b>Note</b>: Setting <span class="Li">$AUTOLOAD</span> stopped
    working in 5.6.1, which did not support XS AUTOLOAD subs at all. Perl 5.8.0
    introduced the use of fields in the XSUB itself. Perl 5.16.0 restored the
    setting of <span class="Li">$AUTOLOAD</span>. If you need to support
    5.8-5.14, use the XSUB's fields.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Calling_Perl_Routines_from_within_C_Programs"><a class="permalink" href="#Calling_Perl_Routines_from_within_C_Programs">Calling
  Perl Routines from within C Programs</a></h2>
<p class="Pp">There are four routines that can be used to call a Perl subroutine
    from within a C program. These four are:</p>
<p class="Pp"></p>
<pre>    I32  call_sv(SV*, I32);
    I32  call_pv(const char*, I32);
    I32  call_method(const char*, I32);
    I32  call_argv(const char*, I32, char**);
</pre>
<p class="Pp">The routine most often used is
    <span class="Li">&quot;call_sv&quot;</span>. The
    <span class="Li">&quot;SV*&quot;</span> argument contains either the name of
    the Perl subroutine to be called, or a reference to the subroutine. The
    second argument consists of flags that control the context in which the
    subroutine is called, whether or not the subroutine is being passed
    arguments, how errors should be trapped, and how to treat return values.</p>
<p class="Pp">All four routines return the number of arguments that the
    subroutine returned on the Perl stack.</p>
<p class="Pp">These routines used to be called
    <span class="Li">&quot;perl_call_sv&quot;</span>, etc., before Perl v5.6.0,
    but those names are now deprecated; macros of the same name are provided for
    compatibility.</p>
<p class="Pp">When using any of these routines (except
    <span class="Li">&quot;call_argv&quot;</span>), the programmer must
    manipulate the Perl stack. These include the following macros and
  functions:</p>
<p class="Pp"></p>
<pre>    dSP
    SP
    PUSHMARK()
    PUTBACK
    SPAGAIN
    ENTER
    SAVETMPS
    FREETMPS
    LEAVE
    XPUSH*()
    POP*()
</pre>
<p class="Pp">For a detailed description of calling conventions from C to Perl,
    consult perlcall.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Putting_a_C_value_on_Perl_stack"><a class="permalink" href="#Putting_a_C_value_on_Perl_stack">Putting
  a C value on Perl stack</a></h2>
<p class="Pp">A lot of opcodes (this is an elementary operation in the internal
    perl stack machine) put an SV* on the stack. However, as an optimization the
    corresponding SV is (usually) not recreated each time. The opcodes reuse
    specially assigned SVs (<i>target</i>s) which are (as a corollary) not
    constantly freed/created.</p>
<p class="Pp">Each of the targets is created only once (but see
    &quot;Scratchpads and recursion&quot; below), and when an opcode needs to
    put an integer, a double, or a string on stack, it just sets the
    corresponding parts of its <i>target</i> and puts the <i>target</i> on
    stack.</p>
<p class="Pp">The macro to put this target on stack is
    <span class="Li">&quot;PUSHTARG&quot;</span>, and it is directly used in
    some opcodes, as well as indirectly in zillions of others, which use it via
    <span class="Li">&quot;(X)PUSH[iunp]&quot;</span>.</p>
<p class="Pp">Because the target is reused, you must be careful when pushing
    multiple values on the stack. The following code will not do what you
  think:</p>
<p class="Pp"></p>
<pre>    XPUSHi(10);
    XPUSHi(20);
</pre>
<p class="Pp">This translates as &quot;set
    <span class="Li">&quot;TARG&quot;</span> to 10, push a pointer to
    <span class="Li">&quot;TARG&quot;</span> onto the stack; set
    <span class="Li">&quot;TARG&quot;</span> to 20, push a pointer to
    <span class="Li">&quot;TARG&quot;</span> onto the stack&quot;. At the end of
    the operation, the stack does not contain the values 10 and 20, but actually
    contains two pointers to <span class="Li">&quot;TARG&quot;</span>, which we
    have set to 20.</p>
<p class="Pp">If you need to push multiple different values then you should
    either use the <span class="Li">&quot;(X)PUSHs&quot;</span> macros, or else
    use the new <span class="Li">&quot;m(X)PUSH[iunp]&quot;</span> macros, none
    of which make use of <span class="Li">&quot;TARG&quot;</span>. The
    <span class="Li">&quot;(X)PUSHs&quot;</span> macros simply push an SV* on
    the stack, which, as noted under &quot;XSUBs and the Argument Stack&quot;,
    will often need to be &quot;mortal&quot;. The new
    <span class="Li">&quot;m(X)PUSH[iunp]&quot;</span> macros make this a little
    easier to achieve by creating a new mortal for you (via
    <span class="Li">&quot;(X)PUSHmortal&quot;</span>), pushing that onto the
    stack (extending it if necessary in the case of the
    <span class="Li">&quot;mXPUSH[iunp]&quot;</span> macros), and then setting
    its value. Thus, instead of writing this to &quot;fix&quot; the example
    above:</p>
<p class="Pp"></p>
<pre>    XPUSHs(sv_2mortal(newSViv(10)))
    XPUSHs(sv_2mortal(newSViv(20)))
</pre>
<p class="Pp">you can simply write:</p>
<p class="Pp"></p>
<pre>    mXPUSHi(10)
    mXPUSHi(20)
</pre>
<p class="Pp">On a related note, if you do use
    <span class="Li">&quot;(X)PUSH[iunp]&quot;</span>, then you're going to need
    a <span class="Li">&quot;dTARG&quot;</span> in your variable declarations so
    that the <span class="Li">&quot;*PUSH*&quot;</span> macros can make use of
    the local variable <span class="Li">&quot;TARG&quot;</span>. See also
    <span class="Li">&quot;dTARGET&quot;</span> and
    <span class="Li">&quot;dXSTARG&quot;</span>.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Scratchpads"><a class="permalink" href="#Scratchpads">Scratchpads</a></h2>
<p class="Pp">The question remains on when the SVs which are <i>target</i>s for
    opcodes are created. The answer is that they are created when the current
    unit--a subroutine or a file (for opcodes for statements outside of
    subroutines)--is compiled. During this time a special anonymous Perl array
    is created, which is called a scratchpad for the current unit.</p>
<p class="Pp">A scratchpad keeps SVs which are lexicals for the current unit and
    are targets for opcodes. A previous version of this document stated that one
    can deduce that an SV lives on a scratchpad by looking on its flags:
    lexicals have <span class="Li">&quot;SVs_PADMY&quot;</span> set, and
    <i>target</i>s have <span class="Li">&quot;SVs_PADTMP&quot;</span> set. But
    this has never been fully true.
    <span class="Li">&quot;SVs_PADMY&quot;</span> could be set on a variable
    that no longer resides in any pad. While <i>target</i>s do have
    <span class="Li">&quot;SVs_PADTMP&quot;</span> set, it can also be set on
    variables that have never resided in a pad, but nonetheless act like
    <i>target</i>s. As of perl 5.21.5, the
    <span class="Li">&quot;SVs_PADMY&quot;</span> flag is no longer used and is
    defined as 0. <span class="Li">&quot;SvPADMY()&quot;</span> now returns true
    for anything without <span class="Li">&quot;SVs_PADTMP&quot;</span>.</p>
<p class="Pp">The correspondence between OPs and <i>target</i>s is not 1-to-1.
    Different OPs in the compile tree of the unit can use the same target, if
    this would not conflict with the expected life of the temporary.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Scratchpads_and_recursion"><a class="permalink" href="#Scratchpads_and_recursion">Scratchpads
  and recursion</a></h2>
<p class="Pp">In fact it is not 100% true that a compiled unit contains a
    pointer to the scratchpad AV. In fact it contains a pointer to an AV of
    (initially) one element, and this element is the scratchpad AV. Why do we
    need an extra level of indirection?</p>
<p class="Pp">The answer is <b>recursion</b>, and maybe <b>threads</b>. Both
    these can create several execution pointers going into the same subroutine.
    For the subroutine-child not write over the temporaries for the
    subroutine-parent (lifespan of which covers the call to the child), the
    parent and the child should have different scratchpads. (<i>And</i> the
    lexicals should be separate anyway!)</p>
<p class="Pp">So each subroutine is born with an array of scratchpads (of length
    1). On each entry to the subroutine it is checked that the current depth of
    the recursion is not more than the length of this array, and if it is, new
    scratchpad is created and pushed into the array.</p>
<p class="Pp">The <i>target</i>s on this scratchpad are
    <span class="Li">&quot;undef&quot;</span>s, but they are already marked with
    correct flags.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="Memory_Allocation"><a class="permalink" href="#Memory_Allocation">Memory
  Allocation</a></h1>
<section class="Ss">
<h2 class="Ss" id="Allocation"><a class="permalink" href="#Allocation">Allocation</a></h2>
<p class="Pp">All memory meant to be used with the Perl API functions should be
    manipulated using the macros described in this section. The macros provide
    the necessary transparency between differences in the actual malloc
    implementation that is used within perl.</p>
<p class="Pp">The following three macros are used to initially allocate memory
  :</p>
<p class="Pp"></p>
<pre>    Newx(pointer, number, type);
    Newxc(pointer, number, type, cast);
    Newxz(pointer, number, type);
</pre>
<p class="Pp">The first argument <span class="Li">&quot;pointer&quot;</span>
    should be the name of a variable that will point to the newly allocated
    memory.</p>
<p class="Pp">The second and third arguments
    <span class="Li">&quot;number&quot;</span> and
    <span class="Li">&quot;type&quot;</span> specify how many of the specified
    type of data structure should be allocated. The argument
    <span class="Li">&quot;type&quot;</span> is passed to
    <span class="Li">&quot;sizeof&quot;</span>. The final argument to
    <span class="Li">&quot;Newxc&quot;</span>,
    <span class="Li">&quot;cast&quot;</span>, should be used if the
    <span class="Li">&quot;pointer&quot;</span> argument is different from the
    <span class="Li">&quot;type&quot;</span> argument.</p>
<p class="Pp">Unlike the <span class="Li">&quot;Newx&quot;</span> and
    <span class="Li">&quot;Newxc&quot;</span> macros, the
    <span class="Li">&quot;Newxz&quot;</span> macro calls
    <span class="Li">&quot;memzero&quot;</span> to zero out all the newly
    allocated memory.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Reallocation"><a class="permalink" href="#Reallocation">Reallocation</a></h2>
<pre>    Renew(pointer, number, type);
    Renewc(pointer, number, type, cast);
    Safefree(pointer)
</pre>
<p class="Pp">These three macros are used to change a memory buffer size or to
    free a piece of memory no longer needed. The arguments to
    <span class="Li">&quot;Renew&quot;</span> and
    <span class="Li">&quot;Renewc&quot;</span> match those of
    <span class="Li">&quot;New&quot;</span> and
    <span class="Li">&quot;Newc&quot;</span> with the exception of not needing
    the &quot;magic cookie&quot; argument.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Moving"><a class="permalink" href="#Moving">Moving</a></h2>
<pre>    Move(source, dest, number, type);
    Copy(source, dest, number, type);
    Zero(dest, number, type);
</pre>
<p class="Pp">These three macros are used to move, copy, or zero out previously
    allocated memory. The <span class="Li">&quot;source&quot;</span> and
    <span class="Li">&quot;dest&quot;</span> arguments point to the source and
    destination starting points. Perl will move, copy, or zero out
    <span class="Li">&quot;number&quot;</span> instances of the size of the
    <span class="Li">&quot;type&quot;</span> data structure (using the
    <span class="Li">&quot;sizeof&quot;</span> function).</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="PerlIO"><a class="permalink" href="#PerlIO">PerlIO</a></h1>
<p class="Pp">The most recent development releases of Perl have been
    experimenting with removing Perl's dependency on the &quot;normal&quot;
    standard I/O suite and allowing other stdio implementations to be used. This
    involves creating a new abstraction layer that then calls whichever
    implementation of stdio Perl was compiled with. All XSUBs should now use the
    functions in the PerlIO abstraction layer and not make any assumptions about
    what kind of stdio is being used.</p>
<p class="Pp">For a complete description of the PerlIO abstraction, consult
    perlapio.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="Compiled_code"><a class="permalink" href="#Compiled_code">Compiled
  code</a></h1>
<section class="Ss">
<h2 class="Ss" id="Code_tree"><a class="permalink" href="#Code_tree">Code
  tree</a></h2>
<p class="Pp">Here we describe the internal form your code is converted to by
    Perl. Start with a simple example:</p>
<p class="Pp"></p>
<pre>  $a = $b + $c;
</pre>
<p class="Pp">This is converted to a tree similar to this one:</p>
<p class="Pp"></p>
<pre>             assign-to
           /           \
          +             $a
        /   \
      $b     $c
</pre>
<p class="Pp">(but slightly more complicated). This tree reflects the way Perl
    parsed your code, but has nothing to do with the execution order. There is
    an additional &quot;thread&quot; going through the nodes of the tree which
    shows the order of execution of the nodes. In our simplified example above
    it looks like:</p>
<p class="Pp"></p>
<pre>     $b ---&gt; $c ---&gt; + ---&gt; $a ---&gt; assign-to
</pre>
<p class="Pp">But with the actual compile tree for <span class="Li">&quot;$a =
    $b + $c&quot;</span> it is different: some nodes <i>optimized away</i>. As a
    corollary, though the actual tree contains more nodes than our simplified
    example, the execution order is the same as in our example.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Examining_the_tree"><a class="permalink" href="#Examining_the_tree">Examining
  the tree</a></h2>
<p class="Pp">If you have your perl compiled for debugging (usually done with
    <span class="Li">&quot;-DDEBUGGING&quot;</span> on the
    <span class="Li">&quot;Configure&quot;</span> command line), you may examine
    the compiled tree by specifying <span class="Li">&quot;-Dx&quot;</span> on
    the Perl command line. The output takes several lines per node, and for
    <span class="Li">&quot;$b+$c&quot;</span> it looks like this:</p>
<p class="Pp"></p>
<pre>    5           TYPE = add  ===&gt; 6
                TARG = 1
                FLAGS = (SCALAR,KIDS)
                {
                    TYPE = null  ===&gt; (4)
                      (was rv2sv)
                    FLAGS = (SCALAR,KIDS)
                    {
    3                   TYPE = gvsv  ===&gt; 4
                        FLAGS = (SCALAR)
                        GV = main::b
                    }
                }
                {
                    TYPE = null  ===&gt; (5)
                      (was rv2sv)
                    FLAGS = (SCALAR,KIDS)
                    {
    4                   TYPE = gvsv  ===&gt; 5
                        FLAGS = (SCALAR)
                        GV = main::c
                    }
                }
</pre>
<p class="Pp">This tree has 5 nodes (one per
    <span class="Li">&quot;TYPE&quot;</span> specifier), only 3 of them are not
    optimized away (one per number in the left column). The immediate children
    of the given node correspond to <span class="Li">&quot;{}&quot;</span> pairs
    on the same level of indentation, thus this listing corresponds to the
  tree:</p>
<p class="Pp"></p>
<pre>                   add
                 /     \
               null    null
                |       |
               gvsv    gvsv
</pre>
<p class="Pp">The execution order is indicated by
    <span class="Li">&quot;===&gt;&quot;</span> marks, thus it is
    <span class="Li">&quot;3</span> <span class="Li">4 5 6&quot;</span> (node
    <span class="Li">6</span> is not included into above listing), i.e.,
    <span class="Li">&quot;gvsv gvsv add whatever&quot;</span>.</p>
<p class="Pp">Each of these nodes represents an op, a fundamental operation
    inside the Perl core. The code which implements each operation can be found
    in the <i>pp*.c</i> files; the function which implements the op with type
    <span class="Li">&quot;gvsv&quot;</span> is
    <span class="Li">&quot;pp_gvsv&quot;</span>, and so on. As the tree above
    shows, different ops have different numbers of children:
    <span class="Li">&quot;add&quot;</span> is a binary operator, as one would
    expect, and so has two children. To accommodate the various different
    numbers of children, there are various types of op data structure, and they
    link together in different ways.</p>
<p class="Pp">The simplest type of op structure is
    <span class="Li">&quot;OP&quot;</span>: this has no children. Unary
    operators, <span class="Li">&quot;UNOP&quot;</span>s, have one child, and
    this is pointed to by the <span class="Li">&quot;op_first&quot;</span>
    field. Binary operators (<span class="Li">&quot;BINOP&quot;</span>s) have
    not only an <span class="Li">&quot;op_first&quot;</span> field but also an
    <span class="Li">&quot;op_last&quot;</span> field. The most complex type of
    op is a <span class="Li">&quot;LISTOP&quot;</span>, which has any number of
    children. In this case, the first child is pointed to by
    <span class="Li">&quot;op_first&quot;</span> and the last child by
    <span class="Li">&quot;op_last&quot;</span>. The children in between can be
    found by iteratively following the
    <span class="Li">&quot;OpSIBLING&quot;</span> pointer from the first child
    to the last (but see below).</p>
<p class="Pp">There are also some other op types: a
    <span class="Li">&quot;PMOP&quot;</span> holds a regular expression, and has
    no children, and a <span class="Li">&quot;LOOP&quot;</span> may or may not
    have children. If the <span class="Li">&quot;op_children&quot;</span> field
    is non-zero, it behaves like a <span class="Li">&quot;LISTOP&quot;</span>.
    To complicate matters, if a <span class="Li">&quot;UNOP&quot;</span> is
    actually a <span class="Li">&quot;null&quot;</span> op after optimization
    (see &quot;Compile pass 2: context propagation&quot;) it will still have
    children in accordance with its former type.</p>
<p class="Pp">Finally, there is a <span class="Li">&quot;LOGOP&quot;</span>, or
    logic op. Like a <span class="Li">&quot;LISTOP&quot;</span>, this has one or
    more children, but it doesn't have an
    <span class="Li">&quot;op_last&quot;</span> field: so you have to follow
    <span class="Li">&quot;op_first&quot;</span> and then the
    <span class="Li">&quot;OpSIBLING&quot;</span> chain itself to find the last
    child. Instead it has an <span class="Li">&quot;op_other&quot;</span> field,
    which is comparable to the <span class="Li">&quot;op_next&quot;</span> field
    described below, and represents an alternate execution path. Operators like
    <span class="Li">&quot;and&quot;</span>,
    <span class="Li">&quot;or&quot;</span> and
    <span class="Li">&quot;?&quot;</span> are
    <span class="Li">&quot;LOGOP&quot;</span>s. Note that in general,
    <span class="Li">&quot;op_other&quot;</span> may not point to any of the
    direct children of the <span class="Li">&quot;LOGOP&quot;</span>.</p>
<p class="Pp">Starting in version 5.21.2, perls built with the experimental
    define <span class="Li">&quot;-DPERL_OP_PARENT&quot;</span> add an extra
    boolean flag for each op, <span class="Li">&quot;op_moresib&quot;</span>.
    When not set, this indicates that this is the last op in an
    <span class="Li">&quot;OpSIBLING&quot;</span> chain. This frees up the
    <span class="Li">&quot;op_sibling&quot;</span> field on the last sibling to
    point back to the parent op. Under this build, that field is also renamed
    <span class="Li">&quot;op_sibparent&quot;</span> to reflect its joint role.
    The macro <span class="Li">OpSIBLING(o)</span> wraps this special behaviour,
    and always returns NULL on the last sibling. With this build the
    <span class="Li">op_parent(o)</span> function can be used to find the parent
    of any op. Thus for forward compatibility, you should always use the
    <span class="Li">OpSIBLING(o)</span> macro rather than accessing
    <span class="Li">&quot;op_sibling&quot;</span> directly.</p>
<p class="Pp">Another way to examine the tree is to use a compiler back-end
    module, such as B::Concise.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Compile_pass_1:_check_routines"><a class="permalink" href="#Compile_pass_1:_check_routines">Compile
  pass 1: check routines</a></h2>
<p class="Pp">The tree is created by the compiler while <i>yacc</i> code feeds
    it the constructions it recognizes. Since <i>yacc</i> works bottom-up, so
    does the first pass of perl compilation.</p>
<p class="Pp">What makes this pass interesting for perl developers is that some
    optimization may be performed on this pass. This is optimization by
    so-called &quot;check routines&quot;. The correspondence between node names
    and corresponding check routines is described in <i>opcode.pl</i> (do not
    forget to run <span class="Li">&quot;make regen_headers&quot;</span> if you
    modify this file).</p>
<p class="Pp">A check routine is called when the node is fully constructed
    except for the execution-order thread. Since at this time there are no
    back-links to the currently constructed node, one can do most any operation
    to the top-level node, including freeing it and/or creating new nodes
    above/below it.</p>
<p class="Pp">The check routine returns the node which should be inserted into
    the tree (if the top-level node was not modified, check routine returns its
    argument).</p>
<p class="Pp">By convention, check routines have names
    <span class="Li">&quot;ck_*&quot;</span>. They are usually called from
    <span class="Li">&quot;new*OP&quot;</span> subroutines (or
    <span class="Li">&quot;convert&quot;</span>) (which in turn are called from
    <i>perly.y</i>).</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Compile_pass_1a:_constant_folding"><a class="permalink" href="#Compile_pass_1a:_constant_folding">Compile
  pass 1a: constant folding</a></h2>
<p class="Pp">Immediately after the check routine is called the returned node is
    checked for being compile-time executable. If it is (the value is judged to
    be constant) it is immediately executed, and a <i>constant</i> node with the
    &quot;return value&quot; of the corresponding subtree is substituted
    instead. The subtree is deleted.</p>
<p class="Pp">If constant folding was not performed, the execution-order thread
    is created.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Compile_pass_2:_context_propagation"><a class="permalink" href="#Compile_pass_2:_context_propagation">Compile
  pass 2: context propagation</a></h2>
<p class="Pp">When a context for a part of compile tree is known, it is
    propagated down through the tree. At this time the context can have 5 values
    (instead of 2 for runtime context): void, boolean, scalar, list, and lvalue.
    In contrast with the pass 1 this pass is processed from top to bottom: a
    node's context determines the context for its children.</p>
<p class="Pp">Additional context-dependent optimizations are performed at this
    time. Since at this moment the compile tree contains back-references (via
    &quot;thread&quot; pointers), nodes cannot be <b>free()</b>d now. To allow
    optimized-away nodes at this stage, such nodes are <b>null()</b>ified
    instead of <b>free()</b>ing (i.e. their type is changed to OP_NULL).</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Compile_pass_3:_peephole_optimization"><a class="permalink" href="#Compile_pass_3:_peephole_optimization">Compile
  pass 3: peephole optimization</a></h2>
<p class="Pp">After the compile tree for a subroutine (or for an
    <span class="Li">&quot;eval&quot;</span> or a file) is created, an
    additional pass over the code is performed. This pass is neither top-down or
    bottom-up, but in the execution order (with additional complications for
    conditionals). Optimizations performed at this stage are subject to the same
    restrictions as in the pass 2.</p>
<p class="Pp">Peephole optimizations are done by calling the function pointed to
    by the global variable <span class="Li">&quot;PL_peepp&quot;</span>. By
    default, <span class="Li">&quot;PL_peepp&quot;</span> just calls the
    function pointed to by the global variable
    <span class="Li">&quot;PL_rpeepp&quot;</span>. By default, that performs
    some basic op fixups and optimisations along the execution-order op chain,
    and recursively calls <span class="Li">&quot;PL_rpeepp&quot;</span> for each
    side chain of ops (resulting from conditionals). Extensions may provide
    additional optimisations or fixups, hooking into either the per-subroutine
    or recursive stage, like this:</p>
<p class="Pp"></p>
<pre>    static peep_t prev_peepp;
    static void my_peep(pTHX_ OP *o)
    {
        /* custom per-subroutine optimisation goes here */
        prev_peepp(aTHX_ o);
        /* custom per-subroutine optimisation may also go here */
    }
    BOOT:
        prev_peepp = PL_peepp;
        PL_peepp = my_peep;
    static peep_t prev_rpeepp;
    static void my_rpeep(pTHX_ OP *first)
    {
        OP *o = first, *t = first;
        for(; o = o-&gt;op_next, t = t-&gt;op_next) {
            /* custom per-op optimisation goes here */
            o = o-&gt;op_next;
            if (!o || o == t) break;
            /* custom per-op optimisation goes AND here */
        }
        prev_rpeepp(aTHX_ orig_o);
    }
    BOOT:
        prev_rpeepp = PL_rpeepp;
        PL_rpeepp = my_rpeep;
</pre>
</section>
<section class="Ss">
<h2 class="Ss" id="Pluggable_runops"><a class="permalink" href="#Pluggable_runops">Pluggable
  runops</a></h2>
<p class="Pp">The compile tree is executed in a runops function. There are two
    runops functions, in <i>run.c</i> and in <i>dump.c</i>.
    <span class="Li">&quot;Perl_runops_debug&quot;</span> is used with DEBUGGING
    and <span class="Li">&quot;Perl_runops_standard&quot;</span> is used
    otherwise. For fine control over the execution of the compile tree it is
    possible to provide your own runops function.</p>
<p class="Pp">It's probably best to copy one of the existing runops functions
    and change it to suit your needs. Then, in the BOOT section of your XS file,
    add the line:</p>
<p class="Pp"></p>
<pre>  PL_runops = my_runops;
</pre>
<p class="Pp">This function should be as efficient as possible to keep your
    programs running as fast as possible.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Compile-time_scope_hooks"><a class="permalink" href="#Compile-time_scope_hooks">Compile-time
  scope hooks</a></h2>
<p class="Pp">As of perl 5.14 it is possible to hook into the compile-time
    lexical scope mechanism using
    <span class="Li">&quot;Perl_blockhook_register&quot;</span>. This is used
    like this:</p>
<p class="Pp"></p>
<pre>    STATIC void my_start_hook(pTHX_ int full);
    STATIC BHK my_hooks;
    BOOT:
        BhkENTRY_set(&amp;my_hooks, bhk_start, my_start_hook);
        Perl_blockhook_register(aTHX_ &amp;my_hooks);
</pre>
<p class="Pp">This will arrange to have
    <span class="Li">&quot;my_start_hook&quot;</span> called at the start of
    compiling every lexical scope. The available hooks are:</p>
<dl class="Bl-tag">
  <dt>&quot;void bhk_start(pTHX_ int full)&quot;</dt>
  <dd>This is called just after starting a new lexical scope. Note that Perl
      code like
    <p class="Pp"></p>
    <pre>    if ($x) { ... }
    </pre>
    <p class="Pp">creates two scopes: the first starts at the
        <span class="Li">&quot;(&quot;</span> and has
        <span class="Li">&quot;full == 1&quot;</span>, the second starts at the
        <span class="Li">&quot;{&quot;</span> and has
        <span class="Li">&quot;full == 0&quot;</span>. Both end at the
        <span class="Li">&quot;}&quot;</span>, so calls to
        <span class="Li">&quot;start&quot;</span> and
        <span class="Li">&quot;pre&quot;</span>/<span class="Li">&quot;post_end&quot;</span>
        will match. Anything pushed onto the save stack by this hook will be
        popped just before the scope ends (between the
        <span class="Li">&quot;pre_&quot;</span> and
        <span class="Li">&quot;post_end&quot;</span> hooks, in fact).</p>
  </dd>
  <dt>&quot;void bhk_pre_end(pTHX_ OP **o)&quot;</dt>
  <dd>This is called at the end of a lexical scope, just before unwinding the
      stack. <i>o</i> is the root of the optree representing the scope; it is a
      double pointer so you can replace the OP if you need to.</dd>
  <dt>&quot;void bhk_post_end(pTHX_ OP **o)&quot;</dt>
  <dd>This is called at the end of a lexical scope, just after unwinding the
      stack. <i>o</i> is as above. Note that it is possible for calls to
      <span class="Li">&quot;pre_&quot;</span> and
      <span class="Li">&quot;post_end&quot;</span> to nest, if there is
      something on the save stack that calls string eval.</dd>
  <dt>&quot;void bhk_eval(pTHX_ OP *const o)&quot;</dt>
  <dd>This is called just before starting to compile an
      <span class="Li">&quot;eval STRING&quot;</span>,
      <span class="Li">&quot;do</span> <span class="Li">FILE&quot;</span>,
      <span class="Li">&quot;require&quot;</span> or
      <span class="Li">&quot;use&quot;</span>, after the eval has been set up.
      <i>o</i> is the OP that requested the eval, and will normally be an
      <span class="Li">&quot;OP_ENTEREVAL&quot;</span>,
      <span class="Li">&quot;OP_DOFILE&quot;</span> or
      <span class="Li">&quot;OP_REQUIRE&quot;</span>.</dd>
</dl>
<p class="Pp">Once you have your hook functions, you need a
    <span class="Li">&quot;BHK&quot;</span> structure to put them in. It's best
    to allocate it statically, since there is no way to free it once it's
    registered. The function pointers should be inserted into this structure
    using the <span class="Li">&quot;BhkENTRY_set&quot;</span> macro, which will
    also set flags indicating which entries are valid. If you do need to
    allocate your <span class="Li">&quot;BHK&quot;</span> dynamically for some
    reason, be sure to zero it before you start.</p>
<p class="Pp">Once registered, there is no mechanism to switch these hooks off,
    so if that is necessary you will need to do this yourself. An entry in
    <span class="Li">&quot;%^H&quot;</span> is probably the best way, so the
    effect is lexically scoped; however it is also possible to use the
    <span class="Li">&quot;BhkDISABLE&quot;</span> and
    <span class="Li">&quot;BhkENABLE&quot;</span> macros to temporarily switch
    entries on and off. You should also be aware that generally speaking at
    least one scope will have opened before your extension is loaded, so you
    will see some
    <span class="Li">&quot;pre&quot;</span>/<span class="Li">&quot;post_end&quot;</span>
    pairs that didn't have a matching
  <span class="Li">&quot;start&quot;</span>.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="Examining_internal_data_structures_with_the__dump__functions"><a class="permalink" href="#Examining_internal_data_structures_with_the__dump__functions">Examining
  internal data structures with the &quot;dump&quot; functions</a></h1>
<p class="Pp">To aid debugging, the source file <i>dump.c</i> contains a number
    of functions which produce formatted output of internal data structures.</p>
<p class="Pp">The most commonly used of these functions is
    <span class="Li">&quot;Perl_sv_dump&quot;</span>; it's used for dumping SVs,
    AVs, HVs, and CVs. The <span class="Li">&quot;Devel::Peek&quot;</span>
    module calls <span class="Li">&quot;sv_dump&quot;</span> to produce
    debugging output from Perl-space, so users of that module should already be
    familiar with its format.</p>
<p class="Pp"><span class="Li">&quot;Perl_op_dump&quot;</span> can be used to
    dump an <span class="Li">&quot;OP&quot;</span> structure or any of its
    derivatives, and produces output similar to <span class="Li">&quot;perl
    -Dx&quot;</span>; in fact,
    <span class="Li">&quot;Perl_dump_eval&quot;</span> will dump the main root
    of the code being evaluated, exactly like
    <span class="Li">&quot;-Dx&quot;</span>.</p>
<p class="Pp">Other useful functions are
    <span class="Li">&quot;Perl_dump_sub&quot;</span>, which turns a
    <span class="Li">&quot;GV&quot;</span> into an op tree,
    <span class="Li">&quot;Perl_dump_packsubs&quot;</span> which calls
    <span class="Li">&quot;Perl_dump_sub&quot;</span> on all the subroutines in
    a package like so: (Thankfully, these are all xsubs, so there is no op
  tree)</p>
<p class="Pp"></p>
<pre>    (gdb) print Perl_dump_packsubs(PL_defstash)
    SUB attributes::bootstrap = (xsub 0x811fedc 0)
    SUB UNIVERSAL::can = (xsub 0x811f50c 0)
    SUB UNIVERSAL::isa = (xsub 0x811f304 0)
    SUB UNIVERSAL::VERSION = (xsub 0x811f7ac 0)
    SUB DynaLoader::boot_DynaLoader = (xsub 0x805b188 0)
</pre>
<p class="Pp">and <span class="Li">&quot;Perl_dump_all&quot;</span>, which dumps
    all the subroutines in the stash and the op tree of the main root.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="How_multiple_interpreters_and_concurrency_are_supported"><a class="permalink" href="#How_multiple_interpreters_and_concurrency_are_supported">How
  multiple interpreters and concurrency are supported</a></h1>
<section class="Ss">
<h2 class="Ss" id="Background_and_"><a class="permalink" href="#Background_and_">Background
  and PERL_IMPLICIT_CONTEXT</a></h2>
<p class="Pp">The Perl interpreter can be regarded as a closed box: it has an
    API for feeding it code or otherwise making it do things, but it also has
    functions for its own use. This smells a lot like an object, and there is a
    way for you to build Perl so that you can have multiple interpreters, with
    one interpreter represented either as a C structure, or inside a
    thread-specific structure. These structures contain all the context, the
    state of that interpreter.</p>
<p class="Pp">The macro that controls the major Perl build flavor is
    MULTIPLICITY. The MULTIPLICITY build has a C structure that packages all the
    interpreter state. With multiplicity-enabled perls, PERL_IMPLICIT_CONTEXT is
    also normally defined, and enables the support for passing in a
    &quot;hidden&quot; first argument that represents all three data structures.
    MULTIPLICITY makes multi-threaded perls possible (with the ithreads
    threading model, related to the macro USE_ITHREADS.)</p>
<p class="Pp">To see whether you have non-const data you can use a BSD (or GNU)
    compatible <span class="Li">&quot;nm&quot;</span>:</p>
<p class="Pp"></p>
<pre>  nm libperl.a | grep -v ' [TURtr] '
</pre>
<p class="Pp">If this displays any <span class="Li">&quot;D&quot;</span> or
    <span class="Li">&quot;d&quot;</span> symbols (or possibly
    <span class="Li">&quot;C&quot;</span> or
    <span class="Li">&quot;c&quot;</span>), you have non-const data. The symbols
    the <span class="Li">&quot;grep&quot;</span> removed are as follows:
    <span class="Li">&quot;Tt&quot;</span> are <i>text</i>, or code, the
    <span class="Li">&quot;Rr&quot;</span> are <i>read-only</i> (const) data,
    and the <span class="Li">&quot;U&quot;</span> is &lt;undefined&gt;, external
    symbols referred to.</p>
<p class="Pp">The test <i>t/porting/libperl.t</i> does this kind of symbol
    sanity checking on <span class="Li">&quot;libperl.a&quot;</span>.</p>
<p class="Pp">All this obviously requires a way for the Perl internal functions
    to be either subroutines taking some kind of structure as the first
    argument, or subroutines taking nothing as the first argument. To enable
    these two very different ways of building the interpreter, the Perl source
    (as it does in so many other situations) makes heavy use of macros and
    subroutine naming conventions.</p>
<p class="Pp">First problem: deciding which functions will be public API
    functions and which will be private. All functions whose names begin
    <span class="Li">&quot;S_&quot;</span> are private (think &quot;S&quot; for
    &quot;secret&quot; or &quot;static&quot;). All other functions begin with
    &quot;Perl_&quot;, but just because a function begins with &quot;Perl_&quot;
    does not mean it is part of the API. (See &quot;Internal Functions&quot;.)
    The easiest way to be <b>sure</b> a function is part of the API is to find
    its entry in perlapi. If it exists in perlapi, it's part of the API. If it
    doesn't, and you think it should be (i.e., you need it for your extension),
    submit an issue at &lt;https://github.com/Perl/perl5/issues&gt; explaining
    why you think it should be.</p>
<p class="Pp">Second problem: there must be a syntax so that the same subroutine
    declarations and calls can pass a structure as their first argument, or pass
    nothing. To solve this, the subroutines are named and declared in a
    particular way. Here's a typical start of a static function used within the
    Perl guts:</p>
<p class="Pp"></p>
<pre>  STATIC void
  S_incline(pTHX_ char *s)
</pre>
<p class="Pp">STATIC becomes &quot;static&quot; in C, and may be #define'd to
    nothing in some configurations in the future.</p>
<p class="Pp">A public function (i.e. part of the internal API, but not
    necessarily sanctioned for use in extensions) begins like this:</p>
<p class="Pp"></p>
<pre>  void
  Perl_sv_setiv(pTHX_ SV* dsv, IV num)
</pre>
<p class="Pp"><span class="Li">&quot;pTHX_&quot;</span> is one of a number of
    macros (in <i>perl.h</i>) that hide the details of the interpreter's
    context. THX stands for &quot;thread&quot;, &quot;this&quot;, or
    &quot;thingy&quot;, as the case may be. (And no, George Lucas is not
    involved. :-) The first character could be 'p' for a <b>p</b>rototype, 'a'
    for <b>a</b>rgument, or 'd' for <b>d</b>eclaration, so we have
    <span class="Li">&quot;pTHX&quot;</span>,
    <span class="Li">&quot;aTHX&quot;</span> and
    <span class="Li">&quot;dTHX&quot;</span>, and their variants.</p>
<p class="Pp">When Perl is built without options that set PERL_IMPLICIT_CONTEXT,
    there is no first argument containing the interpreter's context. The
    trailing underscore in the pTHX_ macro indicates that the macro expansion
    needs a comma after the context argument because other arguments follow it.
    If PERL_IMPLICIT_CONTEXT is not defined, pTHX_ will be ignored, and the
    subroutine is not prototyped to take the extra argument. The form of the
    macro without the trailing underscore is used when there are no additional
    explicit arguments.</p>
<p class="Pp">When a core function calls another, it must pass the context. This
    is normally hidden via macros. Consider
    <span class="Li">&quot;sv_setiv&quot;</span>. It expands into something like
    this:</p>
<p class="Pp"></p>
<pre>    #ifdef PERL_IMPLICIT_CONTEXT
      #define sv_setiv(a,b)      Perl_sv_setiv(aTHX_ a, b)
      /* can't do this for vararg functions, see below */
    #else
      #define sv_setiv           Perl_sv_setiv
    #endif
</pre>
<p class="Pp">This works well, and means that XS authors can gleefully
  write:</p>
<p class="Pp"></p>
<pre>    sv_setiv(foo, bar);
</pre>
<p class="Pp">and still have it work under all the modes Perl could have been
    compiled with.</p>
<p class="Pp">This doesn't work so cleanly for varargs functions, though, as
    macros imply that the number of arguments is known in advance. Instead we
    either need to spell them out fully, passing
    <span class="Li">&quot;aTHX_&quot;</span> as the first argument (the Perl
    core tends to do this with functions like Perl_warner), or use a
    context-free version.</p>
<p class="Pp">The context-free version of Perl_warner is called
    Perl_warner_nocontext, and does not take the extra argument. Instead it does
    <span class="Li">&quot;dTHX;&quot;</span> to get the context from
    thread-local storage. We <span class="Li">&quot;#define warner
    Perl_warner_nocontext&quot;</span> so that extensions get source
    compatibility at the expense of performance. (Passing an arg is cheaper than
    grabbing it from thread-local storage.)</p>
<p class="Pp">You can ignore [pad]THXx when browsing the Perl headers/sources.
    Those are strictly for use within the core. Extensions and embedders need
    only be aware of [pad]THX.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="So_what_happened_to_dTHR?"><a class="permalink" href="#So_what_happened_to_dTHR?">So
  what happened to dTHR?</a></h2>
<p class="Pp"><span class="Li">&quot;dTHR&quot;</span> was introduced in perl
    5.005 to support the older thread model. The older thread model now uses the
    <span class="Li">&quot;THX&quot;</span> mechanism to pass context pointers
    around, so <span class="Li">&quot;dTHR&quot;</span> is not useful any more.
    Perl 5.6.0 and later still have it for backward source compatibility, but it
    is defined to be a no-op.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="How_do_I_use_all_this_in_extensions?"><a class="permalink" href="#How_do_I_use_all_this_in_extensions?">How
  do I use all this in extensions?</a></h2>
<p class="Pp">When Perl is built with PERL_IMPLICIT_CONTEXT, extensions that
    call any functions in the Perl API will need to pass the initial context
    argument somehow. The kicker is that you will need to write it in such a way
    that the extension still compiles when Perl hasn't been built with
    PERL_IMPLICIT_CONTEXT enabled.</p>
<p class="Pp">There are three ways to do this. First, the easy but inefficient
    way, which is also the default, in order to maintain source compatibility
    with extensions: whenever <i>XSUB.h</i> is #included, it redefines the aTHX
    and aTHX_ macros to call a function that will return the context. Thus,
    something like:</p>
<p class="Pp"></p>
<pre>        sv_setiv(sv, num);
</pre>
<p class="Pp">in your extension will translate to this when
    PERL_IMPLICIT_CONTEXT is in effect:</p>
<p class="Pp"></p>
<pre>        Perl_sv_setiv(Perl_get_context(), sv, num);
</pre>
<p class="Pp">or to this otherwise:</p>
<p class="Pp"></p>
<pre>        Perl_sv_setiv(sv, num);
</pre>
<p class="Pp">You don't have to do anything new in your extension to get this;
    since the Perl library provides <b>Perl_get_context()</b>, it will all just
    work.</p>
<p class="Pp">The second, more efficient way is to use the following template
    for your Foo.xs:</p>
<p class="Pp"></p>
<pre>        #define PERL_NO_GET_CONTEXT     /* we want efficiency */
        #include &quot;EXTERN.h&quot;
        #include &quot;perl.h&quot;
        #include &quot;XSUB.h&quot;
        STATIC void my_private_function(int arg1, int arg2);
        STATIC void
        my_private_function(int arg1, int arg2)
        {
            dTHX;       /* fetch context */
            ... call many Perl API functions ...
        }
        [... etc ...]
        MODULE = Foo            PACKAGE = Foo
        /* typical XSUB */
        void
        my_xsub(arg)
                int arg
            CODE:
                my_private_function(arg, 10);
</pre>
<p class="Pp">Note that the only two changes from the normal way of writing an
    extension is the addition of a <span class="Li">&quot;#define
    PERL_NO_GET_CONTEXT&quot;</span> before including the Perl headers, followed
    by a <span class="Li">&quot;dTHX;&quot;</span> declaration at the start of
    every function that will call the Perl API. (You'll know which functions
    need this, because the C compiler will complain that there's an undeclared
    identifier in those functions.) No changes are needed for the XSUBs
    themselves, because the <b>XS()</b> macro is correctly defined to pass in
    the implicit context if needed.</p>
<p class="Pp">The third, even more efficient way is to ape how it is done within
    the Perl guts:</p>
<p class="Pp"></p>
<pre>        #define PERL_NO_GET_CONTEXT     /* we want efficiency */
        #include &quot;EXTERN.h&quot;
        #include &quot;perl.h&quot;
        #include &quot;XSUB.h&quot;
        /* pTHX_ only needed for functions that call Perl API */
        STATIC void my_private_function(pTHX_ int arg1, int arg2);
        STATIC void
        my_private_function(pTHX_ int arg1, int arg2)
        {
            /* dTHX; not needed here, because THX is an argument */
            ... call Perl API functions ...
        }
        [... etc ...]
        MODULE = Foo            PACKAGE = Foo
        /* typical XSUB */
        void
        my_xsub(arg)
                int arg
            CODE:
                my_private_function(aTHX_ arg, 10);
</pre>
<p class="Pp">This implementation never has to fetch the context using a
    function call, since it is always passed as an extra argument. Depending on
    your needs for simplicity or efficiency, you may mix the previous two
    approaches freely.</p>
<p class="Pp">Never add a comma after <span class="Li">&quot;pTHX&quot;</span>
    yourself--always use the form of the macro with the underscore for functions
    that take explicit arguments, or the form without the argument for functions
    with no explicit arguments.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Should_I_do_anything_special_if_I_call_perl_from_multiple_threads?"><a class="permalink" href="#Should_I_do_anything_special_if_I_call_perl_from_multiple_threads?">Should
  I do anything special if I call perl from multiple threads?</a></h2>
<p class="Pp">If you create interpreters in one thread and then proceed to call
    them in another, you need to make sure perl's own Thread Local Storage (TLS)
    slot is initialized correctly in each of those threads.</p>
<p class="Pp">The <span class="Li">&quot;perl_alloc&quot;</span> and
    <span class="Li">&quot;perl_clone&quot;</span> API functions will
    automatically set the TLS slot to the interpreter they created, so that
    there is no need to do anything special if the interpreter is always
    accessed in the same thread that created it, and that thread did not create
    or call any other interpreters afterwards. If that is not the case, you have
    to set the TLS slot of the thread before calling any functions in the Perl
    API on that particular interpreter. This is done by calling the
    <span class="Li">&quot;PERL_SET_CONTEXT&quot;</span> macro in that thread as
    the first thing you do:</p>
<p class="Pp"></p>
<pre>        /* do this before doing anything else with some_perl */
        PERL_SET_CONTEXT(some_perl);
        ... other Perl API calls on some_perl go here ...
</pre>
</section>
<section class="Ss">
<h2 class="Ss" id="Future_Plans_and_"><a class="permalink" href="#Future_Plans_and_">Future
  Plans and PERL_IMPLICIT_SYS</a></h2>
<p class="Pp">Just as PERL_IMPLICIT_CONTEXT provides a way to bundle up
    everything that the interpreter knows about itself and pass it around, so
    too are there plans to allow the interpreter to bundle up everything it
    knows about the environment it's running on. This is enabled with the
    PERL_IMPLICIT_SYS macro. Currently it only works with USE_ITHREADS on
    Windows.</p>
<p class="Pp">This allows the ability to provide an extra pointer (called the
    &quot;host&quot; environment) for all the system calls. This makes it
    possible for all the system stuff to maintain their own state, broken down
    into seven C structures. These are thin wrappers around the usual system
    calls (see <i>win32/perllib.c</i>) for the default perl executable, but for
    a more ambitious host (like the one that would do <b>fork()</b> emulation)
    all the extra work needed to pretend that different interpreters are
    actually different &quot;processes&quot;, would be done here.</p>
<p class="Pp">The Perl engine/interpreter and the host are orthogonal entities.
    There could be one or more interpreters in a process, and one or more
    &quot;hosts&quot;, with free association between them.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="Internal_Functions"><a class="permalink" href="#Internal_Functions">Internal
  Functions</a></h1>
<p class="Pp">All of Perl's internal functions which will be exposed to the
    outside world are prefixed by <span class="Li">&quot;Perl_&quot;</span> so
    that they will not conflict with XS functions or functions used in a program
    in which Perl is embedded. Similarly, all global variables begin with
    <span class="Li">&quot;PL_&quot;</span>. (By convention, static functions
    start with <span class="Li">&quot;S_&quot;</span>.)</p>
<p class="Pp">Inside the Perl core
    (<span class="Li">&quot;PERL_CORE&quot;</span> defined), you can get at the
    functions either with or without the
    <span class="Li">&quot;Perl_&quot;</span> prefix, thanks to a bunch of
    defines that live in <i>embed.h</i>. Note that extension code should
    <i>not</i> set <span class="Li">&quot;PERL_CORE&quot;</span>; this exposes
    the full perl internals, and is likely to cause breakage of the XS in each
    new perl release.</p>
<p class="Pp">The file <i>embed.h</i> is generated automatically from
    <i>embed.pl</i> and <i>embed.fnc</i>. <i>embed.pl</i> also creates the
    prototyping header files for the internal functions, generates the
    documentation and a lot of other bits and pieces. It's important that when
    you add a new function to the core or change an existing one, you change the
    data in the table in <i>embed.fnc</i> as well. Here's a sample entry from
    that table:</p>
<p class="Pp"></p>
<pre>    Apd |SV**   |av_fetch   |AV* ar|I32 key|I32 lval
</pre>
<p class="Pp">The first column is a set of flags, the second column the return
    type, the third column the name. Columns after that are the arguments. The
    flags are documented at the top of <i>embed.fnc</i>.</p>
<p class="Pp">If you edit <i>embed.pl</i> or <i>embed.fnc</i>, you will need to
    run <span class="Li">&quot;make regen_headers&quot;</span> to force a
    rebuild of <i>embed.h</i> and other auto-generated files.</p>
<section class="Ss">
<h2 class="Ss" id="Formatted_Printing_of_IVs,_UVs,_and_NVs"><a class="permalink" href="#Formatted_Printing_of_IVs,_UVs,_and_NVs">Formatted
  Printing of IVs, UVs, and NVs</a></h2>
<p class="Pp">If you are printing IVs, UVs, or NVS instead of the
    <b>stdio</b>(3) style formatting codes like <span class="Li">%d</span>,
    <span class="Li">%ld</span>, <span class="Li">%f</span>, you should use the
    following macros for portability</p>
<p class="Pp"></p>
<pre>        IVdf            IV in decimal
        UVuf            UV in decimal
        UVof            UV in octal
        UVxf            UV in hexadecimal
        NVef            NV %e-like
        NVff            NV %f-like
        NVgf            NV %g-like
</pre>
<p class="Pp">These will take care of 64-bit integers and long doubles. For
    example:</p>
<p class="Pp"></p>
<pre>        printf(&quot;IV is %&quot; IVdf &quot;\n&quot;, iv);
</pre>
<p class="Pp">The <span class="Li">&quot;IVdf&quot;</span> will expand to
    whatever is the correct format for the IVs. Note that the spaces are
    required around the format in case the code is compiled with C++, to
    maintain compliance with its standard.</p>
<p class="Pp">Note that there are different &quot;long doubles&quot;: Perl will
    use whatever the compiler has.</p>
<p class="Pp">If you are printing addresses of pointers, use
    <span class="Li">%p</span> or UVxf combined with <b>PTR2UV()</b>.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Formatted_Printing_of_SVs"><a class="permalink" href="#Formatted_Printing_of_SVs">Formatted
  Printing of SVs</a></h2>
<p class="Pp">The contents of SVs may be printed using the
    <span class="Li">&quot;SVf&quot;</span> format, like so:</p>
<p class="Pp"></p>
<pre> Perl_croak(aTHX_ &quot;This croaked because: %&quot; SVf &quot;\n&quot;, SVfARG(err_msg))
</pre>
<p class="Pp">where <span class="Li">&quot;err_msg&quot;</span> is an SV.</p>
<p class="Pp">Not all scalar types are printable. Simple values certainly are:
    one of IV, UV, NV, or PV. Also, if the SV is a reference to some value,
    either it will be dereferenced and the value printed, or information about
    the type of that value and its address are displayed. The results of
    printing any other type of SV are undefined and likely to lead to an
    interpreter crash. NVs are printed using a <span class="Li">%g</span>-ish
    format.</p>
<p class="Pp">Note that the spaces are required around the
    <span class="Li">&quot;SVf&quot;</span> in case the code is compiled with
    C++, to maintain compliance with its standard.</p>
<p class="Pp">Note that any filehandle being printed to under UTF-8 must be
    expecting UTF-8 in order to get good results and avoid Wide-character
    warnings. One way to do this for typical filehandles is to invoke perl with
    the <span class="Li">&quot;-C&quot;</span>&gt; parameter. (See &quot;-C
    [number/list]&quot; in perlrun.</p>
<p class="Pp">You can use this to concatenate two scalars:</p>
<p class="Pp"></p>
<pre> SV *var1 = get_sv(&quot;var1&quot;, GV_ADD);
 SV *var2 = get_sv(&quot;var2&quot;, GV_ADD);
 SV *var3 = newSVpvf(&quot;var1=%&quot; SVf &quot; and var2=%&quot; SVf,
                     SVfARG(var1), SVfARG(var2));
</pre>
</section>
<section class="Ss">
<h2 class="Ss" id="Formatted_Printing_of_Strings"><a class="permalink" href="#Formatted_Printing_of_Strings">Formatted
  Printing of Strings</a></h2>
<p class="Pp">If you just want the bytes printed in a 7bit NUL-terminated
    string, you can just use <span class="Li">%s</span> (assuming they are all
    really only 7bit). But if there is a possibility the value will be encoded
    as UTF-8 or contains bytes above <span class="Li">0x7F</span> (and therefore
    8bit), you should instead use the <span class="Li">&quot;UTF8f&quot;</span>
    format. And as its parameter, use the
    <span class="Li">&quot;UTF8fARG()&quot;</span> macro:</p>
<p class="Pp"></p>
<pre> chr * msg;
 /* U+2018: \xE2\x80\x98 LEFT SINGLE QUOTATION MARK
    U+2019: \xE2\x80\x99 RIGHT SINGLE QUOTATION MARK */
 if (can_utf8)
   msg = &quot;\xE2\x80\x98Uses fancy quotes\xE2\x80\x99&quot;;
 else
   msg = &quot;'Uses simple quotes'&quot;;
 Perl_croak(aTHX_ &quot;The message is: %&quot; UTF8f &quot;\n&quot;,
                  UTF8fARG(can_utf8, strlen(msg), msg));
</pre>
<p class="Pp">The first parameter to
    <span class="Li">&quot;UTF8fARG&quot;</span> is a boolean: 1 if the string
    is in UTF-8; 0 if string is in native byte encoding (Latin1). The second
    parameter is the number of bytes in the string to print. And the third and
    final parameter is a pointer to the first byte in the string.</p>
<p class="Pp">Note that any filehandle being printed to under UTF-8 must be
    expecting UTF-8 in order to get good results and avoid Wide-character
    warnings. One way to do this for typical filehandles is to invoke perl with
    the <span class="Li">&quot;-C&quot;</span>&gt; parameter. (See &quot;-C
    [number/list]&quot; in perlrun.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Formatted_Printing_of__Size_t__and__SSize_t_"><a class="permalink" href="#Formatted_Printing_of__Size_t__and__SSize_t_">Formatted
  Printing of &quot;Size_t&quot; and &quot;SSize_t&quot;</a></h2>
<p class="Pp">The most general way to do this is to cast them to a UV or IV, and
    print as in the previous section.</p>
<p class="Pp">But if you're using
    <span class="Li">&quot;PerlIO_printf()&quot;</span>, it's less typing and
    visual clutter to use the <span class="Li">%z</span> length modifier (for
    <i>siZe</i>):</p>
<p class="Pp"></p>
<pre>        PerlIO_printf(&quot;STRLEN is %zu\n&quot;, len);
</pre>
<p class="Pp">This modifier is not portable, so its use should be restricted to
    <span class="Li">&quot;PerlIO_printf()&quot;</span>.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Formatted_Printing_of__Ptrdiff_t_,__intmax_t_,__short__and_other_special_sizes"><a class="permalink" href="#Formatted_Printing_of__Ptrdiff_t_,__intmax_t_,__short__and_other_special_sizes">Formatted
  Printing of &quot;Ptrdiff_t&quot;, &quot;intmax_t&quot;, &quot;short&quot; and
  other special sizes</a></h2>
<p class="Pp">There are modifiers for these special situations if you are using
    <span class="Li">&quot;PerlIO_printf()&quot;</span>. See &quot;size&quot; in
    perlfunc.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Pointer-To-Integer_and_Integer-To-Pointer"><a class="permalink" href="#Pointer-To-Integer_and_Integer-To-Pointer">Pointer-To-Integer
  and Integer-To-Pointer</a></h2>
<p class="Pp">Because pointer size does not necessarily equal integer size, use
    the follow macros to do it right.</p>
<p class="Pp"></p>
<pre>        PTR2UV(pointer)
        PTR2IV(pointer)
        PTR2NV(pointer)
        INT2PTR(pointertotype, integer)
</pre>
<p class="Pp">For example:</p>
<p class="Pp"></p>
<pre>        IV  iv = ...;
        SV *sv = INT2PTR(SV*, iv);
</pre>
<p class="Pp">and</p>
<p class="Pp"></p>
<pre>        AV *av = ...;
        UV  uv = PTR2UV(av);
</pre>
<p class="Pp">There are also</p>
<p class="Pp"></p>
<pre> PTR2nat(pointer)   /* pointer to integer of PTRSIZE */
 PTR2ul(pointer)    /* pointer to unsigned long */
</pre>
<p class="Pp">And <span class="Li">&quot;PTRV&quot;</span> which gives the
    native type for an integer the same size as pointers, such as
    <span class="Li">&quot;unsigned&quot;</span> or
    <span class="Li">&quot;unsigned long&quot;</span>.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Exception_Handling"><a class="permalink" href="#Exception_Handling">Exception
  Handling</a></h2>
<p class="Pp">There are a couple of macros to do very basic exception handling
    in XS modules. You have to define
    <span class="Li">&quot;NO_XSLOCKS&quot;</span> before including
    <i>XSUB.h</i> to be able to use these macros:</p>
<p class="Pp"></p>
<pre>        #define NO_XSLOCKS
        #include &quot;XSUB.h&quot;
</pre>
<p class="Pp">You can use these macros if you call code that may croak, but you
    need to do some cleanup before giving control back to Perl. For example:</p>
<p class="Pp"></p>
<pre>        dXCPT;    /* set up necessary variables */
        XCPT_TRY_START {
          code_that_may_croak();
        } XCPT_TRY_END
        XCPT_CATCH
        {
          /* do cleanup here */
          XCPT_RETHROW;
        }
</pre>
<p class="Pp">Note that you always have to rethrow an exception that has been
    caught. Using these macros, it is not possible to just catch the exception
    and ignore it. If you have to ignore the exception, you have to use the
    <span class="Li">&quot;call_*&quot;</span> function.</p>
<p class="Pp">The advantage of using the above macros is that you don't have to
    setup an extra function for <span class="Li">&quot;call_*&quot;</span>, and
    that using these macros is faster than using
    <span class="Li">&quot;call_*&quot;</span>.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Source_Documentation"><a class="permalink" href="#Source_Documentation">Source
  Documentation</a></h2>
<p class="Pp">There's an effort going on to document the internal functions and
    automatically produce reference manuals from them -- perlapi is one such
    manual which details all the functions which are available to XS writers.
    perlintern is the autogenerated manual for the functions which are not part
    of the API and are supposedly for internal use only.</p>
<p class="Pp">Source documentation is created by putting POD comments into the C
    source, like this:</p>
<p class="Pp"></p>
<pre> /*
 =for apidoc sv_setiv
 Copies an integer into the given SV.  Does not handle 'set' magic.  See
 L&lt;perlapi/sv_setiv_mg&gt;.
 =cut
 */
</pre>
<p class="Pp">Please try and supply some documentation if you add functions to
    the Perl core.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Backwards_compatibility"><a class="permalink" href="#Backwards_compatibility">Backwards
  compatibility</a></h2>
<p class="Pp">The Perl API changes over time. New functions are added or the
    interfaces of existing functions are changed. The
    <span class="Li">&quot;Devel::PPPort&quot;</span> module tries to provide
    compatibility code for some of these changes, so XS writers don't have to
    code it themselves when supporting multiple versions of Perl.</p>
<p class="Pp"><span class="Li">&quot;Devel::PPPort&quot;</span> generates a C
    header file <i>ppport.h</i> that can also be run as a Perl script. To
    generate <i>ppport.h</i>, run:</p>
<p class="Pp"></p>
<pre>    perl -MDevel::PPPort -eDevel::PPPort::WriteFile
</pre>
<p class="Pp">Besides checking existing XS code, the script can also be used to
    retrieve compatibility information for various API calls using the
    <span class="Li">&quot;--api-info&quot;</span> command line switch. For
    example:</p>
<p class="Pp"></p>
<pre>  % perl ppport.h --api-info=sv_magicext
</pre>
<p class="Pp">For details, see <span class="Li">&quot;perldoc
    ppport.h&quot;</span>.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="Unicode_Support"><a class="permalink" href="#Unicode_Support">Unicode
  Support</a></h1>
<p class="Pp">Perl 5.6.0 introduced Unicode support. It's important for porters
    and XS writers to understand this support and make sure that the code they
    write does not corrupt Unicode data.</p>
<section class="Ss">
<h2 class="Ss" id="What_"><a class="permalink" href="#What_">What <b>is</b>
  Unicode, anyway?</a></h2>
<p class="Pp">In the olden, less enlightened times, we all used to use ASCII.
    Most of us did, anyway. The big problem with ASCII is that it's American.
    Well, no, that's not actually the problem; the problem is that it's not
    particularly useful for people who don't use the Roman alphabet. What used
    to happen was that particular languages would stick their own alphabet in
    the upper range of the sequence, between 128 and 255. Of course, we then
    ended up with plenty of variants that weren't quite ASCII, and the whole
    point of it being a standard was lost.</p>
<p class="Pp">Worse still, if you've got a language like Chinese or Japanese
    that has hundreds or thousands of characters, then you really can't fit them
    into a mere 256, so they had to forget about ASCII altogether, and build
    their own systems using pairs of numbers to refer to one character.</p>
<p class="Pp">To fix this, some people formed Unicode, Inc. and produced a new
    character set containing all the characters you can possibly think of and
    more. There are several ways of representing these characters, and the one
    Perl uses is called UTF-8. UTF-8 uses a variable number of bytes to
    represent a character. You can learn more about Unicode and Perl's Unicode
    model in perlunicode.</p>
<p class="Pp">(On EBCDIC platforms, Perl uses instead UTF-EBCDIC, which is a
    form of UTF-8 adapted for EBCDIC platforms. Below, we just talk about UTF-8.
    UTF-EBCDIC is like UTF-8, but the details are different. The macros hide the
    differences from you, just remember that the particular numbers and bit
    patterns presented below will differ in UTF-EBCDIC.)</p>
</section>
<section class="Ss">
<h2 class="Ss" id="How_can_I_recognise_a_"><a class="permalink" href="#How_can_I_recognise_a_">How
  can I recognise a UTF-8 string?</a></h2>
<p class="Pp">You can't. This is because UTF-8 data is stored in bytes just like
    non-UTF-8 data. The Unicode character 200, (<span class="Li">0xC8</span> for
    you hex types) capital E with a grave accent, is represented by the two
    bytes <span class="Li">&quot;v196.172&quot;</span>. Unfortunately, the
    non-Unicode string <span class="Li">&quot;chr(196).chr(172)&quot;</span> has
    that byte sequence as well. So you can't tell just by looking -- this is
    what makes Unicode input an interesting problem.</p>
<p class="Pp">In general, you either have to know what you're dealing with, or
    you have to guess. The API function
    <span class="Li">&quot;is_utf8_string&quot;</span> can help; it'll tell you
    if a string contains only valid UTF-8 characters, and the chances of a
    non-UTF-8 string looking like valid UTF-8 become very small very quickly
    with increasing string length. On a character-by-character basis,
    <span class="Li">&quot;isUTF8_CHAR&quot;</span> will tell you whether the
    current character in a string is valid UTF-8.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="How_does_"><a class="permalink" href="#How_does_">How does
  UTF-8 represent Unicode characters?</a></h2>
<p class="Pp">As mentioned above, UTF-8 uses a variable number of bytes to store
    a character. Characters with values 0...127 are stored in one byte, just
    like good ol' ASCII. Character 128 is stored as
    <span class="Li">&quot;v194.128&quot;</span>; this continues up to character
    191, which is <span class="Li">&quot;v194.191&quot;</span>. Now we've run
    out of bits (191 is binary <span class="Li">10111111</span>) so we move on;
    character 192 is <span class="Li">&quot;v195.128&quot;</span>. And so it
    goes on, moving to three bytes at character 2048. &quot;Unicode
    Encodings&quot; in perlunicode has pictures of how this works.</p>
<p class="Pp">Assuming you know you're dealing with a UTF-8 string, you can find
    out how long the first character in it is with the
    <span class="Li">&quot;UTF8SKIP&quot;</span> macro:</p>
<p class="Pp"></p>
<pre>    char *utf = &quot;\305\233\340\240\201&quot;;
    I32 len;
    len = UTF8SKIP(utf); /* len is 2 here */
    utf += len;
    len = UTF8SKIP(utf); /* len is 3 here */
</pre>
<p class="Pp">Another way to skip over characters in a UTF-8 string is to use
    <span class="Li">&quot;utf8_hop&quot;</span>, which takes a string and a
    number of characters to skip over. You're on your own about bounds checking,
    though, so don't use it lightly.</p>
<p class="Pp">All bytes in a multi-byte UTF-8 character will have the high bit
    set, so you can test if you need to do something special with this character
    like this (the <span class="Li">&quot;UTF8_IS_INVARIANT()&quot;</span> is a
    macro that tests whether the byte is encoded as a single byte even in
    UTF-8):</p>
<p class="Pp"></p>
<pre>    U8 *utf;     /* Initialize this to point to the beginning of the
                    sequence to convert */
    U8 *utf_end; /* Initialize this to 1 beyond the end of the sequence
                    pointed to by 'utf' */
    UV uv;       /* Returned code point; note: a UV, not a U8, not a
                    char */
    STRLEN len; /* Returned length of character in bytes */
    if (!UTF8_IS_INVARIANT(*utf))
        /* Must treat this as UTF-8 */
        uv = utf8_to_uvchr_buf(utf, utf_end, &amp;len);
    else
        /* OK to treat this character as a byte */
        uv = *utf;
</pre>
<p class="Pp">You can also see in that example that we use
    <span class="Li">&quot;utf8_to_uvchr_buf&quot;</span> to get the value of
    the character; the inverse function
    <span class="Li">&quot;uvchr_to_utf8&quot;</span> is available for putting a
    UV into UTF-8:</p>
<p class="Pp"></p>
<pre>    if (!UVCHR_IS_INVARIANT(uv))
        /* Must treat this as UTF8 */
        utf8 = uvchr_to_utf8(utf8, uv);
    else
        /* OK to treat this character as a byte */
        *utf8++ = uv;
</pre>
<p class="Pp">You <b>must</b> convert characters to UVs using the above
    functions if you're ever in a situation where you have to match UTF-8 and
    non-UTF-8 characters. You may not skip over UTF-8 characters in this case.
    If you do this, you'll lose the ability to match hi-bit non-UTF-8
    characters; for instance, if your UTF-8 string contains
    <span class="Li">&quot;v196.172&quot;</span>, and you skip that character,
    you can never match a <span class="Li">&quot;chr(200)&quot;</span> in a
    non-UTF-8 string. So don't do that!</p>
<p class="Pp">(Note that we don't have to test for invariant characters in the
    examples above. The functions work on any well-formed UTF-8 input. It's just
    that its faster to avoid the function overhead when it's not needed.)</p>
</section>
<section class="Ss">
<h2 class="Ss" id="How_does_Perl_store_"><a class="permalink" href="#How_does_Perl_store_">How
  does Perl store UTF-8 strings?</a></h2>
<p class="Pp">Currently, Perl deals with UTF-8 strings and non-UTF-8 strings
    slightly differently. A flag in the SV,
    <span class="Li">&quot;SVf_UTF8&quot;</span>, indicates that the string is
    internally encoded as UTF-8. Without it, the byte value is the codepoint
    number and vice versa. This flag is only meaningful if the SV is
    <span class="Li">&quot;SvPOK&quot;</span> or immediately after
    stringification via <span class="Li">&quot;SvPV&quot;</span> or a similar
    macro. You can check and manipulate this flag with the following macros:</p>
<p class="Pp"></p>
<pre>    SvUTF8(sv)
    SvUTF8_on(sv)
    SvUTF8_off(sv)
</pre>
<p class="Pp">This flag has an important effect on Perl's treatment of the
    string: if UTF-8 data is not properly distinguished, regular expressions,
    <span class="Li">&quot;length&quot;</span>,
    <span class="Li">&quot;substr&quot;</span> and other string handling
    operations will have undesirable (wrong) results.</p>
<p class="Pp">The problem comes when you have, for instance, a string that isn't
    flagged as UTF-8, and contains a byte sequence that could be UTF-8 --
    especially when combining non-UTF-8 and UTF-8 strings.</p>
<p class="Pp">Never forget that the <span class="Li">&quot;SVf_UTF8&quot;</span>
    flag is separate from the PV value; you need to be sure you don't
    accidentally knock it off while you're manipulating SVs. More specifically,
    you cannot expect to do this:</p>
<p class="Pp"></p>
<pre>    SV *sv;
    SV *nsv;
    STRLEN len;
    char *p;
    p = SvPV(sv, len);
    frobnicate(p);
    nsv = newSVpvn(p, len);
</pre>
<p class="Pp">The <span class="Li">&quot;char*&quot;</span> string does not tell
    you the whole story, and you can't copy or reconstruct an SV just by copying
    the string value. Check if the old SV has the UTF8 flag set (<i>after</i>
    the <span class="Li">&quot;SvPV&quot;</span> call), and act accordingly:</p>
<p class="Pp"></p>
<pre>    p = SvPV(sv, len);
    is_utf8 = SvUTF8(sv);
    frobnicate(p, is_utf8);
    nsv = newSVpvn(p, len);
    if (is_utf8)
        SvUTF8_on(nsv);
</pre>
<p class="Pp">In the above, your <span class="Li">&quot;frobnicate&quot;</span>
    function has been changed to be made aware of whether or not it's dealing
    with UTF-8 data, so that it can handle the string appropriately.</p>
<p class="Pp">Since just passing an SV to an XS function and copying the data of
    the SV is not enough to copy the UTF8 flags, even less right is just passing
    a <span class="Li">&quot;char&#x00A0;*&quot;</span> to an XS function.</p>
<p class="Pp">For full generality, use the
    <span class="Li">&quot;DO_UTF8&quot;</span> macro to see if the string in an
    SV is to be <i>treated</i> as UTF-8. This takes into account if the call to
    the XS function is being made from within the scope of
    <span class="Li">&quot;use&#x00A0;bytes&quot;</span>. If so, the underlying
    bytes that comprise the UTF-8 string are to be exposed, rather than the
    character they represent. But this pragma should only really be used for
    debugging and perhaps low-level testing at the byte level. Hence most XS
    code need not concern itself with this, but various areas of the perl core
    do need to support it.</p>
<p class="Pp">And this isn't the whole story. Starting in Perl v5.12, strings
    that aren't encoded in UTF-8 may also be treated as Unicode under various
    conditions (see &quot;ASCII Rules versus Unicode Rules&quot; in
    perlunicode). This is only really a problem for characters whose ordinals
    are between 128 and 255, and their behavior varies under ASCII versus
    Unicode rules in ways that your code cares about (see &quot;The
    &quot;Unicode Bug&quot;&quot; in perlunicode). There is no published API for
    dealing with this, as it is subject to change, but you can look at the code
    for <span class="Li">&quot;pp_lc&quot;</span> in <i>pp.c</i> for an example
    as to how it's currently done.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="How_do_I_pass_a_Perl_string_to_a_C_library?"><a class="permalink" href="#How_do_I_pass_a_Perl_string_to_a_C_library?">How
  do I pass a Perl string to a C library?</a></h2>
<p class="Pp">A Perl string, conceptually, is an opaque sequence of code points.
    Many C libraries expect their inputs to be &quot;classical&quot; C strings,
    which are arrays of octets 1-255, terminated with a NUL byte. Your job when
    writing an interface between Perl and a C library is to define the mapping
    between Perl and that library.</p>
<p class="Pp">Generally speaking, <span class="Li">&quot;SvPVbyte&quot;</span>
    and related macros suit this task well. These assume that your Perl string
    is a &quot;byte string&quot;, i.e., is either raw, undecoded input into Perl
    or is pre-encoded to, e.g., UTF-8.</p>
<p class="Pp">Alternatively, if your C library expects UTF-8 text, you can use
    <span class="Li">&quot;SvPVutf8&quot;</span> and related macros. This has
    the same effect as encoding to UTF-8 then calling the corresponding
    <span class="Li">&quot;SvPVbyte&quot;</span>-related macro.</p>
<p class="Pp">Some C libraries may expect other encodings (e.g., UTF-16LE). To
    give Perl strings to such libraries you must either do that encoding in Perl
    then use <span class="Li">&quot;SvPVbyte&quot;</span>, or use an
    intermediary C library to convert from however Perl stores the string to the
    desired encoding.</p>
<p class="Pp">Take care also that NULs in your Perl string don't confuse the C
    library. If possible, give the string's length to the C library; if that's
    not possible, consider rejecting strings that contain NUL bytes.</p>
<p class="Pp"><i>What about
    </i><span class="Li"><i>&quot;SvPV&quot;</i></span><i>,
    </i><span class="Li"><i>&quot;SvPV_nolen&quot;</i></span><i>, etc.?</i></p>
<p class="Pp">Consider a 3-character Perl string <span class="Li">&quot;$foo =
    &quot;\x64\x78\x8c&quot;&quot;</span>. Perl can store these 3 characters
    either of two ways:</p>
<ul class="Bl-bullet">
  <li>bytes: 0x64 0x78 0x8c</li>
  <li>UTF-8: 0x64 0x78 0xc2 0x8c</li>
</ul>
<p class="Pp">Now let's say you convert <span class="Li">$foo</span> to a C
    string thus:</p>
<p class="Pp"></p>
<pre>    STRLEN strlen;
    char *str = SvPV(foo_sv, strlen);
</pre>
<p class="Pp">At this point <span class="Li">&quot;str&quot;</span> could point
    to a 3-byte C string or a 4-byte one.</p>
<p class="Pp">Generally speaking, we want
    <span class="Li">&quot;str&quot;</span> to be the same regardless of how
    Perl stores <span class="Li">$foo</span>, so the ambiguity here is
    undesirable. <span class="Li">&quot;SvPVbyte&quot;</span> and
    <span class="Li">&quot;SvPVutf8&quot;</span> solve that by giving
    predictable output: use <span class="Li">&quot;SvPVbyte&quot;</span> if your
    C library expects byte strings, or
    <span class="Li">&quot;SvPVutf8&quot;</span> if it expects UTF-8.</p>
<p class="Pp">If your C library happens to support both encodings, then
    <span class="Li">&quot;SvPV&quot;</span>--always in tandem with lookups to
    <span class="Li">&quot;SvUTF8&quot;</span>!--may be safe and (slightly) more
    efficient.</p>
<p class="Pp"><b>TESTING</b> <b>TIP:</b> Use utf8's
    <span class="Li">&quot;upgrade&quot;</span> and
    <span class="Li">&quot;downgrade&quot;</span> functions in your tests to
    ensure consistent handling regardless of Perl's internal encoding.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="How_do_I_convert_a_string_to_"><a class="permalink" href="#How_do_I_convert_a_string_to_">How
  do I convert a string to UTF-8?</a></h2>
<p class="Pp">If you're mixing UTF-8 and non-UTF-8 strings, it is necessary to
    upgrade the non-UTF-8 strings to UTF-8. If you've got an SV, the easiest way
    to do this is:</p>
<p class="Pp"></p>
<pre>    sv_utf8_upgrade(sv);
</pre>
<p class="Pp">However, you must not do this, for example:</p>
<p class="Pp"></p>
<pre>    if (!SvUTF8(left))
        sv_utf8_upgrade(left);
</pre>
<p class="Pp">If you do this in a binary operator, you will actually change one
    of the strings that came into the operator, and, while it shouldn't be
    noticeable by the end user, it can cause problems in deficient code.</p>
<p class="Pp">Instead, <span class="Li">&quot;bytes_to_utf8&quot;</span> will
    give you a UTF-8-encoded <b>copy</b> of its string argument. This is useful
    for having the data available for comparisons and so on, without harming the
    original SV. There's also <span class="Li">&quot;utf8_to_bytes&quot;</span>
    to go the other way, but naturally, this will fail if the string contains
    any characters above 255 that can't be represented in a single byte.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="How_do_I_compare_strings?"><a class="permalink" href="#How_do_I_compare_strings?">How
  do I compare strings?</a></h2>
<p class="Pp">&quot;sv_cmp&quot; in perlapi and &quot;sv_cmp_flags&quot; in
    perlapi do a lexigraphic comparison of two SV's, and handle UTF-8ness
    properly. Note, however, that Unicode specifies a much fancier mechanism for
    collation, available via the Unicode::Collate module.</p>
<p class="Pp">To just compare two strings for equality/non-equality, you can
    just use <span class="Li">&quot;memEQ()&quot;</span> and
    <span class="Li">&quot;memNE()&quot;</span> as usual, except the strings
    must be both UTF-8 or not UTF-8 encoded.</p>
<p class="Pp">To compare two strings case-insensitively, use
    <span class="Li">&quot;foldEQ_utf8()&quot;</span> (the strings don't have to
    have the same UTF-8ness).</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Is_there_anything_else_I_need_to_know?"><a class="permalink" href="#Is_there_anything_else_I_need_to_know?">Is
  there anything else I need to know?</a></h2>
<p class="Pp">Not really. Just remember these things:</p>
<ul class="Bl-bullet">
  <li>There's no way to tell if a
      <span class="Li">&quot;char&#x00A0;*&quot;</span> or
      <span class="Li">&quot;U8&#x00A0;*&quot;</span> string is UTF-8 or not.
      But you can tell if an SV is to be treated as UTF-8 by calling
      <span class="Li">&quot;DO_UTF8&quot;</span> on it, after stringifying it
      with <span class="Li">&quot;SvPV&quot;</span> or a similar macro. And, you
      can tell if SV is actually UTF-8 (even if it is not to be treated as such)
      by looking at its <span class="Li">&quot;SvUTF8&quot;</span> flag (again
      after stringifying it). Don't forget to set the flag if something should
      be UTF-8. Treat the flag as part of the PV, even though it's not -- if you
      pass on the PV to somewhere, pass on the flag too.</li>
  <li>If a string is UTF-8, <b>always</b> use
      <span class="Li">&quot;utf8_to_uvchr_buf&quot;</span> to get at the value,
      unless <span class="Li">&quot;UTF8_IS_INVARIANT(*s)&quot;</span> in which
      case you can use <span class="Li">*s</span>.</li>
  <li>When writing a character UV to a UTF-8 string, <b>always</b> use
      <span class="Li">&quot;uvchr_to_utf8&quot;</span>, unless
      <span class="Li">&quot;UVCHR_IS_INVARIANT(uv))&quot;</span> in which case
      you can use <span class="Li">&quot;*s = uv&quot;</span>.</li>
  <li>Mixing UTF-8 and non-UTF-8 strings is tricky. Use
      <span class="Li">&quot;bytes_to_utf8&quot;</span> to get a new string
      which is UTF-8 encoded, and then combine them.</li>
</ul>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="Custom_Operators"><a class="permalink" href="#Custom_Operators">Custom
  Operators</a></h1>
<p class="Pp">Custom operator support is an experimental feature that allows you
    to define your own ops. This is primarily to allow the building of
    interpreters for other languages in the Perl core, but it also allows
    optimizations through the creation of &quot;macro-ops&quot; (ops which
    perform the functions of multiple ops which are usually executed together,
    such as <span class="Li">&quot;gvsv, gvsv, add&quot;</span>.)</p>
<p class="Pp">This feature is implemented as a new op type,
    <span class="Li">&quot;OP_CUSTOM&quot;</span>. The Perl core does not
    &quot;know&quot; anything special about this op type, and so it will not be
    involved in any optimizations. This also means that you can define your
    custom ops to be any op structure -- unary, binary, list and so on -- you
    like.</p>
<p class="Pp">It's important to know what custom operators won't do for you.
    They won't let you add new syntax to Perl, directly. They won't even let you
    add new keywords, directly. In fact, they won't change the way Perl compiles
    a program at all. You have to do those changes yourself, after Perl has
    compiled the program. You do this either by manipulating the op tree using a
    <span class="Li">&quot;CHECK&quot;</span> block and the
    <span class="Li">&quot;B::Generate&quot;</span> module, or by adding a
    custom peephole optimizer with the
    <span class="Li">&quot;optimize&quot;</span> module.</p>
<p class="Pp">When you do this, you replace ordinary Perl ops with custom ops by
    creating ops with the type <span class="Li">&quot;OP_CUSTOM&quot;</span> and
    the <span class="Li">&quot;op_ppaddr&quot;</span> of your own PP function.
    This should be defined in XS code, and should look like the PP ops in
    <span class="Li">&quot;pp_*.c&quot;</span>. You are responsible for ensuring
    that your op takes the appropriate number of values from the stack, and you
    are responsible for adding stack marks if necessary.</p>
<p class="Pp">You should also &quot;register&quot; your op with the Perl
    interpreter so that it can produce sensible error and warning messages.
    Since it is possible to have multiple custom ops within the one
    &quot;logical&quot; op type <span class="Li">&quot;OP_CUSTOM&quot;</span>,
    Perl uses the value of <span class="Li">&quot;o-&gt;op_ppaddr&quot;</span>
    to determine which custom op it is dealing with. You should create an
    <span class="Li">&quot;XOP&quot;</span> structure for each ppaddr you use,
    set the properties of the custom op with
    <span class="Li">&quot;XopENTRY_set&quot;</span>, and register the structure
    against the ppaddr using
    <span class="Li">&quot;Perl_custom_op_register&quot;</span>. A trivial
    example might look like:</p>
<p class="Pp"></p>
<pre>    static XOP my_xop;
    static OP *my_pp(pTHX);
    BOOT:
        XopENTRY_set(&amp;my_xop, xop_name, &quot;myxop&quot;);
        XopENTRY_set(&amp;my_xop, xop_desc, &quot;Useless custom op&quot;);
        Perl_custom_op_register(aTHX_ my_pp, &amp;my_xop);
</pre>
<p class="Pp">The available fields in the structure are:</p>
<dl class="Bl-tag">
  <dt id="xop_name"><a class="permalink" href="#xop_name">xop_name</a></dt>
  <dd>A short name for your op. This will be included in some error messages,
      and will also be returned as
      <span class="Li">&quot;$op-&gt;name&quot;</span> by the B module, so it
      will appear in the output of module like B::Concise.</dd>
  <dt id="xop_desc"><a class="permalink" href="#xop_desc">xop_desc</a></dt>
  <dd>A short description of the function of the op.</dd>
  <dt id="xop_class"><a class="permalink" href="#xop_class">xop_class</a></dt>
  <dd>Which of the various <span class="Li">*OP</span> structures this op uses.
      This should be one of the <span class="Li">&quot;OA_*&quot;</span>
      constants from <i>op.h</i>, namely</dd>
</dl>
<div class="Bd-indent">
<dl class="Bl-tag">
  <dt id="OA_BASEOP"><a class="permalink" href="#OA_BASEOP">OA_BASEOP</a></dt>
  <dd></dd>
  <dt id="OA_UNOP"><a class="permalink" href="#OA_UNOP">OA_UNOP</a></dt>
  <dd></dd>
  <dt id="OA_BINOP"><a class="permalink" href="#OA_BINOP">OA_BINOP</a></dt>
  <dd></dd>
  <dt id="OA_LOGOP"><a class="permalink" href="#OA_LOGOP">OA_LOGOP</a></dt>
  <dd></dd>
  <dt id="OA_LISTOP"><a class="permalink" href="#OA_LISTOP">OA_LISTOP</a></dt>
  <dd></dd>
  <dt id="OA_PMOP"><a class="permalink" href="#OA_PMOP">OA_PMOP</a></dt>
  <dd></dd>
  <dt id="OA_SVOP"><a class="permalink" href="#OA_SVOP">OA_SVOP</a></dt>
  <dd></dd>
  <dt id="OA_PADOP"><a class="permalink" href="#OA_PADOP">OA_PADOP</a></dt>
  <dd></dd>
  <dt id="OA_PVOP_OR_SVOP"><a class="permalink" href="#OA_PVOP_OR_SVOP">OA_PVOP_OR_SVOP</a></dt>
  <dd>This should be interpreted as '<span class="Li">&quot;PVOP&quot;</span>'
      only. The <span class="Li">&quot;_OR_SVOP&quot;</span> is because the only
      core <span class="Li">&quot;PVOP&quot;</span>,
      <span class="Li">&quot;OP_TRANS&quot;</span>, can sometimes be a
      <span class="Li">&quot;SVOP&quot;</span> instead.</dd>
  <dt id="OA_LOOP"><a class="permalink" href="#OA_LOOP">OA_LOOP</a></dt>
  <dd></dd>
  <dt id="OA_COP"><a class="permalink" href="#OA_COP">OA_COP</a></dt>
  <dd></dd>
</dl>
</div>
<div class="Bd-indent">
<p class="Pp">The other <span class="Li">&quot;OA_*&quot;</span> constants
    should not be used.</p>
</div>
<dl class="Bl-tag">
  <dt id="xop_peep"><a class="permalink" href="#xop_peep">xop_peep</a></dt>
  <dd>This member is of type <span class="Li">&quot;Perl_cpeep_t&quot;</span>,
      which expands to <span class="Li">&quot;void</span>
      <span class="Li">(*Perl_cpeep_t)(aTHX_ OP *o, OP *oldop)&quot;</span>. If
      it is set, this function will be called from
      <span class="Li">&quot;Perl_rpeep&quot;</span> when ops of this type are
      encountered by the peephole optimizer. <i>o</i> is the OP that needs
      optimizing; <i>oldop</i> is the previous OP optimized, whose
      <span class="Li">&quot;op_next&quot;</span> points to <i>o</i>.</dd>
</dl>
<p class="Pp"><span class="Li">&quot;B::Generate&quot;</span> directly supports
    the creation of custom ops by name.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="Stacks"><a class="permalink" href="#Stacks">Stacks</a></h1>
<p class="Pp">Descriptions above occasionally refer to &quot;the stack&quot;,
    but there are in fact many stack-like data structures within the perl
    interpreter. When otherwise unqualified, &quot;the stack&quot; usually
    refers to the value stack.</p>
<p class="Pp">The various stacks have different purposes, and operate in
    slightly different ways. Their differences are noted below.</p>
<section class="Ss">
<h2 class="Ss" id="Value_Stack"><a class="permalink" href="#Value_Stack">Value
  Stack</a></h2>
<p class="Pp">This stack stores the values that regular perl code is operating
    on, usually intermediate values of expressions within a statement. The stack
    itself is formed of an array of SV pointers.</p>
<p class="Pp">The base of this stack is pointed to by the interpreter variable
    <span class="Li">&quot;PL_stack_base&quot;</span>, of type
    <span class="Li">&quot;SV **&quot;</span>.</p>
<p class="Pp">The head of the stack is
    <span class="Li">&quot;PL_stack_sp&quot;</span>, and points to the most
    recently-pushed item.</p>
<p class="Pp">Items are pushed to the stack by using the
    <span class="Li">&quot;PUSHs()&quot;</span> macro or its variants described
    above; <span class="Li">&quot;XPUSHs()&quot;</span>,
    <span class="Li">&quot;mPUSHs()&quot;</span>,
    <span class="Li">&quot;mXPUSHs()&quot;</span> and the typed versions. Note
    carefully that the non-<span class="Li">&quot;X&quot;</span> versions of
    these macros do not check the size of the stack and assume it to be big
    enough. These must be paired with a suitable check of the stack's size, such
    as the <span class="Li">&quot;EXTEND&quot;</span> macro to ensure it is
    large enough. For example</p>
<p class="Pp"></p>
<pre>    EXTEND(SP, 4);
    mPUSHi(10);
    mPUSHi(20);
    mPUSHi(30);
    mPUSHi(40);
</pre>
<p class="Pp">This is slightly more performant than making four separate checks
    in four separate <span class="Li">&quot;mXPUSHi()&quot;</span> calls.</p>
<p class="Pp">As a further performance optimisation, the various
    <span class="Li">&quot;PUSH&quot;</span> macros all operate using a local
    variable <span class="Li">&quot;SP&quot;</span>, rather than the
    interpreter-global variable <span class="Li">&quot;PL_stack_sp&quot;</span>.
    This variable is declared by the <span class="Li">&quot;dSP&quot;</span>
    macro - though it is normally implied by XSUBs and similar so it is rare you
    have to consider it directly. Once declared, the
    <span class="Li">&quot;PUSH&quot;</span> macros will operate only on this
    local variable, so before invoking any other perl core functions you must
    use the <span class="Li">&quot;PUTBACK&quot;</span> macro to return the
    value from the local <span class="Li">&quot;SP&quot;</span> variable back to
    the interpreter variable. Similarly, after calling a perl core function
    which may have had reason to move the stack or push/pop values to it, you
    must use the <span class="Li">&quot;SPAGAIN&quot;</span> macro which
    refreshes the local <span class="Li">&quot;SP&quot;</span> value back from
    the interpreter one.</p>
<p class="Pp">Items are popped from the stack by using the
    <span class="Li">&quot;POPs&quot;</span> macro or its typed versions, There
    is also a macro <span class="Li">&quot;TOPs&quot;</span> that inspects the
    topmost item without removing it.</p>
<p class="Pp">Note specifically that SV pointers on the value stack do not
    contribute to the overall reference count of the xVs being referred to. If
    newly-created xVs are being pushed to the stack you must arrange for them to
    be destroyed at a suitable time; usually by using one of the
    <span class="Li">&quot;mPUSH*&quot;</span> macros or
    <span class="Li">&quot;sv_2mortal()&quot;</span> to mortalise the xV.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Mark_Stack"><a class="permalink" href="#Mark_Stack">Mark
  Stack</a></h2>
<p class="Pp">The value stack stores individual perl scalar values as
    temporaries between expressions. Some perl expressions operate on entire
    lists; for that purpose we need to know where on the stack each list begins.
    This is the purpose of the mark stack.</p>
<p class="Pp">The mark stack stores integers as I32 values, which are the height
    of the value stack at the time before the list began; thus the mark itself
    actually points to the value stack entry one before the list. The list
    itself starts at <span class="Li">&quot;mark + 1&quot;</span>.</p>
<p class="Pp">The base of this stack is pointed to by the interpreter variable
    <span class="Li">&quot;PL_markstack&quot;</span>, of type
    <span class="Li">&quot;I32 *&quot;</span>.</p>
<p class="Pp">The head of the stack is
    <span class="Li">&quot;PL_markstack_ptr&quot;</span>, and points to the most
    recently-pushed item.</p>
<p class="Pp">Items are pushed to the stack by using the
    <span class="Li">&quot;PUSHMARK()&quot;</span> macro. Even though the stack
    itself stores (value) stack indices as integers, the
    <span class="Li">&quot;PUSHMARK&quot;</span> macro should be given a stack
    pointer directly; it will calculate the index offset by comparing to the
    <span class="Li">&quot;PL_stack_sp&quot;</span> variable. Thus almost always
    the code to perform this is</p>
<p class="Pp"></p>
<pre>    PUSHMARK(SP);
</pre>
<p class="Pp">Items are popped from the stack by the
    <span class="Li">&quot;POPMARK&quot;</span> macro. There is also a macro
    <span class="Li">&quot;TOPMARK&quot;</span> that inspects the topmost item
    without removing it. These macros return I32 index values directly. There is
    also the <span class="Li">&quot;dMARK&quot;</span> macro which declares a
    new SV double-pointer variable, called
    <span class="Li">&quot;mark&quot;</span>, which points at the marked stack
    slot; this is the usual macro that C code will use when operating on lists
    given on the stack.</p>
<p class="Pp">As noted above, the <span class="Li">&quot;mark&quot;</span>
    variable itself will point at the most recently pushed value on the value
    stack before the list begins, and so the list itself starts at
    <span class="Li">&quot;mark + 1&quot;</span>. The values of the list may be
    iterated by code such as</p>
<p class="Pp"></p>
<pre>    for(SV **svp = mark + 1; svp &lt;= PL_stack_sp; svp++) {
      SV *item = *svp;
      ...
    }
</pre>
<p class="Pp">Note specifically in the case that the list is already empty,
    <span class="Li">&quot;mark&quot;</span> will equal
    <span class="Li">&quot;PL_stack_sp&quot;</span>.</p>
<p class="Pp">Because the <span class="Li">&quot;mark&quot;</span> variable is
    converted to a pointer on the value stack, extra care must be taken if
    <span class="Li">&quot;EXTEND&quot;</span> or any of the
    <span class="Li">&quot;XPUSH&quot;</span> macros are invoked within the
    function, because the stack may need to be moved to extend it and so the
    existing pointer will now be invalid. If this may be a problem, a possible
    solution is to track the mark offset as an integer and track the mark itself
    later on after the stack had been moved.</p>
<p class="Pp"></p>
<pre>    I32 markoff = POPMARK;
    ...
    SP **mark = PL_stack_base + markoff;
</pre>
</section>
<section class="Ss">
<h2 class="Ss" id="Temporaries_Stack"><a class="permalink" href="#Temporaries_Stack">Temporaries
  Stack</a></h2>
<p class="Pp">As noted above, xV references on the main value stack do not
    contribute to the reference count of an xV, and so another mechanism is used
    to track when temporary values which live on the stack must be released.
    This is the job of the temporaries stack.</p>
<p class="Pp">The temporaries stack stores pointers to xVs whose reference
    counts will be decremented soon.</p>
<p class="Pp">The base of this stack is pointed to by the interpreter variable
    <span class="Li">&quot;PL_tmps_stack&quot;</span>, of type
    <span class="Li">&quot;SV **&quot;</span>.</p>
<p class="Pp">The head of the stack is indexed by
    <span class="Li">&quot;PL_tmps_ix&quot;</span>, an integer which stores the
    index in the array of the most recently-pushed item.</p>
<p class="Pp">There is no public API to directly push items to the temporaries
    stack. Instead, the API function
    <span class="Li">&quot;sv_2mortal()&quot;</span> is used to mortalize an xV,
    adding its address to the temporaries stack.</p>
<p class="Pp">Likewise, there is no public API to read values from the
    temporaries stack. Instead, the macros
    <span class="Li">&quot;SAVETMPS&quot;</span> and
    <span class="Li">&quot;FREETMPS&quot;</span> are used. The
    <span class="Li">&quot;SAVETMPS&quot;</span> macro establishes the base
    levels of the temporaries stack, by capturing the current value of
    <span class="Li">&quot;PL_tmps_ix&quot;</span> into
    <span class="Li">&quot;PL_tmps_floor&quot;</span> and saving the previous
    value to the save stack. Thereafter, whenever
    <span class="Li">&quot;FREETMPS&quot;</span> is invoked all of the
    temporaries that have been pushed since that level are reclaimed.</p>
<p class="Pp">While it is common to see these two macros in pairs within an
    <span class="Li">&quot;ENTER&quot;</span>/
    <span class="Li">&quot;LEAVE&quot;</span> pair, it is not necessary to match
    them. It is permitted to invoke <span class="Li">&quot;FREETMPS&quot;</span>
    multiple times since the most recent
    <span class="Li">&quot;SAVETMPS&quot;</span>; for example in a loop
    iterating over elements of a list. While you can invoke
    <span class="Li">&quot;SAVETMPS&quot;</span> multiple times within a scope
    pair, it is unlikely to be useful. Subsequent invocations will move the
    temporaries floor further up, thus effectively trapping the existing
    temporaries to only be released at the end of the scope.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Save_Stack"><a class="permalink" href="#Save_Stack">Save
  Stack</a></h2>
<p class="Pp">The save stack is used by perl to implement the
    <span class="Li">&quot;local&quot;</span> keyword and other similar
    behaviours; any cleanup operations that need to be performed when leaving
    the current scope. Items pushed to this stack generally capture the current
    value of some internal variable or state, which will be restored when the
    scope is unwound due to leaving, <span class="Li">&quot;return&quot;</span>,
    <span class="Li">&quot;die&quot;</span>,
    <span class="Li">&quot;goto&quot;</span> or other reasons.</p>
<p class="Pp">Whereas other perl internal stacks store individual items all of
    the same type (usually SV pointers or integers), the items pushed to the
    save stack are formed of many different types, having multiple fields to
    them. For example, the <span class="Li">&quot;SAVEt_INT&quot;</span> type
    needs to store both the address of the
    <span class="Li">&quot;int&quot;</span> variable to restore, and the value
    to restore it to. This information could have been stored using fields of a
    <span class="Li">&quot;struct&quot;</span>, but would have to be large
    enough to store three pointers in the largest case, which would waste a lot
    of space in most of the smaller cases.</p>
<p class="Pp">Instead, the stack stores information in a variable-length
    encoding of <span class="Li">&quot;ANY&quot;</span> structures. The final
    value pushed is stored in the <span class="Li">&quot;UV&quot;</span> field
    which encodes the kind of item held by the preceeding items; the count and
    types of which will depend on what kind of item is being stored. The kind
    field is pushed last because that will be the first field to be popped when
    unwinding items from the stack.</p>
<p class="Pp">The base of this stack is pointed to by the interpreter variable
    <span class="Li">&quot;PL_savestack&quot;</span>, of type
    <span class="Li">&quot;ANY *&quot;</span>.</p>
<p class="Pp">The head of the stack is indexed by
    <span class="Li">&quot;PL_savestack_ix&quot;</span>, an integer which stores
    the index in the array at which the next item should be pushed. (Note that
    this is different to most other stacks, which reference the most
    recently-pushed item).</p>
<p class="Pp">Items are pushed to the save stack by using the various
    <span class="Li">&quot;SAVE...()&quot;</span> macros. Many of these macros
    take a variable and store both its address and current value on the save
    stack, ensuring that value gets restored on scope exit.</p>
<p class="Pp"></p>
<pre>    SAVEI8(i8)
    SAVEI16(i16)
    SAVEI32(i32)
    SAVEINT(i)
    ...
</pre>
<p class="Pp">There are also a variety of other special-purpose macros which
    save particular types or values of interest.
    <span class="Li">&quot;SAVETMPS&quot;</span> has already been mentioned
    above. Others include <span class="Li">&quot;SAVEFREEPV&quot;</span> which
    arranges for a PV (i.e. a string buffer) to be freed, or
    <span class="Li">&quot;SAVEDESTRUCTOR&quot;</span> which arranges for a
    given function pointer to be invoked on scope exit. A full list of such
    macros can be found in <i>scope.h</i>.</p>
<p class="Pp">There is no public API for popping individual values or items from
    the save stack. Instead, via the scope stack, the
    <span class="Li">&quot;ENTER&quot;</span> and
    <span class="Li">&quot;LEAVE&quot;</span> pair form a way to start and stop
    nested scopes. Leaving a nested scope via
    <span class="Li">&quot;LEAVE&quot;</span> will restore all of the saved
    values that had been pushed since the most recent
    <span class="Li">&quot;ENTER&quot;</span>.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Scope_Stack"><a class="permalink" href="#Scope_Stack">Scope
  Stack</a></h2>
<p class="Pp">As with the mark stack to the value stack, the scope stack forms a
    pair with the save stack. The scope stack stores the height of the save
    stack at which nested scopes begin, and allows the save stack to be unwound
    back to that point when the scope is left.</p>
<p class="Pp">When perl is built with debugging enabled, there is a second part
    to this stack storing human-readable string names describing the type of
    stack context. Each push operation saves the name as well as the height of
    the save stack, and each pop operation checks the topmost name with what is
    expected, causing an assertion failure if the name does not match.</p>
<p class="Pp">The base of this stack is pointed to by the interpreter variable
    <span class="Li">&quot;PL_scopestack&quot;</span>, of type
    <span class="Li">&quot;I32 *&quot;</span>. If enabled, the scope stack names
    are stored in a separate array pointed to by
    <span class="Li">&quot;PL_scopestack_name&quot;</span>, of type
    <span class="Li">&quot;const char **&quot;</span>.</p>
<p class="Pp">The head of the stack is indexed by
    <span class="Li">&quot;PL_scopestack_ix&quot;</span>, an integer which
    stores the index of the array or arrays at which the next item should be
    pushed. (Note that this is different to most other stacks, which reference
    the most recently-pushed item).</p>
<p class="Pp">Values are pushed to the scope stack using the
    <span class="Li">&quot;ENTER&quot;</span> macro, which begins a new nested
    scope. Any items pushed to the save stack are then restored at the next
    nested invocation of the <span class="Li">&quot;LEAVE&quot;</span>
  macro.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="Dynamic_Scope_and_the_Context_Stack"><a class="permalink" href="#Dynamic_Scope_and_the_Context_Stack">Dynamic
  Scope and the Context Stack</a></h1>
<p class="Pp"><b>Note:</b> this section describes a non-public internal API that
    is subject to change without notice.</p>
<section class="Ss">
<h2 class="Ss" id="Introduction_to_the_context_stack"><a class="permalink" href="#Introduction_to_the_context_stack">Introduction
  to the context stack</a></h2>
<p class="Pp">In Perl, dynamic scoping refers to the runtime nesting of things
    like subroutine calls, evals etc, as well as the entering and exiting of
    block scopes. For example, the restoring of a
    <span class="Li">&quot;local&quot;</span>ised variable is determined by the
    dynamic scope.</p>
<p class="Pp">Perl tracks the dynamic scope by a data structure called the
    context stack, which is an array of
    <span class="Li">&quot;PERL_CONTEXT&quot;</span> structures, and which is
    itself a big union for all the types of context. Whenever a new scope is
    entered (such as a block, a <span class="Li">&quot;for&quot;</span> loop, or
    a subroutine call), a new context entry is pushed onto the stack. Similarly
    when leaving a block or returning from a subroutine call etc. a context is
    popped. Since the context stack represents the current dynamic scope, it can
    be searched. For example, <span class="Li">&quot;next LABEL&quot;</span>
    searches back through the stack looking for a loop context that matches the
    label; <span class="Li">&quot;return&quot;</span> pops contexts until it
    finds a sub or eval context or similar;
    <span class="Li">&quot;caller&quot;</span> examines sub contexts on the
    stack.</p>
<p class="Pp">Each context entry is labelled with a context type,
    <span class="Li">&quot;cx_type&quot;</span>. Typical context types are
    <span class="Li">&quot;CXt_SUB&quot;</span>,
    <span class="Li">&quot;CXt_EVAL&quot;</span> etc., as well as
    <span class="Li">&quot;CXt_BLOCK&quot;</span> and
    <span class="Li">&quot;CXt_NULL&quot;</span> which represent a basic scope
    (as pushed by <span class="Li">&quot;pp_enter&quot;</span>) and a sort
    block. The type determines which part of the context union are valid.</p>
<p class="Pp">The main division in the context struct is between a substitution
    scope (<span class="Li">&quot;CXt_SUBST&quot;</span>) and block scopes,
    which are everything else. The former is just used while executing
    <span class="Li">&quot;s///e&quot;</span>, and won't be discussed further
    here.</p>
<p class="Pp">All the block scope types share a common base, which corresponds
    to <span class="Li">&quot;CXt_BLOCK&quot;</span>. This stores the old values
    of various scope-related variables like
    <span class="Li">&quot;PL_curpm&quot;</span>, as well as information about
    the current scope, such as <span class="Li">&quot;gimme&quot;</span>. On
    scope exit, the old variables are restored.</p>
<p class="Pp">Particular block scope types store extra per-type information. For
    example, <span class="Li">&quot;CXt_SUB&quot;</span> stores the currently
    executing CV, while the various for loop types might hold the original loop
    variable SV. On scope exit, the per-type data is processed; for example the
    CV has its reference count decremented, and the original loop variable is
    restored.</p>
<p class="Pp">The macro <span class="Li">&quot;cxstack&quot;</span> returns the
    base of the current context stack, while
    <span class="Li">&quot;cxstack_ix&quot;</span> is the index of the current
    frame within that stack.</p>
<p class="Pp">In fact, the context stack is actually part of a stack-of-stacks
    system; whenever something unusual is done such as calling a
    <span class="Li">&quot;DESTROY&quot;</span> or tie handler, a new stack is
    pushed, then popped at the end.</p>
<p class="Pp">Note that the API described here changed considerably in perl
    5.24; prior to that, big macros like
    <span class="Li">&quot;PUSHBLOCK&quot;</span> and
    <span class="Li">&quot;POPSUB&quot;</span> were used; in 5.24 they were
    replaced by the inline static functions described below. In addition, the
    ordering and detail of how these macros/function work changed in many ways,
    often subtly. In particular they didn't handle saving the savestack and
    temps stack positions, and required additional
    <span class="Li">&quot;ENTER&quot;</span>,
    <span class="Li">&quot;SAVETMPS&quot;</span> and
    <span class="Li">&quot;LEAVE&quot;</span> compared to the new functions. The
    old-style macros will not be described further.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Pushing_contexts"><a class="permalink" href="#Pushing_contexts">Pushing
  contexts</a></h2>
<p class="Pp">For pushing a new context, the two basic functions are
    <span class="Li">&quot;cx = cx_pushblock()&quot;</span>, which pushes a new
    basic context block and returns its address, and a family of similar
    functions with names like <span class="Li">&quot;cx_pushsub(cx)&quot;</span>
    which populate the additional type-dependent fields in the
    <span class="Li">&quot;cx&quot;</span> struct. Note that
    <span class="Li">&quot;CXt_NULL&quot;</span> and
    <span class="Li">&quot;CXt_BLOCK&quot;</span> don't have their own push
    functions, as they don't store any data beyond that pushed by
    <span class="Li">&quot;cx_pushblock&quot;</span>.</p>
<p class="Pp">The fields of the context struct and the arguments to the
    <span class="Li">&quot;cx_*&quot;</span> functions are subject to change
    between perl releases, representing whatever is convenient or efficient for
    that release.</p>
<p class="Pp">A typical context stack pushing can be found in
    <span class="Li">&quot;pp_entersub&quot;</span>; the following shows a
    simplified and stripped-down example of a non-XS call, along with comments
    showing roughly what each function does.</p>
<p class="Pp"></p>
<pre> dMARK;
 U8 gimme      = GIMME_V;
 bool hasargs  = cBOOL(PL_op-&gt;op_flags &amp; OPf_STACKED);
 OP *retop     = PL_op-&gt;op_next;
 I32 old_ss_ix = PL_savestack_ix;
 CV *cv        = ....;
 /* ... make mortal copies of stack args which are PADTMPs here ... */
 /* ... do any additional savestack pushes here ... */
 /* Now push a new context entry of type 'CXt_SUB'; initially just
  * doing the actions common to all block types: */
 cx = cx_pushblock(CXt_SUB, gimme, MARK, old_ss_ix);
     /* this does (approximately):
         CXINC;              /* cxstack_ix++ (grow if necessary) */
         cx = CX_CUR();      /* and get the address of new frame */
         cx-&gt;cx_type        = CXt_SUB;
         cx-&gt;blk_gimme      = gimme;
         cx-&gt;blk_oldsp      = MARK - PL_stack_base;
         cx-&gt;blk_oldsaveix  = old_ss_ix;
         cx-&gt;blk_oldcop     = PL_curcop;
         cx-&gt;blk_oldmarksp  = PL_markstack_ptr - PL_markstack;
         cx-&gt;blk_oldscopesp = PL_scopestack_ix;
         cx-&gt;blk_oldpm      = PL_curpm;
         cx-&gt;blk_old_tmpsfloor = PL_tmps_floor;
         PL_tmps_floor        = PL_tmps_ix;
     */
 /* then update the new context frame with subroutine-specific info,
  * such as the CV about to be executed: */
 cx_pushsub(cx, cv, retop, hasargs);
     /* this does (approximately):
         cx-&gt;blk_sub.cv          = cv;
         cx-&gt;blk_sub.olddepth    = CvDEPTH(cv);
         cx-&gt;blk_sub.prevcomppad = PL_comppad;
         cx-&gt;cx_type            |= (hasargs) ? CXp_HASARGS : 0;
         cx-&gt;blk_sub.retop       = retop;
         SvREFCNT_inc_simple_void_NN(cv);
     */
</pre>
<p class="Pp">Note that <span class="Li">&quot;cx_pushblock()&quot;</span> sets
    two new floors: for the args stack (to
    <span class="Li">&quot;MARK&quot;</span>) and the temps stack (to
    <span class="Li">&quot;PL_tmps_ix&quot;</span>). While executing at this
    scope level, every <span class="Li">&quot;nextstate&quot;</span> (amongst
    others) will reset the args and tmps stack levels to these floors. Note that
    since <span class="Li">&quot;cx_pushblock&quot;</span> uses the current
    value of <span class="Li">&quot;PL_tmps_ix&quot;</span> rather than it being
    passed as an arg, this dictates at what point
    <span class="Li">&quot;cx_pushblock&quot;</span> should be called. In
    particular, any new mortals which should be freed only on scope exit (rather
    than at the next <span class="Li">&quot;nextstate&quot;</span>) should be
    created first.</p>
<p class="Pp">Most callers of <span class="Li">&quot;cx_pushblock&quot;</span>
    simply set the new args stack floor to the top of the previous stack frame,
    but for <span class="Li">&quot;CXt_LOOP_LIST&quot;</span> it stores the
    items being iterated over on the stack, and so sets
    <span class="Li">&quot;blk_oldsp&quot;</span> to the top of these items
    instead. Note that, contrary to its name,
    <span class="Li">&quot;blk_oldsp&quot;</span> doesn't always represent the
    value to restore <span class="Li">&quot;PL_stack_sp&quot;</span> to on scope
    exit.</p>
<p class="Pp">Note the early capture of
    <span class="Li">&quot;PL_savestack_ix&quot;</span> to
    <span class="Li">&quot;old_ss_ix&quot;</span>, which is later passed as an
    arg to <span class="Li">&quot;cx_pushblock&quot;</span>. In the case of
    <span class="Li">&quot;pp_entersub&quot;</span>, this is because, although
    most values needing saving are stored in fields of the context struct, an
    extra value needs saving only when the debugger is running, and it doesn't
    make sense to bloat the struct for this rare case. So instead it is saved on
    the savestack. Since this value gets calculated and saved before the context
    is pushed, it is necessary to pass the old value of
    <span class="Li">&quot;PL_savestack_ix&quot;</span> to
    <span class="Li">&quot;cx_pushblock&quot;</span>, to ensure that the saved
    value gets freed during scope exit. For most users of
    <span class="Li">&quot;cx_pushblock&quot;</span>, where nothing needs
    pushing on the save stack,
    <span class="Li">&quot;PL_savestack_ix&quot;</span> is just passed directly
    as an arg to <span class="Li">&quot;cx_pushblock&quot;</span>.</p>
<p class="Pp">Note that where possible, values should be saved in the context
    struct rather than on the save stack; it's much faster that way.</p>
<p class="Pp">Normally <span class="Li">&quot;cx_pushblock&quot;</span> should
    be immediately followed by the appropriate
    <span class="Li">&quot;cx_pushfoo&quot;</span>, with nothing between them;
    this is because if code in-between could die (e.g. a warning upgraded to
    fatal), then the context stack unwinding code in
    <span class="Li">&quot;dounwind&quot;</span> would see (in the example
    above) a <span class="Li">&quot;CXt_SUB&quot;</span> context frame, but
    without all the subroutine-specific fields set, and crashes would soon
    ensue.</p>
<p class="Pp">Where the two must be separate, initially set the type to
    <span class="Li">&quot;CXt_NULL&quot;</span> or
    <span class="Li">&quot;CXt_BLOCK&quot;</span>, and later change it to
    <span class="Li">&quot;CXt_foo&quot;</span> when doing the
    <span class="Li">&quot;cx_pushfoo&quot;</span>. This is exactly what
    <span class="Li">&quot;pp_enteriter&quot;</span> does, once it's determined
    which type of loop it's pushing.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Popping_contexts"><a class="permalink" href="#Popping_contexts">Popping
  contexts</a></h2>
<p class="Pp">Contexts are popped using
    <span class="Li">&quot;cx_popsub()&quot;</span> etc. and
    <span class="Li">&quot;cx_popblock()&quot;</span>. Note however, that unlike
    <span class="Li">&quot;cx_pushblock&quot;</span>, neither of these functions
    actually decrement the current context stack index; this is done separately
    using <span class="Li">&quot;CX_POP()&quot;</span>.</p>
<p class="Pp">There are two main ways that contexts are popped. During normal
    execution as scopes are exited, functions like
    <span class="Li">&quot;pp_leave&quot;</span>,
    <span class="Li">&quot;pp_leaveloop&quot;</span> and
    <span class="Li">&quot;pp_leavesub&quot;</span> process and pop just one
    context using <span class="Li">&quot;cx_popfoo&quot;</span> and
    <span class="Li">&quot;cx_popblock&quot;</span>. On the other hand, things
    like <span class="Li">&quot;pp_return&quot;</span> and
    <span class="Li">&quot;next&quot;</span> may have to pop back several scopes
    until a sub or loop context is found, and exceptions (such as
    <span class="Li">&quot;die&quot;</span>) need to pop back contexts until an
    eval context is found. Both of these are accomplished by
    <span class="Li">&quot;dounwind()&quot;</span>, which is capable of
    processing and popping all contexts above the target one.</p>
<p class="Pp">Here is a typical example of context popping, as found in
    <span class="Li">&quot;pp_leavesub&quot;</span> (simplified slightly):</p>
<p class="Pp"></p>
<pre> U8 gimme;
 PERL_CONTEXT *cx;
 SV **oldsp;
 OP *retop;
 cx = CX_CUR();
 gimme = cx-&gt;blk_gimme;
 oldsp = PL_stack_base + cx-&gt;blk_oldsp; /* last arg of previous frame */
 if (gimme == G_VOID)
     PL_stack_sp = oldsp;
 else
     leave_adjust_stacks(oldsp, oldsp, gimme, 0);
 CX_LEAVE_SCOPE(cx);
 cx_popsub(cx);
 cx_popblock(cx);
 retop = cx-&gt;blk_sub.retop;
 CX_POP(cx);
 return retop;
</pre>
<p class="Pp">The steps above are in a very specific order, designed to be the
    reverse order of when the context was pushed. The first thing to do is to
    copy and/or protect any return arguments and free any temps in the current
    scope. Scope exits like an rvalue sub normally return a mortal copy of their
    return args (as opposed to lvalue subs). It is important to make this copy
    before the save stack is popped or variables are restored, or bad things
    like the following can happen:</p>
<p class="Pp"></p>
<pre>    sub f { my $x =...; $x }  # $x freed before we get to copy it
    sub f { /(...)/;    $1 }  # PL_curpm restored before $1 copied
</pre>
<p class="Pp">Although we wish to free any temps at the same time, we have to be
    careful not to free any temps which are keeping return args alive; nor to
    free the temps we have just created while mortal copying return args.
    Fortunately, <span class="Li">&quot;leave_adjust_stacks()&quot;</span> is
    capable of making mortal copies of return args, shifting args down the
    stack, and only processing those entries on the temps stack that are safe to
    do so.</p>
<p class="Pp">In void context no args are returned, so it's more efficient to
    skip calling <span class="Li">&quot;leave_adjust_stacks()&quot;</span>. Also
    in void context, a <span class="Li">&quot;nextstate&quot;</span> op is
    likely to be imminently called which will do a
    <span class="Li">&quot;FREETMPS&quot;</span>, so there's no need to do that
    either.</p>
<p class="Pp">The next step is to pop savestack entries:
    <span class="Li">&quot;CX_LEAVE_SCOPE(cx)&quot;</span> is just defined as
    <span class="Li">&quot;LEAVE_SCOPE(cx-&gt;blk_oldsaveix)&quot;</span>. Note
    that during the popping, it's possible for perl to call destructors, call
    <span class="Li">&quot;STORE&quot;</span> to undo localisations of tied
    vars, and so on. Any of these can die or call
    <span class="Li">&quot;exit()&quot;</span>. In this case,
    <span class="Li">&quot;dounwind()&quot;</span> will be called, and the
    current context stack frame will be re-processed. Thus it is vital that all
    steps in popping a context are done in such a way to support reentrancy. The
    other alternative, of decrementing
    <span class="Li">&quot;cxstack_ix&quot;</span> <i>before</i> processing the
    frame, would lead to leaks and the like if something died halfway through,
    or overwriting of the current frame.</p>
<p class="Pp"><span class="Li">&quot;CX_LEAVE_SCOPE&quot;</span> itself is
    safely re-entrant: if only half the savestack items have been popped before
    dying and getting trapped by eval, then the
    <span class="Li">&quot;CX_LEAVE_SCOPE&quot;</span>s in
    <span class="Li">&quot;dounwind&quot;</span> or
    <span class="Li">&quot;pp_leaveeval&quot;</span> will continue where the
    first one left off.</p>
<p class="Pp">The next step is the type-specific context processing; in this
    case <span class="Li">&quot;cx_popsub&quot;</span>. In part, this looks
    like:</p>
<p class="Pp"></p>
<pre>    cv = cx-&gt;blk_sub.cv;
    CvDEPTH(cv) = cx-&gt;blk_sub.olddepth;
    cx-&gt;blk_sub.cv = NULL;
    SvREFCNT_dec(cv);
</pre>
<p class="Pp">where its processing the just-executed CV. Note that before it
    decrements the CV's reference count, it nulls the
    <span class="Li">&quot;blk_sub.cv&quot;</span>. This means that if it
    re-enters, the CV won't be freed twice. It also means that you can't rely on
    such type-specific fields having useful values after the return from
    <span class="Li">&quot;cx_popfoo&quot;</span>.</p>
<p class="Pp">Next, <span class="Li">&quot;cx_popblock&quot;</span> restores all
    the various interpreter vars to their previous values or previous high water
    marks; it expands to:</p>
<p class="Pp"></p>
<pre>    PL_markstack_ptr = PL_markstack + cx-&gt;blk_oldmarksp;
    PL_scopestack_ix = cx-&gt;blk_oldscopesp;
    PL_curpm         = cx-&gt;blk_oldpm;
    PL_curcop        = cx-&gt;blk_oldcop;
    PL_tmps_floor    = cx-&gt;blk_old_tmpsfloor;
</pre>
<p class="Pp">Note that it <i>doesn't</i> restore
    <span class="Li">&quot;PL_stack_sp&quot;</span>; as mentioned earlier, which
    value to restore it to depends on the context type (specifically
    <span class="Li">&quot;for (list) {}&quot;</span>), and what args (if any)
    it returns; and that will already have been sorted out earlier by
    <span class="Li">&quot;leave_adjust_stacks()&quot;</span>.</p>
<p class="Pp">Finally, the context stack pointer is actually decremented by
    <span class="Li">&quot;CX_POP(cx)&quot;</span>. After this point, it's
    possible that that the current context frame could be overwritten by other
    contexts being pushed. Although things like ties and
    <span class="Li">&quot;DESTROY&quot;</span> are supposed to work within a
    new context stack, it's best not to assume this. Indeed on debugging builds,
    <span class="Li">&quot;CX_POP(cx)&quot;</span> deliberately sets
    <span class="Li">&quot;cx&quot;</span> to null to detect code that is still
    relying on the field values in that context frame. Note in the
    <span class="Li">&quot;pp_leavesub()&quot;</span> example above, we grab
    <span class="Li">&quot;blk_sub.retop&quot;</span> <i>before</i> calling
    <span class="Li">&quot;CX_POP&quot;</span>.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Redoing_contexts"><a class="permalink" href="#Redoing_contexts">Redoing
  contexts</a></h2>
<p class="Pp">Finally, there is
    <span class="Li">&quot;cx_topblock(cx)&quot;</span>, which acts like a
    super-<span class="Li">&quot;nextstate&quot;</span> as regards to resetting
    various vars to their base values. It is used in places like
    <span class="Li">&quot;pp_next&quot;</span>,
    <span class="Li">&quot;pp_redo&quot;</span> and
    <span class="Li">&quot;pp_goto&quot;</span> where rather than exiting a
    scope, we want to re-initialise the scope. As well as resetting
    <span class="Li">&quot;PL_stack_sp&quot;</span> like
    <span class="Li">&quot;nextstate&quot;</span>, it also resets
    <span class="Li">&quot;PL_markstack_ptr&quot;</span>,
    <span class="Li">&quot;PL_scopestack_ix&quot;</span> and
    <span class="Li">&quot;PL_curpm&quot;</span>. Note that it doesn't do a
    <span class="Li">&quot;FREETMPS&quot;</span>.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="Slab-based_operator_allocation"><a class="permalink" href="#Slab-based_operator_allocation">Slab-based
  operator allocation</a></h1>
<p class="Pp"><b>Note:</b> this section describes a non-public internal API that
    is subject to change without notice.</p>
<p class="Pp">Perl's internal error-handling mechanisms implement
    <span class="Li">&quot;die&quot;</span> (and its internal equivalents) using
    longjmp. If this occurs during lexing, parsing or compilation, we must
    ensure that any ops allocated as part of the compilation process are freed.
    (Older Perl versions did not adequately handle this situation: when failing
    a parse, they would leak ops that were stored in C
    <span class="Li">&quot;auto&quot;</span> variables and not linked anywhere
    else.)</p>
<p class="Pp">To handle this situation, Perl uses <i>op slabs</i> that are
    attached to the currently-compiling CV. A slab is a chunk of allocated
    memory. New ops are allocated as regions of the slab. If the slab fills up,
    a new one is created (and linked from the previous one). When an error
    occurs and the CV is freed, any ops remaining are freed.</p>
<p class="Pp">Each op is preceded by two pointers: one points to the next op in
    the slab, and the other points to the slab that owns it. The next-op pointer
    is needed so that Perl can iterate over a slab and free all its ops. (Op
    structures are of different sizes, so the slab's ops can't merely be treated
    as a dense array.) The slab pointer is needed for accessing a reference
    count on the slab: when the last op on a slab is freed, the slab itself is
    freed.</p>
<p class="Pp">The slab allocator puts the ops at the end of the slab first. This
    will tend to allocate the leaves of the op tree first, and the layout will
    therefore hopefully be cache-friendly. In addition, this means that there's
    no need to store the size of the slab (see below on why slabs vary in size),
    because Perl can follow pointers to find the last op.</p>
<p class="Pp">It might seem possible to eliminate slab reference counts
    altogether, by having all ops implicitly attached to
    <span class="Li">&quot;PL_compcv&quot;</span> when allocated and freed when
    the CV is freed. That would also allow
    <span class="Li">&quot;op_free&quot;</span> to skip
    <span class="Li">&quot;FreeOp&quot;</span> altogether, and thus free ops
    faster. But that doesn't work in those cases where ops need to survive
    beyond their CVs, such as re-evals.</p>
<p class="Pp">The CV also has to have a reference count on the slab. Sometimes
    the first op created is immediately freed. If the reference count of the
    slab reaches 0, then it will be freed with the CV still pointing to it.</p>
<p class="Pp">CVs use the <span class="Li">&quot;CVf_SLABBED&quot;</span> flag
    to indicate that the CV has a reference count on the slab. When this flag is
    set, the slab is accessible via <span class="Li">&quot;CvSTART&quot;</span>
    when <span class="Li">&quot;CvROOT&quot;</span> is not set, or by
    subtracting two pointers <span class="Li">&quot;(2*sizeof(I32
    *))&quot;</span> from <span class="Li">&quot;CvROOT&quot;</span> when it is
    set. The alternative to this approach of sneaking the slab into
    <span class="Li">&quot;CvSTART&quot;</span> during compilation would be to
    enlarge the <span class="Li">&quot;xpvcv&quot;</span> struct by another
    pointer. But that would make all CVs larger, even though slab-based op
    freeing is typically of benefit only for programs that make significant use
    of string eval.</p>
<p class="Pp">When the <span class="Li">&quot;CVf_SLABBED&quot;</span> flag is
    set, the CV takes responsibility for freeing the slab. If
    <span class="Li">&quot;CvROOT&quot;</span> is not set when the CV is freed
    or undeffed, it is assumed that a compilation error has occurred, so the op
    slab is traversed and all the ops are freed.</p>
<p class="Pp">Under normal circumstances, the CV forgets about its slab
    (decrementing the reference count) when the root is attached. So the slab
    reference counting that happens when ops are freed takes care of freeing the
    slab. In some cases, the CV is told to forget about the slab
    (<span class="Li">&quot;cv_forget_slab&quot;</span>) precisely so that the
    ops can survive after the CV is done away with.</p>
<p class="Pp">Forgetting the slab when the root is attached is not strictly
    necessary, but avoids potential problems with
    <span class="Li">&quot;CvROOT&quot;</span> being written over. There is code
    all over the place, both in core and on CPAN, that does things with
    <span class="Li">&quot;CvROOT&quot;</span>, so forgetting the slab makes
    things more robust and avoids potential problems.</p>
<p class="Pp">Since the CV takes ownership of its slab when flagged, that flag
    is never copied when a CV is cloned, as one CV could free a slab that
    another CV still points to, since forced freeing of ops ignores the
    reference count (but asserts that it looks right).</p>
<p class="Pp">To avoid slab fragmentation, freed ops are marked as freed and
    attached to the slab's freed chain (an idea stolen from DBM::Deep). Those
    freed ops are reused when possible. Not reusing freed ops would be simpler,
    but it would result in significantly higher memory usage for programs with
    large <span class="Li">&quot;if (DEBUG) {...}&quot;</span> blocks.</p>
<p class="Pp"><span class="Li">&quot;SAVEFREEOP&quot;</span> is slightly
    problematic under this scheme. Sometimes it can cause an op to be freed
    after its CV. If the CV has forcibly freed the ops on its slab and the slab
    itself, then we will be fiddling with a freed slab. Making
    <span class="Li">&quot;SAVEFREEOP&quot;</span> a no-op doesn't help, as
    sometimes an op can be savefreed when there is no compilation error, so the
    op would never be freed. It holds a reference count on the slab, so the
    whole slab would leak. So <span class="Li">&quot;SAVEFREEOP&quot;</span> now
    sets a special flag on the op
    (<span class="Li">&quot;-&gt;op_savefree&quot;</span>). The forced freeing
    of ops after a compilation error won't free any ops thus marked.</p>
<p class="Pp">Since many pieces of code create tiny subroutines consisting of
    only a few ops, and since a huge slab would be quite a bit of baggage for
    those to carry around, the first slab is always very small. To avoid
    allocating too many slabs for a single CV, each subsequent slab is twice the
    size of the previous.</p>
<p class="Pp">Smartmatch expects to be able to allocate an op at run time, run
    it, and then throw it away. For that to work the op is simply malloced when
    PL_compcv hasn't been set up. So all slab-allocated ops are marked as such
    (<span class="Li">&quot;-&gt;op_slabbed&quot;</span>), to distinguish them
    from malloced ops.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="AUTHORS"><a class="permalink" href="#AUTHORS">AUTHORS</a></h1>
<p class="Pp">Until May 1997, this document was maintained by Jeff Okamoto
    &lt;okamoto@corp.hp.com&gt;. It is now maintained as part of Perl itself by
    the Perl 5 Porters &lt;perl5-porters@perl.org&gt;.</p>
<p class="Pp">With lots of help and suggestions from Dean Roehrich, Malcolm
    Beattie, Andreas Koenig, Paul Hudson, Ilya Zakharevich, Paul Marquess, Neil
    Bowers, Matthew Green, Tim Bunce, Spider Boardman, Ulrich Pfeifer, Stephen
    McCamant, and Gurusamy Sarathy.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="SEE_ALSO"><a class="permalink" href="#SEE_ALSO">SEE
  ALSO</a></h1>
<p class="Pp">perlapi, perlintern, perlxs, perlembed</p>
</section>
</div>
<table class="foot">
  <tr>
    <td class="foot-date">2021-05-04</td>
    <td class="foot-os">perl v5.34.0</td>
  </tr>
</table>
</body>
</html>
