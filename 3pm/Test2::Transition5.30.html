<!DOCTYPE html>
<html>
<!-- This is an automatically generated file.  Do not edit.
   Automatically generated by Pod::Man 4.11 (Pod::Simple 3.35)
  
   Standard preamble:
   ========================================================================
   Vertical space (when we can't use .PP)
 -->
<head>
  <meta charset="utf-8"/>
  <link rel="stylesheet" href="../style.css" type="text/css" media="all"/>
  <title>Test2::Transition(3)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">Test2::Transition(3)</td>
    <td class="head-vol">User Contributed Perl Documentation</td>
    <td class="head-rtitle">Test2::Transition(3)</td>
  </tr>
</table>
<div class="manual-text">
<br/>
<section class="Sh">
<h1 class="Sh" id="NAME"><a class="permalink" href="#NAME">NAME</a></h1>
<p class="Pp">Test2::Transition - Transition notes when upgrading to Test2</p>
</section>
<section class="Sh">
<h1 class="Sh" id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">DESCRIPTION</a></h1>
<p class="Pp">This is where gotchas and breakages related to the Test2 upgrade
    are documented. The upgrade causes Test::Builder to defer to Test2 under the
    hood. This transition is mostly transparent, but there are a few cases that
    can trip you up.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="THINGS_THAT_BREAK"><a class="permalink" href="#THINGS_THAT_BREAK">THINGS
  THAT BREAK</a></h1>
<p class="Pp">This is the list of scenarios that break with the new
  internals.</p>
<section class="Ss">
<h2 class="Ss" id="Test::Builder1.5/2_conditionals"><a class="permalink" href="#Test::Builder1.5/2_conditionals">Test::Builder1.5/2
  conditionals</a></h2>
<p class="Pp"><i>The Problem</i></p>
<p class="Pp">a few years back there were two attempts to upgrade/replace
    Test::Builder. Confusingly these were called Test::Builder2 and
    Test::Builder1.5, in that order. Many people put conditionals in their code
    to check the Test::Builder version number and adapt their code
  accordingly.</p>
<p class="Pp">The Test::Builder2/1.5 projects both died out. Now the conditional
    code people added has become a mine field. A vast majority of modules broken
    by Test2 fall into this category.</p>
<p class="Pp"><i>The Fix</i></p>
<p class="Pp">The fix is to remove all Test::Builder1.5/2 related code. Either
    use the legacy Test::Builder API, or use Test2 directly.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Replacing_the_Test::Builder_singleton"><a class="permalink" href="#Replacing_the_Test::Builder_singleton">Replacing
  the Test::Builder singleton</a></h2>
<p class="Pp"><i>The Problem</i></p>
<p class="Pp">Some test modules would replace the Test::Builder singleton
    instance with their own instance or subclass. This was usually done to
    intercept or modify results as they happened.</p>
<p class="Pp">The Test::Builder singleton is now a simple compatibility wrapper
    around Test2. The Test::Builder singleton is no longer the central place for
    results. Many results bypass the Test::Builder singleton completely, which
    breaks and behavior intended when replacing the singleton.</p>
<p class="Pp"><i>The Fix</i></p>
<p class="Pp">If you simply want to intercept all results instead of letting
    them go to TAP, you should look at the Test2::API docs and read about
    pushing a new hub onto the hub stack. Replacing the hub temporarily is now
    the correct way to intercept results.</p>
<p class="Pp">If your goal is purely monitoring of events use the
    <span class="Li">&quot;Test2::Hub-&gt;listen()&quot;</span> method exported
    by Test::More to watch events as they are fired. If you wish to modify
    results before they go to TAP look at the
    <span class="Li">&quot;Test2::Hub-&gt;filter()&quot;</span> method.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Directly_Accessing_Hash_Elements"><a class="permalink" href="#Directly_Accessing_Hash_Elements">Directly
  Accessing Hash Elements</a></h2>
<p class="Pp"><i>The Problem</i></p>
<p class="Pp">Some modules look directly at hash keys on the Test::Builder
    singleton. The problem here is that the Test::Builder singleton no longer
    holds anything important.</p>
<p class="Pp"><i>The Fix</i></p>
<p class="Pp">The fix is to use the API specified in Test2::API to look at or
    modify state as needed.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Subtest_indentation"><a class="permalink" href="#Subtest_indentation">Subtest
  indentation</a></h2>
<p class="Pp"><i>The Problem</i></p>
<p class="Pp">An early change, in fact the change that made Test2 an idea, was a
    change to the indentation of the subtest note. It was decided it would be
    more readable to outdent the subtest note instead of having it inline with
    the subtest:</p>
<p class="Pp"></p>
<pre>
    # subtest foo
        ok 1 - blah
        1..1
    ok 1 - subtest foo
</pre>
<p class="Pp">The old style indented the note:</p>
<p class="Pp"></p>
<pre>
        # subtest foo
        ok 1 - blah
        1..1
    ok 1 - subtest foo
</pre>
<p class="Pp">This breaks tests that do string comparison of TAP output.</p>
<p class="Pp"><i>The Fix</i></p>
<p class="Pp"></p>
<pre>
    my $indent = $INC{'Test2/API.pm'} ? '' : '    ';

    is(
        $subtest_output,
        &quot;${indent}# subtest foo&quot;,
        &quot;Got subtest note&quot;
    );
</pre>
<p class="Pp">Check if <span class="Li">$INC{'Test2/API.pm'}</span> is set, if
    it is then no indentation should be expected. If it is not set, then the old
    Test::Builder is in use, indentation should be expected.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="DISTRIBUTIONS_THAT_BREAK_OR_NEED_TO_BE_UPGRADED"><a class="permalink" href="#DISTRIBUTIONS_THAT_BREAK_OR_NEED_TO_BE_UPGRADED">DISTRIBUTIONS
  THAT BREAK OR NEED TO BE UPGRADED</a></h1>
<p class="Pp">This is a list of cpan modules that have been known to have been
    broken by the upgrade at one point.</p>
<section class="Ss">
<h2 class="Ss">WORKS BUT TESTS WILL FAIL</h2>
<p class="Pp">These modules still function correctly, but their test suites will
    not pass. If you already have these modules installed then you can continue
    to use them. If you are trying to install them after upgrading Test::Builder
    you will need to force installation, or bypass the broken tests.</p>
<dl class="Bl-tag">
  <dt id="Test::DBIx::Class::Schema"><a class="permalink" href="#Test::DBIx::Class::Schema">Test::DBIx::Class::Schema</a></dt>
  <dd>This module has a test that appears to work around a Test::Builder bug.
      The bug appears to have been fixed by Test2, which means the workaround
      causes a failure. This can be easily updated, but nobody has done so yet.
    <p class="Pp">Known broken in versions: 1.0.9 and older</p>
  </dd>
  <dt id="Device::Chip"><a class="permalink" href="#Device::Chip">Device::Chip</a></dt>
  <dd>Tests break due to subtest indentation.
    <p class="Pp">Known broken in version 0.07. Apparently works fine in 0.06
        though. Patch has been submitted to fix the issue.</p>
  </dd>
</dl>
</section>
<section class="Ss">
<h2 class="Ss">UPGRADE SUGGESTED</h2>
<p class="Pp">These are modules that did not break, but had broken test suites
    that have since been fixed.</p>
<dl class="Bl-tag">
  <dt id="Test::Exception"><a class="permalink" href="#Test::Exception">Test::Exception</a></dt>
  <dd>Old versions work fine, but have a minor test name behavior that breaks
      with Test2. Old versions will no longer install because of this. The
      latest version on CPAN will install just fine. Upgrading is not required,
      but is recommended.
    <p class="Pp">Fixed in version: 0.43</p>
  </dd>
  <dt id="Data::Peek"><a class="permalink" href="#Data::Peek">Data::Peek</a></dt>
  <dd>Some tests depended on <span class="Li">$!</span> and
      <span class="Li">$?</span> being modified in subtle ways. A patch was
      applied to correct things that changed.
    <p class="Pp">The module itself works fine, there is no need to upgrade.</p>
    <p class="Pp">Fixed in version: 0.45</p>
  </dd>
  <dt id="circular::require"><a class="permalink" href="#circular::require">circular::require</a></dt>
  <dd>Some tests were fragile and required base.pm to be loaded at a late stage.
      Test2 was loading base.pm too early. The tests were updated to fix this.
    <p class="Pp">The module itself never broke, you do not need to upgrade.</p>
    <p class="Pp">Fixed in version: 0.12</p>
  </dd>
  <dt id="Test::Module::Used"><a class="permalink" href="#Test::Module::Used">Test::Module::Used</a></dt>
  <dd>A test worked around a now-fixed planning bug. There is no need to upgrade
      if you have an old version installed. New versions install fine if you
      want them.
    <p class="Pp">Fixed in version: 0.2.5</p>
  </dd>
  <dt id="Test::Moose::More"><a class="permalink" href="#Test::Moose::More">Test::Moose::More</a></dt>
  <dd>Some tests were fragile, but have been fixed. The actual breakage was from
      the subtest comment indentation change.
    <p class="Pp">No need to upgrade, old versions work fine. Only new versions
        will install.</p>
    <p class="Pp">Fixed in version: 0.025</p>
  </dd>
  <dt id="Test::FITesque"><a class="permalink" href="#Test::FITesque">Test::FITesque</a></dt>
  <dd>This was broken by a bugfix to how planning is done. The test was updated
      after the bugfix.
    <p class="Pp">Fixed in version: 0.04</p>
  </dd>
  <dt id="Test::Kit"><a class="permalink" href="#Test::Kit">Test::Kit</a></dt>
  <dd>Old versions work fine, but would not install because Test::Aggregate was
      in the dependency chain. An upgrade should not be needed.
    <p class="Pp">Fixed in version: 2.15</p>
  </dd>
  <dt id="autouse"><a class="permalink" href="#autouse">autouse</a></dt>
  <dd>A test broke because it depended on Scalar::Util not being loaded. Test2
      loads Scalar::Util. The test was updated to load Test2 after checking
      Scalar::Util's load status.
    <p class="Pp">There is no need to upgrade if you already have it
      installed.</p>
    <p class="Pp">Fixed in version: 1.11</p>
  </dd>
</dl>
</section>
<section class="Ss">
<h2 class="Ss">NEED TO UPGRADE</h2>
<dl class="Bl-tag">
  <dt id="Test::SharedFork"><a class="permalink" href="#Test::SharedFork">Test::SharedFork</a></dt>
  <dd>Old versions need to directly access Test::Builder singleton hash
      elements. The latest version on CPAN will still do this on old
      Test::Builder, but will defer to Test2::IPC on Test2.
    <p class="Pp">Fixed in version: 0.35</p>
  </dd>
  <dt id="Test::Builder::Clutch"><a class="permalink" href="#Test::Builder::Clutch">Test::Builder::Clutch</a></dt>
  <dd>This works by doing overriding methods on the singleton, and directly
      accessing hash values on the singleton. A new version has been released
      that uses the Test2 API to accomplish the same result in a saner way.
    <p class="Pp">Fixed in version: 0.07</p>
  </dd>
  <dt id="Test::Dist::VersionSync"><a class="permalink" href="#Test::Dist::VersionSync">Test::Dist::VersionSync</a></dt>
  <dd>This had Test::Builder2 conditionals. This was fixed by removing the
      conditionals.
    <p class="Pp">Fixed in version: 1.1.4</p>
  </dd>
  <dt id="Test::Modern"><a class="permalink" href="#Test::Modern">Test::Modern</a></dt>
  <dd>This relied on
      <span class="Li">&quot;Test::Builder-&gt;_try()&quot;</span> which was a
      private method, documented as something nobody should use. This was fixed
      by using a different tool.
    <p class="Pp">Fixed in version: 0.012</p>
  </dd>
  <dt id="Test::UseAllModules"><a class="permalink" href="#Test::UseAllModules">Test::UseAllModules</a></dt>
  <dd>Version 0.14 relied on
      <span class="Li">&quot;Test::Builder-&gt;history&quot;</span> which was
      available in Test::Builder 1.5. Versions 0.12 and 0.13 relied on other
      Test::Builder internals.
    <p class="Pp">Fixed in version: 0.15</p>
  </dd>
  <dt id="Test::More::Prefix"><a class="permalink" href="#Test::More::Prefix">Test::More::Prefix</a></dt>
  <dd>Worked by applying a role that wrapped
      <span class="Li">&quot;Test::Builder-&gt;_print_comment&quot;</span>.
      Fixed by adding an event filter that modifies the message instead when
      running under Test2.
    <p class="Pp">Fixed in version: 0.007</p>
  </dd>
</dl>
</section>
<section class="Ss">
<h2 class="Ss">STILL BROKEN</h2>
<dl class="Bl-tag">
  <dt id="Test::Aggregate"><a class="permalink" href="#Test::Aggregate">Test::Aggregate</a></dt>
  <dd>This distribution directly accesses the hash keys in the Test::Builder
      singleton. It also approaches the problem from the wrong angle, please
      consider using Test2::Aggregate for similar functionality and
      Test2::Harness which allows module preloading at the harness level.
    <p class="Pp">Still broken as of version: 0.373</p>
  </dd>
  <dt id="Test::Wrapper"><a class="permalink" href="#Test::Wrapper">Test::Wrapper</a></dt>
  <dd>This module directly uses hash keys in the Test::Builder singleton. This
      module is also obsolete thanks to the benefits of Test2. Use
      <span class="Li">&quot;intercept()&quot;</span> from Test2::API to achieve
      a similar result.
    <p class="Pp">Still broken as of version: 0.3.0</p>
  </dd>
  <dt id="Test::ParallelSubtest"><a class="permalink" href="#Test::ParallelSubtest">Test::ParallelSubtest</a></dt>
  <dd>This module overrides
      <span class="Li">&quot;Test::Builder::subtest()&quot;</span> and
      <span class="Li">&quot;Test::Builder::done_testing()&quot;</span>. It also
      directly accesses hash elements of the singleton. It has not yet been
      fixed.
    <p class="Pp">Alternatives: Test2::AsyncSubtest and Test2::Workflow (not
        stable).</p>
    <p class="Pp">Still broken as of version: 0.05</p>
  </dd>
  <dt id="Test::Pretty"><a class="permalink" href="#Test::Pretty">Test::Pretty</a></dt>
  <dd>See https://github.com/tokuhirom/Test-Pretty/issues/25
    <p class="Pp">The author admits the module is crazy, and he is awaiting a
        stable release of something new (Test2) to completely rewrite it in a
        sane way.</p>
    <p class="Pp">Still broken as of version: 0.32</p>
  </dd>
  <dt id="Net::BitTorrent"><a class="permalink" href="#Net::BitTorrent">Net::BitTorrent</a></dt>
  <dd>The tests for this module directly access Test::Builder hash keys. Most,
      if not all of these hash keys have public API methods that could be used
      instead to avoid the problem.
    <p class="Pp">Still broken in version: 0.052</p>
  </dd>
  <dt id="Test::Group"><a class="permalink" href="#Test::Group">Test::Group</a></dt>
  <dd>It monkeypatches Test::Builder, and calls it &quot;black magic&quot; in
      the code.
    <p class="Pp">Still broken as of version: 0.20</p>
  </dd>
  <dt id="Test::Flatten"><a class="permalink" href="#Test::Flatten">Test::Flatten</a></dt>
  <dd>This modifies the Test::Builder internals in many ways. A better was to
      accomplish the goal of this module is to write your own subtest function.
    <p class="Pp">Still broken as of version: 0.11</p>
  </dd>
  <dt id="Log::Dispatch::Config::TestLog"><a class="permalink" href="#Log::Dispatch::Config::TestLog">Log::Dispatch::Config::TestLog</a></dt>
  <dd>Modifies Test::Builder internals.
    <p class="Pp">Still broken as of version: 0.02</p>
  </dd>
  <dt id="Test::Able"><a class="permalink" href="#Test::Able">Test::Able</a></dt>
  <dd>Modifies Test::Builder internals.
    <p class="Pp">Still broken as of version: 0.11</p>
  </dd>
</dl>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="MAKE_ASSERTIONS_"><a class="permalink" href="#MAKE_ASSERTIONS_">MAKE
  ASSERTIONS -&gt; SEND EVENTS</a></h1>
<section class="Ss">
<h2 class="Ss">LEGACY</h2>
<pre>
    use Test::Builder;

    # A majority of tools out there do this:
    # my $TB = Test::Builder-&gt;new;
    # This works, but has always been wrong, forcing Test::Builder to implement
    # subtests as a horrific hack. It also causes problems for tools that try
    # to replace the singleton (also discouraged).

    sub my_ok($;$) {
        my ($bool, $name) = @_;
        my $TB = Test::Builder-&gt;new;
        $TB-&gt;ok($bool, $name);
    }

    sub my_diag($) {
        my ($msg) = @_;
        my $TB = Test::Builder-&gt;new;
        $TB-&gt;diag($msg);
    }
</pre>
</section>
<section class="Ss">
<h2 class="Ss">TEST2</h2>
<pre>
    use Test2::API qw/context/;

    sub my_ok($;$) {
        my ($bool, $name) = @_;
        my $ctx = context();
        $ctx-&gt;ok($bool, $name);
        $ctx-&gt;release;
    }

    sub my_diag($) {
        my ($msg) = @_;
        my $ctx = context();
        $ctx-&gt;diag($msg);
        $ctx-&gt;release;
    }
</pre>
<p class="Pp">The context object has API compatible implementations of the
    following methods:</p>
<dl class="Bl-tag">
  <dt id="ok($bool,"><a class="permalink" href="#ok($bool,">ok($bool,
    $name)</a></dt>
  <dd></dd>
  <dt id="diag(@messages)"><a class="permalink" href="#diag(@messages)">diag(@messages)</a></dt>
  <dd></dd>
  <dt id="note(@messages)"><a class="permalink" href="#note(@messages)">note(@messages)</a></dt>
  <dd></dd>
  <dt id="subtest($name,"><a class="permalink" href="#subtest($name,">subtest($name,
    $code)</a></dt>
  <dd></dd>
</dl>
<p class="Pp">If you are looking for helpers with
    <span class="Li">&quot;is&quot;</span>,
    <span class="Li">&quot;like&quot;</span>, and others, see Test2::Suite.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="WRAP_EXISTING_TOOLS"><a class="permalink" href="#WRAP_EXISTING_TOOLS">WRAP
  EXISTING TOOLS</a></h1>
<section class="Ss">
<h2 class="Ss">LEGACY</h2>
<pre>
    use Test::More;

    sub exclusive_ok {
        my ($bool1, $bool2, $name) = @_;

        # Ensure errors are reported 1 level higher
        local $Test::Builder::Level = $Test::Builder::Level + 1;

        $ok = $bool1 || $bool2;
        $ok &amp;&amp;= !($bool1 &amp;&amp; $bool2);
        ok($ok, $name);

        return $bool;
    }
</pre>
<p class="Pp">Every single tool in the chain from this, to
    <span class="Li">&quot;ok&quot;</span>, to anything
    <span class="Li">&quot;ok&quot;</span> calls needs to increment the
    <span class="Li">$Level</span> variable. When an error occurs Test::Builder
    will do a trace to the stack frame determined by
    <span class="Li">$Level</span>, and report that file+line as the one where
    the error occurred. If you or any other tool you use forgets to set
    <span class="Li">$Level</span> then errors will be reported to the wrong
    place.</p>
</section>
<section class="Ss">
<h2 class="Ss">TEST2</h2>
<pre>
    use Test::More;

    sub exclusive_ok {
        my ($bool1, $bool2, $name) = @_;

        # Grab and store the context, even if you do not need to use it
        # directly.
        my $ctx = context();

        $ok = $bool1 || $bool2;
        $ok &amp;&amp;= !($bool1 &amp;&amp; $bool2);
        ok($ok, $name);

        $ctx-&gt;release;
        return $bool;
    }
</pre>
<p class="Pp">Instead of using <span class="Li">$Level</span> to perform a
    backtrace, Test2 uses a context object. In this sample you create a context
    object and store it. This locks the context (errors report 1 level up from
    here) for all wrapped tools to find. You do not need to use the context
    object, but you do need to store it in a variable. Once the sub ends the
    <span class="Li">$ctx</span> variable is destroyed which lets future tools
    find their own.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="USING_UTF8"><a class="permalink" href="#USING_UTF8">USING
  UTF8</a></h1>
<section class="Ss">
<h2 class="Ss">LEGACY</h2>
<pre>
    # Set the mode BEFORE anything loads Test::Builder
    use open ':std', ':encoding(utf8)';
    use Test::More;
</pre>
<p class="Pp">Or</p>
<p class="Pp"></p>
<pre>
    # Modify the filehandles
    my $builder = Test::More-&gt;builder;
    binmode $builder-&gt;output,         &quot;:encoding(utf8)&quot;;
    binmode $builder-&gt;failure_output, &quot;:encoding(utf8)&quot;;
    binmode $builder-&gt;todo_output,    &quot;:encoding(utf8)&quot;;
</pre>
</section>
<section class="Ss">
<h2 class="Ss">TEST2</h2>
<pre>
    use Test2::API qw/test2_stack/;

    test2_stack-&gt;top-&gt;format-&gt;encoding('utf8');
</pre>
<p class="Pp">Though a much better way is to use the Test2::Plugin::UTF8 plugin,
    which is part of Test2::Suite.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="AUTHORS,_CONTRIBUTORS_AND_REVIEWERS"><a class="permalink" href="#AUTHORS,_CONTRIBUTORS_AND_REVIEWERS">AUTHORS,
  CONTRIBUTORS AND REVIEWERS</a></h1>
<p class="Pp">The following people have all contributed to this document in some
    way, even if only for review.</p>
<dl class="Bl-tag">
  <dt id="Chad"><a class="permalink" href="#Chad">Chad Granum (EXODIST)
    &lt;exodist@cpan.org&gt;</a></dt>
  <dd></dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="SOURCE"><a class="permalink" href="#SOURCE">SOURCE</a></h1>
<p class="Pp">The source code repository for Test2 can be found at
    <i>http://github.com/Test-More/test-more/</i>.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="MAINTAINER"><a class="permalink" href="#MAINTAINER">MAINTAINER</a></h1>
<dl class="Bl-tag">
  <dt id="Chad~2"><a class="permalink" href="#Chad~2">Chad Granum
    &lt;exodist@cpan.org&gt;</a></dt>
  <dd></dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="COPYRIGHT"><a class="permalink" href="#COPYRIGHT">COPYRIGHT</a></h1>
<p class="Pp">Copyright 2020 Chad Granum &lt;exodist@cpan.org&gt;.</p>
<p class="Pp">This program is free software; you can redistribute it and/or
    modify it under the same terms as Perl itself.</p>
<p class="Pp">See <i>http://www.perl.com/perl/misc/Artistic.html</i></p>
</section>
</div>
<table class="foot">
  <tr>
    <td class="foot-date">2020-10-22</td>
    <td class="foot-os">perl v5.30.2</td>
  </tr>
</table>
</body>
</html>
