<!DOCTYPE html>
<html>
<!-- This is an automatically generated file.  Do not edit.
   Automatically generated by Pod::Man 4.14 (Pod::Simple 3.42)
  
   Standard preamble:
   ========================================================================
   Vertical space (when we can't use .PP)
 -->
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="../style.css" type="text/css" media="all"/>
  <title>Test2::Manual::Tooling::Nesting(3)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">Test2::Manual::Tooling::Nesting(3)</td>
    <td class="head-vol">User Contributed Perl Documentation</td>
    <td class="head-rtitle">Test2::Manual::Tooling::Nesting(3)</td>
  </tr>
</table>
<div class="manual-text">
<br/>
<section class="Sh">
<h1 class="Sh" id="NAME"><a class="permalink" href="#NAME">NAME</a></h1>
<p class="Pp">Test2::Manual::Tooling::Nesting - Tutorial for using other tools
    within your own.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">DESCRIPTION</a></h1>
<p class="Pp">Sometimes you find yourself writing the same test pattern over and
    over, in such cases you may want to encapsulate the logic in a new test
    function that calls several tools together. This sounds easy enough, but can
    cause headaches if not done correctly.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="NAIVE_WAY"><a class="permalink" href="#NAIVE_WAY">NAIVE
  WAY</a></h1>
<p class="Pp">Lets say you find yourself writing the same test pattern over and
    over for multiple objects:</p>
<p class="Pp"></p>
<pre>    my $obj1 = $class1-&gt;new;
    is($obj1-&gt;foo, 'foo', &quot;got foo&quot;);
    is($obj1-&gt;bar, 'bar', &quot;got bar&quot;);
    my $obj2 = $class1-&gt;new;
    is($obj2-&gt;foo, 'foo', &quot;got foo&quot;);
    is($obj2-&gt;bar, 'bar', &quot;got bar&quot;);
    ... 10x more times for classes 2-12
</pre>
<p class="Pp">The naive way to do this is to write a
    <span class="Li">&quot;check_class()&quot;</span> function like this:</p>
<p class="Pp"></p>
<pre>    sub check_class {
        my $class = shift;
        my $obj = $class-&gt;new;
        is($obj-&gt;foo, 'foo', &quot;got foo&quot;);
        is($obj-&gt;bar, 'bar', &quot;got bar&quot;);
    }
    check_class($class1);
    check_class($class2);
    check_class($class3);
    ...
</pre>
<p class="Pp">This will appear to work fine, and you might not notice any
    problems, <i>so long as the tests are passing.</i></p>
<section class="Ss">
<h2 class="Ss">WHATS WRONG WITH IT?</h2>
<p class="Pp">The problems with the naive approach become obvious if things
    start to fail. The diagnostics that tell you what file and line the failure
    occurred on will be wrong. The failure will be reported to the line
    <i>inside</i> <span class="Li">&quot;check_class&quot;</span>, not to the
    line where <span class="Li">&quot;check_class()&quot;</span> was called.
    This is problem because it leaves you with no idea which class is
  failing.</p>
</section>
<section class="Ss">
<h2 class="Ss">HOW TO FIX IT</h2>
<p class="Pp">Luckily this is extremely easy to fix. You need to acquire a
    context object at the start of your function, and release it at the end...
    yes it is that simple.</p>
<p class="Pp"></p>
<pre>    use Test2::API qw/context/;
    sub check_class {
        my $class = shift;
        my $ctx = context();
        my $obj = $class-&gt;new;
        is($obj-&gt;foo, 'foo', &quot;got foo&quot;);
        is($obj-&gt;bar, 'bar', &quot;got bar&quot;);
        $ctx-&gt;release;
    }
</pre>
<p class="Pp">See, that was easy. With these 2 additional lines we know have
    proper file+line reporting. The nested tools will find the context we
    acquired here, and know to use it's file and line numbers.</p>
<p class="Pp"><i>THE OLD WAY (DO NOT DO THIS ANYMORE)</i></p>
<p class="Pp">With Test::Builder there was a global variables called
    <span class="Li">$Test::Builder::Level</span> which helped solve this
    problem:</p>
<p class="Pp"></p>
<pre>    sub check_class {
        my $class = shift;
        local $Test::Builder::Level = $Test::Builder::Level + 1;
        my $obj = $class-&gt;new;
        is($obj-&gt;foo, 'foo', &quot;got foo&quot;);
        is($obj-&gt;bar, 'bar', &quot;got bar&quot;);
    }
</pre>
<p class="Pp">This variable worked well enough (and will still work) but was not
    very discoverable. Another problem with this variable is that it becomes
    cumbersome if you have a more deeply nested code structure called the nested
    tools, you might need to count stack frames, and hope they never change due
    to a third party module. The context solution has no such caveats.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="SEE_ALSO"><a class="permalink" href="#SEE_ALSO">SEE
  ALSO</a></h1>
<p class="Pp">Test2::Manual - Primary index of the manual.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="SOURCE"><a class="permalink" href="#SOURCE">SOURCE</a></h1>
<p class="Pp">The source code repository for Test2-Manual can be found at
    <i>https://github.com/Test-More/Test2-Suite/</i>.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="MAINTAINERS"><a class="permalink" href="#MAINTAINERS">MAINTAINERS</a></h1>
<dl class="Bl-tag">
  <dt id="Chad"><a class="permalink" href="#Chad">Chad Granum
    &lt;exodist@cpan.org&gt;</a></dt>
  <dd></dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="AUTHORS"><a class="permalink" href="#AUTHORS">AUTHORS</a></h1>
<dl class="Bl-tag">
  <dt id="Chad~2"><a class="permalink" href="#Chad~2">Chad Granum
    &lt;exodist@cpan.org&gt;</a></dt>
  <dd></dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="COPYRIGHT"><a class="permalink" href="#COPYRIGHT">COPYRIGHT</a></h1>
<p class="Pp">Copyright 2018 Chad Granum &lt;exodist@cpan.org&gt;.</p>
<p class="Pp">This program is free software; you can redistribute it and/or
    modify it under the same terms as Perl itself.</p>
<p class="Pp">See <i>http://dev.perl.org/licenses/</i></p>
</section>
</div>
<table class="foot">
  <tr>
    <td class="foot-date">2020-10-22</td>
    <td class="foot-os">perl v5.34.0</td>
  </tr>
</table>
</body>
</html>
