<!DOCTYPE html>
<html>
<!-- This is an automatically generated file.  Do not edit.
   Automatically generated by Pod::Man 4.11 (Pod::Simple 3.35)
  
   Standard preamble:
   ========================================================================
   Vertical space (when we can't use .PP)
 -->
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="../style.css" type="text/css" media="all"/>
  <title>Mail::DKIM::Verifier(3)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">Mail::DKIM::Verifier(3)</td>
    <td class="head-vol">User Contributed Perl Documentation</td>
    <td class="head-rtitle">Mail::DKIM::Verifier(3)</td>
  </tr>
</table>
<div class="manual-text">
<br/>
<section class="Sh">
<h1 class="Sh" id="NAME"><a class="permalink" href="#NAME">NAME</a></h1>
<p class="Pp">Mail::DKIM::Verifier - verifies a DKIM-signed message</p>
</section>
<section class="Sh">
<h1 class="Sh" id="SYNOPSIS"><a class="permalink" href="#SYNOPSIS">SYNOPSIS</a></h1>
<pre>  use Mail::DKIM::Verifier;
  # create a verifier object
  my $dkim = Mail::DKIM::Verifier-&gt;new();
  # read an email from a file handle
  $dkim-&gt;load(*STDIN);
  # or read an email and pass it into the verifier, incrementally
  while (&lt;STDIN&gt;)
  {
      # remove local line terminators
      chomp;
      s/\015$//;
      # use SMTP line terminators
      $dkim-&gt;PRINT(&quot;$_\015\012&quot;);
  }
  $dkim-&gt;CLOSE;
  # what is the result of the verify?
  my $result = $dkim-&gt;result;
  # there might be multiple signatures, what is the result per signature?
  foreach my $signature ($dkim-&gt;signatures)
  {
      print 'signature identity: ' . $signature-&gt;identity . &quot;\n&quot;;
      print 'verify result: ' . $signature-&gt;result_detail . &quot;\n&quot;;
  }
  # the alleged author of the email may specify how to handle email
  foreach my $policy ($dkim-&gt;policies)
  {
      die 'fraudulent message' if ($policy-&gt;apply($dkim) eq 'reject');
  }
</pre>
</section>
<section class="Sh">
<h1 class="Sh" id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">DESCRIPTION</a></h1>
<p class="Pp">The verifier object allows an email message to be scanned for DKIM
    and DomainKeys signatures and those signatures to be verified. The verifier
    tracks the state of the message as it is read into memory. When the message
    has been completely read, the signatures are verified and the results of the
    verification can be accessed.</p>
<p class="Pp">To use the verifier, first create the verifier object. Then start
    &quot;feeding&quot; it the email message to be verified. When all the
    _headers_ have been read, the verifier:</p>
<p class="Pp"></p>
<pre> 1. checks whether any DomainKeys/DKIM signatures were found
 2. queries for the public keys needed to verify the signatures
 3. sets up the appropriate algorithms and canonicalization objects
 4. canonicalizes the headers and computes the header hash
</pre>
<p class="Pp">Then, when the _body_ of the message has been completely fed into
    the verifier, the body hash is computed and the signatures are verified.</p>
<p class="Pp">The results of the verification can be checked with
    &quot;<b>result()</b>&quot; or &quot;<b>signatures()</b>&quot;.</p>
<p class="Pp">Messages that do not verify may be checked against the alleged
    sender's published signing policy with &quot;<b>policies()</b>&quot; and
    &quot;<b>apply()</b>&quot; in Mail::DKIM::Policy.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="CONSTRUCTOR"><a class="permalink" href="#CONSTRUCTOR">CONSTRUCTOR</a></h1>
<section class="Ss">
<h2 class="Ss"><b>new()</b></h2>
<p class="Pp">Constructs an object-oriented verifier.</p>
<p class="Pp"></p>
<pre>  my $dkim = Mail::DKIM::Verifier-&gt;new();
  my $dkim = Mail::DKIM::Verifier-&gt;new(%options);
</pre>
<p class="Pp">The only options supported at this time are:</p>
<dl class="Bl-tag">
  <dt id="Debug_Canonicalization"><a class="permalink" href="#Debug_Canonicalization">Debug_Canonicalization</a></dt>
  <dd>if specified, the canonicalized message for the first signature is written
      to the referenced string or file handle.</dd>
  <dt id="Strict"><a class="permalink" href="#Strict">Strict</a></dt>
  <dd>If true, rejects sha1 hashes and signing keys shorter than 1024 bits.</dd>
</dl>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="METHODS"><a class="permalink" href="#METHODS">METHODS</a></h1>
<section class="Ss">
<h2 class="Ss"><b>PRINT()</b></h2>
<p class="Pp">Feeds part of the message to the verifier.</p>
<p class="Pp"></p>
<pre>  $dkim-&gt;PRINT(&quot;a line of the message\015\012&quot;);
  $dkim-&gt;PRINT('more of');
  $dkim-&gt;PRINT(&quot; the message\015\012bye\015\012&quot;);
</pre>
<p class="Pp">Feeds content of the message being verified into the verifier. The
    API is designed this way so that the entire message does NOT need to be read
    into memory at once.</p>
<p class="Pp">Please note that although the <b>PRINT()</b> method expects you to
    use SMTP-style line termination characters, you should NOT use the
    SMTP-style dot-stuffing technique described in RFC 2821 section 4.5.2. Nor
    should you use a &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt; sequence to
    terminate the message.</p>
</section>
<section class="Ss">
<h2 class="Ss"><b>CLOSE()</b></h2>
<p class="Pp">Call this when finished feeding in the message.</p>
<p class="Pp"></p>
<pre>  $dkim-&gt;CLOSE;
</pre>
<p class="Pp">This method finishes the canonicalization process, computes a
    hash, and verifies the signature.</p>
</section>
<section class="Ss">
<h2 class="Ss"><b>fetch_author_domain_policies()</b></h2>
<p class="Pp">Retrieves ADSP records from DNS.</p>
<p class="Pp"></p>
<pre>  my @policies = $dkim-&gt;fetch_author_domain_policies;
  foreach my $policy (@policies)
  {
      my $policy_result = $policy-&gt;apply($dkim);
  }
</pre>
<p class="Pp">This method will retrieve all applicable
    &quot;author-domain-signing-practices&quot; published in DNS for this
    message. Author policies are keyed to the email address(es) in the From:
    header, i.e. the claimed author of the message.</p>
<p class="Pp">This method returns a *list* of policy records, since there is
    allowed to be zero or multiple email addresses in the From: header.</p>
<p class="Pp">The result of the <b>apply()</b> method is one of:
    &quot;accept&quot;, &quot;reject&quot;, &quot;neutral&quot;.</p>
<p class="Pp">See also: &quot;<b>policies()</b>&quot;.</p>
</section>
<section class="Ss">
<h2 class="Ss"><b>fetch_author_policy()</b></h2>
<p class="Pp">Retrieves a signing policy from DNS.</p>
<p class="Pp"></p>
<pre>  my $policy = $dkim-&gt;fetch_author_policy;
  my $policy_result = $policy-&gt;apply($dkim);
</pre>
<p class="Pp">This method retrieves the DKIM Sender Signing Practices record as
    described in Internet Draft draft-ietf-dkim-ssp-00-01dc. This Internet Draft
    is now obsolete; this method is only kept for backward-compatibility
    purposes.</p>
<p class="Pp">Please use the &quot;<b>policies()</b>&quot; method instead.</p>
</section>
<section class="Ss">
<h2 class="Ss"><b>fetch_sender_policy()</b></h2>
<p class="Pp">Retrieves a signing policy from DNS.</p>
<p class="Pp"></p>
<pre>  my $policy = $dkim-&gt;fetch_sender_policy;
  my $policy_result = $policy-&gt;apply($dkim);
</pre>
<p class="Pp">The &quot;sender&quot; policy is the sender signing policy as
    described by the DomainKeys specification, now available in
    RFC4870(historical). I call it the &quot;sender&quot; policy because it is
    keyed to the email address in the Sender: header, or the From: header if
    there is no Sender header. This is the person whom the message claims as the
    &quot;transmitter&quot; of the message (not necessarily the author).</p>
<p class="Pp">If the email being verified has no From or Sender header from
    which to get an email address (which violates email standards), then this
    method will <span class="Li">&quot;die&quot;</span>.</p>
<p class="Pp">The result of the <b>apply()</b> method is one of:
    &quot;accept&quot;, &quot;reject&quot;, &quot;neutral&quot;.</p>
<p class="Pp">See also: &quot;<b>policies()</b>&quot;.</p>
</section>
<section class="Ss">
<h2 class="Ss"><b>load()</b></h2>
<p class="Pp">Load the entire message from a file handle.</p>
<p class="Pp"></p>
<pre>  $dkim-&gt;load($file_handle);
</pre>
<p class="Pp">Reads a complete message from the designated file handle, feeding
    it into the verifier. The message must use &lt;CRLF&gt; line terminators
    (same as the SMTP protocol).</p>
</section>
<section class="Ss">
<h2 class="Ss"><b>message_originator()</b></h2>
<p class="Pp">Access the &quot;From&quot; header.</p>
<p class="Pp"></p>
<pre>  my $address = $dkim-&gt;message_originator;
</pre>
<p class="Pp">Returns the &quot;originator address&quot; found in the message,
    as a Mail::Address object. This is typically the (first) name and email
    address found in the From: header. If there is no From: header, then an
    empty Mail::Address object is returned.</p>
<p class="Pp">To get just the email address part, do:</p>
<p class="Pp"></p>
<pre>  my $email = $dkim-&gt;message_originator-&gt;address;
</pre>
<p class="Pp">See also &quot;<b>message_sender()</b>&quot;.</p>
</section>
<section class="Ss">
<h2 class="Ss"><b>message_sender()</b></h2>
<p class="Pp">Access the &quot;From&quot; or &quot;Sender&quot; header.</p>
<p class="Pp"></p>
<pre>  my $address = $dkim-&gt;message_sender;
</pre>
<p class="Pp">Returns the &quot;sender&quot; found in the message, as a
    Mail::Address object. This is typically the (first) name and email address
    found in the Sender: header. If there is no Sender: header, it is the first
    name and email address in the From: header. If neither header is present,
    then an empty Mail::Address object is returned.</p>
<p class="Pp">To get just the email address part, do:</p>
<p class="Pp"></p>
<pre>  my $email = $dkim-&gt;message_sender-&gt;address;
</pre>
<p class="Pp">The &quot;sender&quot; is the mailbox of the agent responsible for
    the actual transmission of the message. For example, if a secretary were to
    send a message for another person, the &quot;sender&quot; would be the
    secretary and the &quot;originator&quot; would be the actual author.</p>
</section>
<section class="Ss">
<h2 class="Ss"><b>policies()</b></h2>
<p class="Pp">Retrieves applicable signing policies from DNS.</p>
<p class="Pp"></p>
<pre>  my @policies = $dkim-&gt;policies;
  foreach my $policy (@policies)
  {
      $policy_result = $policy-&gt;apply($dkim);
      # $policy_result is one of &quot;accept&quot;, &quot;reject&quot;, &quot;neutral&quot;
  }
</pre>
<p class="Pp">This method searches for and returns any signing policies that
    would apply to this message. Signing policies are selected based on the
    domain that the message *claims* to be from. So, for example, if a message
    claims to be from security@bank, and forwarded by trusted@listserv, when in
    reality the message came from foe@evilcorp, this method would check for
    signing policies for security@bank and trusted@listserv. The signing
    policies might tell whether foe@evilcorp (the real sender) is allowed to
    send mail claiming to be from your bank or your listserv.</p>
<p class="Pp">I say &quot;might tell&quot;, because in reality this is still
    really hard to specify with any accuracy. In addition, most senders do not
    publish useful policies.</p>
</section>
<section class="Ss">
<h2 class="Ss"><b>result()</b></h2>
<p class="Pp">Access the result of the verification.</p>
<p class="Pp"></p>
<pre>  my $result = $dkim-&gt;result;
</pre>
<p class="Pp">Gives the result of the verification. The following values are
    possible:</p>
<dl class="Bl-tag">
  <dt id="pass"><a class="permalink" href="#pass">pass</a></dt>
  <dd>Returned if a valid DKIM-Signature header was found, and the signature
      contains a correct value for the message.</dd>
  <dt id="fail"><a class="permalink" href="#fail">fail</a></dt>
  <dd>Returned if a valid DKIM-Signature header was found, but the signature
      does not contain a correct value for the message.</dd>
  <dt id="invalid"><a class="permalink" href="#invalid">invalid</a></dt>
  <dd>Returned if a DKIM-Signature could not be checked because of a problem in
      the signature itself or the public key record. I.e. the signature could
      not be processed.</dd>
  <dt id="temperror"><a class="permalink" href="#temperror">temperror</a></dt>
  <dd>Returned if a DKIM-Signature could not be checked due to some error which
      is likely transient in nature, such as a temporary inability to retrieve a
      public key. A later attempt may produce a better result.</dd>
  <dt id="none"><a class="permalink" href="#none">none</a></dt>
  <dd>Returned if no DKIM-Signature headers (valid or invalid) were found.</dd>
</dl>
<p class="Pp">In case of multiple signatures, the &quot;best&quot; result will
    be returned. Best is defined as &quot;pass&quot;, followed by
    &quot;fail&quot;, &quot;invalid&quot;, and &quot;none&quot;. To examine the
    results of individual signatures, use the &quot;<b>signatures()</b>&quot;
    method to retrieve the signature objects. See &quot;<b>result()</b>&quot; in
    Mail::DKIM::Signature.</p>
</section>
<section class="Ss">
<h2 class="Ss"><b>result_detail()</b></h2>
<p class="Pp">Access the result, plus details if available.</p>
<p class="Pp"></p>
<pre>  my $detail = $dkim-&gt;result_detail;
</pre>
<p class="Pp">The detail is constructed by taking the result (e.g.
    &quot;pass&quot;, &quot;fail&quot;, &quot;invalid&quot; or &quot;none&quot;)
    and appending any details provided by the verification process in
    parenthesis.</p>
<p class="Pp">The following are possible results from the <b>result_detail()</b>
    method:</p>
<p class="Pp"></p>
<pre>  pass
  fail (bad RSA signature)
  fail (OpenSSL error: ...)
  fail (message has been altered)
  fail (body has been altered)
  invalid (bad identity)
  invalid (invalid domain in d tag)
  invalid (missing q tag)
  invalid (missing d tag)
  invalid (missing s tag)
  invalid (unsupported version 0.1)
  invalid (unsupported algorithm ...)
  invalid (unsupported canonicalization ...)
  invalid (unsupported query protocol ...)
  invalid (signature is expired)
  invalid (public key: not available)
  invalid (public key: unknown query type ...)
  invalid (public key: syntax error)
  invalid (public key: unsupported version)
  invalid (public key: unsupported key type)
  invalid (public key: missing p= tag)
  invalid (public key: invalid data)
  invalid (public key: does not support email)
  invalid (public key: does not support hash algorithm 'sha1')
  invalid (public key: does not support signing subdomains)
  invalid (public key: revoked)
  invalid (public key: granularity mismatch)
  invalid (public key: granularity is empty)
  invalid (public key: OpenSSL error: ...)
  none
</pre>
</section>
<section class="Ss">
<h2 class="Ss"><b>signature()</b></h2>
<p class="Pp">Access the message's DKIM signature.</p>
<p class="Pp"></p>
<pre>  my $sig = $dkim-&gt;signature;
</pre>
<p class="Pp">Accesses the signature found and verified in this message. The
    returned object is of type Mail::DKIM::Signature.</p>
<p class="Pp">In case of multiple signatures, the signature with the
    &quot;best&quot; result will be returned. Best is defined as
    &quot;pass&quot;, followed by &quot;fail&quot;, &quot;invalid&quot;, and
    &quot;none&quot;.</p>
</section>
<section class="Ss">
<h2 class="Ss"><b>signatures()</b></h2>
<p class="Pp">Access all of this message's signatures.</p>
<p class="Pp"></p>
<pre>  my @all_signatures = $dkim-&gt;signatures;
</pre>
<p class="Pp">Use <span class="Li">$signature</span>-&gt;result or
    <span class="Li">$signature</span>-&gt;result_detail to access the
    verification results of each signature.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="AUTHOR"><a class="permalink" href="#AUTHOR">AUTHOR</a></h1>
<p class="Pp">Jason Long, &lt;jlong@messiah.edu&gt;</p>
</section>
<section class="Sh">
<h1 class="Sh" id="COPYRIGHT_AND_LICENSE"><a class="permalink" href="#COPYRIGHT_AND_LICENSE">COPYRIGHT
  AND LICENSE</a></h1>
<p class="Pp">Copyright (C) 2006-2009 by Messiah College</p>
<p class="Pp">This library is free software; you can redistribute it and/or
    modify it under the same terms as Perl itself, either Perl version 5.8.6 or,
    at your option, any later version of Perl 5 you may have available.</p>
</section>
</div>
<table class="foot">
  <tr>
    <td class="foot-date">2019-11-13</td>
    <td class="foot-os">perl v5.30.3</td>
  </tr>
</table>
</body>
</html>
